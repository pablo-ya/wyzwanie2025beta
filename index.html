<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#005dac">
    <meta name="description" content="Wyzwanie 2025 - Śledź swój postęp w sportowym wyzwaniu i rywalizuj z innymi uczestnikami!">
    <title>Wyzwanie 2025</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="#manifest-placeholder">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAL6UExURUdwTABetwBfuABdtgBetgBeuABetgBdtwBdtwBeuABetgBetgBetgBdtwBdtgBetgBeuABetgBetgBdtv///wBeuABdtgBetgBetgBetgBetgBetgBetgBdtv///wBetgBdtwBdtgBetgBetgBdtv///wBetgBdtgBetgBdtwBetgBdtgBetgBetgBdtv///wBdtwBdtwBdtwBetgBdtgBdtgBdtwBdtwBdtwBdtwBdtwBdtwBdtwBdtwBdtgBdtwBdtwBetgBdtgBdtwBetgBdtwBdtgBetgBdtwBdtwBdtgBdtwBdtgBetgBetgBetgBdtgBdtgBetgBdtwBetgBetgBetgBetgBetf///wBdtwBetgBdtgBetgBetgBdtgBetgBetgBdtwBdtwBdtgBdtwBdtwBetwBeuABdtgBdtwBdtwBetgBetf///wBdtwBdtwBdtvr7/ABdtgBdtv///wBdtgBdtwBetgBetgBdtf///wBdtgBetgBetgBdtgBetgBetv///wBetgBetv///wBetgBdtgBdtgBdtgBdtgBetgBetgBdtgBdtgBdtgBdtwBetgBdtgBdtgBetgBdtgBdtgBetgBetgBdtgBdtv///wBdtwBdtgBdtgBetgBetgBdtgBdtgBdtwBetgBdtwBdtgBdtgBetgBdtgBdtgBetgBdtgBetgBdtgBetgBdtgBetgBdtgBdtgBetgBdtgBetgBdtwBdtgBdtwBetgBdtgBetgBetgBdtgBetgBdtgBdtgBdtgBetgBetgBetgBetgBdtgBdtgBetgBdtgBetgBdtgBdtgBdtgBetgBdtgBdtgBetgBdtgBetgBdtgBetgBdtwBetgBdtgBdtgBdtwBdtgBetgBdtwBetgBdtgBetgBetgBetgBetgBetgBdtgBdtgBdtgBdtgBetgBdtgBdtgBetgBetgBetgBetgBdtgBdtgBdtgBetgBdtgBetgBdtgBetgBdtgBetgBdtgBdtgBetgBetgBdtgBetgBdtgBetgBdtgBetgBetgBdtgBdtgBetgBdtvxTTSIAAAA/dFJO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">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wyzwanie 2025">
    
    <!-- Firebase -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        :root {
            --primary-color: #005dac;
            --action-color: #1cb954;
            --text-color: #343434;
            --light-gray: #f5f5f5;
            --mid-gray: #e0e0e0;
            --dark-gray: #999999;
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family);
            color: var(--text-color);
            background-color: var(--light-gray);
            line-height: 1.6;
            padding-bottom: 70px;
            padding-top: 60px;
            min-height: 100vh;
        }
        
        /* Header */
        header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 1.5rem;
            font-weight: 500;
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .admin-link {
            color: var(--white);
            opacity: 0.8;
            font-size: 0.9rem;
            text-decoration: none;
        }
        
        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        section {
            margin-bottom: 30px;
        }
        
        /* Rules Section */
        .rules-section {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .rules-header h2 {
            font-size: 1.3rem;
            margin: 0;
        }
        
        .countdown {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .rules-content {
            margin-bottom: 20px;
        }
        
        .rules-content p {
            margin-bottom: 10px;
        }
        
        .join-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--action-color);
            color: var(--white);
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 0 auto;
            width: fit-content;
        }
        
        .join-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .join-btn i {
            margin-right: 8px;
        }
        
        .joined-btn {
            background-color: var(--dark-gray);
            cursor: default;
        }
        
        .joined-btn:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Progress Chart */
        .chart-section {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Participants Section */
        .participants-section {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .participants-header {
            margin-bottom: 15px;
        }
        
        .participants-header h2 {
            font-size: 1.3rem;
            margin: 0;
        }
        
        .participants-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .participant-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--mid-gray);
        }
        
        .participant-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .participant-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .participant-rank {
            background-color: var(--primary-color);
            color: var(--white);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .rank-1 {
            background-color: gold;
            color: #333;
        }
        
        .rank-2 {
            background-color: silver;
            color: #333;
        }
        
        .rank-3 {
            background-color: #cd7f32;
            color: white;
        }
        
        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            background-color: var(--mid-gray);
            flex-shrink: 0;
        }
        
        .participant-info {
            flex-grow: 1;
        }
        
        .participant-name {
            font-weight: 500;
            margin: 0;
            line-height: 1.2;
        }
        
        .participant-role {
            display: inline-block;
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            margin-top: 3px;
            background-color: var(--mid-gray);
        }
        
        .role-runner {
            background-color: #ff7043;
            color: white;
        }
        
        .role-cyclist {
            background-color: #42a5f5;
            color: white;
        }
        
        .role-both {
            background-color: #9575cd;
            color: white;
        }
        
        .participant-stats {
            margin-top: 10px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .stats-label {
            color: var(--dark-gray);
        }
        
        .stats-value {
            font-weight: 500;
        }
        
        .progress-bar-container {
            height: 6px;
            background-color: var(--mid-gray);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .progress-runner {
            background-color: #ff7043;
        }
        
        .progress-cyclist {
            background-color: #42a5f5;
        }
        
        .progress-both {
            background-color: #9575cd;
        }
        
        /* Activities Section */
        .activities-section {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .activities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .activities-header h2 {
            font-size: 1.3rem;
            margin: 0;
        }
        
        .activities-list {
            border-top: 1px solid var(--mid-gray);
        }
        
        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--mid-gray);
            display: flex;
            align-items: center;
        }
        
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .activity-run {
            background-color: #ff7043;
            color: white;
        }
        
        .activity-cycle {
            background-color: #42a5f5;
            color: white;
        }
        
        .activity-details {
            flex-grow: 1;
        }
        
        .activity-title {
            font-weight: 500;
            margin: 0;
            line-height: 1.3;
        }
        
        .activity-meta {
            display: flex;
            font-size: 0.85rem;
            color: var(--dark-gray);
            margin-top: 3px;
        }
        
        .activity-meta > div {
            margin-right: 15px;
        }
        
        .activity-stats {
            display: flex;
            margin-left: auto;
            flex-shrink: 0;
            text-align: right;
        }
        
        .activity-distance, .activity-pace {
            margin-left: 15px;
            font-size: 0.9rem;
        }
        
        .activity-value {
            font-weight: 500;
            color: var(--text-color);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .pagination-btn {
            background-color: var(--white);
            border: 1px solid var(--mid-gray);
            border-radius: var(--border-radius);
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .pagination-btn:hover {
            background-color: var(--light-gray);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: default;
            background-color: var(--white);
        }
        
        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1010;
            justify-content: center;
            align-items: center;
        }
        
        .modal {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--mid-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            color: var(--dark-gray);
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }
        
        .role-selection {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .role-option {
            flex: 1;
            border: 2px solid var(--mid-gray);
            border-radius: var(--border-radius);
            padding: 15px;
            cursor: pointer;
            text-align: center;
            transition: border-color 0.2s, transform 0.2s;
        }
        
        .role-option:hover {
            transform: translateY(-2px);
        }
        
        .role-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 93, 172, 0.05);
        }
        
        .role-option i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .role-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .role-desc {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--mid-gray);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .modal-btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-color);
        }
        
        .modal-btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }
        
        .modal-btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .connecting-strava {
            text-align: center;
            padding: 20px 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .connecting-text {
            margin-bottom: 10px;
        }
        
        /* Admin Panel */
        .admin-panel {
            display: none;
        }
        
        .admin-login {
            max-width: 400px;
            margin: 50px auto;
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .admin-login h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--mid-gray);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .admin-login-btn {
            width: 100%;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 4px;
            padding: 10px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .admin-controls {
            display: none;
            margin-top: 20px;
        }
        
        .admin-section {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .admin-section h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .date-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .date-input {
            flex: 1;
        }
        
        .test-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .test-controls button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Install Banner */
        .install-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--white);
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 900;
        }
        
        .install-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .install-text {
            flex-grow: 1;
            margin-right: 15px;
        }
        
        .install-title {
            font-weight: 500;
            margin: 0 0 5px;
        }
        
        .install-desc {
            font-size: 0.9rem;
            color: var(--dark-gray);
            margin: 0;
        }
        
        .install-actions {
            display: flex;
            gap: 10px;
        }
        
        .install-btn {
            background-color: var(--action-color);
            color: var(--white);
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .dismiss-btn {
            background-color: transparent;
            border: none;
            color: var(--dark-gray);
            padding: 8px;
            cursor: pointer;
        }
        
        /* Notifications and Badges */
        .notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 20px;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .badge-earned {
            background-color: var(--primary-color);
            color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
        }
        
        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .badge-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .badge-desc {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* Badge Display */
        .badges-display {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            position: relative;
        }
        
        .badge i {
            font-size: 1rem;
        }
        
        .badge[data-badge]:after {
            content: attr(data-badge);
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary-color);
            color: var(--white);
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Heatmap */
        .heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 10px;
        }
        
        .heatmap-day {
            aspect-ratio: 1;
            border-radius: 2px;
            background-color: var(--light-gray);
        }
        
        .heat-0 { background-color: var(--light-gray); }
        .heat-1 { background-color: #d6eaf8; }
        .heat-2 { background-color: #aed6f1; }
        .heat-3 { background-color: #85c1e9; }
        .heat-4 { background-color: #5dade2; }
        .heat-5 { background-color: #3498db; }
        
        /* Level indicator */
        .level-indicator {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: var(--primary-color);
            color: var(--white);
        }
        
        /* Trophy icon for winner */
        .winner-trophy {
            color: gold;
            margin-left: 5px;
        }
        
        /* Mobile Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--white);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 900;
        }
        
        .nav-items {
            display: flex;
            justify-content: space-around;
        }
        
        .nav-item {
            padding: 10px;
            flex: 1;
            text-align: center;
            color: var(--dark-gray);
            text-decoration: none;
            font-size: 0.8rem;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-item i {
            font-size: 1.2rem;
            display: block;
            margin-bottom: 2px;
        }
        
        @media (display-mode: standalone) {
            .mobile-nav {
                display: block;
            }
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding-bottom: 70px;
            }
            
            .participants-list {
                grid-template-columns: 1fr;
            }
            
            .role-selection {
                flex-direction: column;
            }
            
            .activity-stats {
                flex-direction: column;
                align-items: flex-end;
            }
            
            .activity-distance, .activity-pace {
                margin-left: 0;
                margin-top: 5px;
            }
            
            .date-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- PWA Install Banner -->
    <div class="install-banner" id="installBanner">
        <div class="install-content">
            <div class="install-text">
                <h3 class="install-title">Zainstaluj aplikację Wyzwanie 2025</h3>
                <p class="install-desc">Dodaj aplikację do ekranu głównego, aby szybciej śledzić swój postęp.</p>
            </div>
            <div class="install-actions">
                <button class="install-btn" id="installBtn">Zainstaluj</button>
                <button class="dismiss-btn" id="dismissBtn">×</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <h1>Wyzwanie 2025</h1>
        <div class="header-actions">
            <a href="#" class="admin-link" id="adminLink">Panel administratora</a>
        </div>
    </header>

    <!-- Main Application -->
    <div class="container" id="mainApp">
        <!-- Rules Section -->
        <section class="rules-section">
            <div class="rules-header">
                <h2>Zasady wyzwania</h2>
                <div class="countdown" id="countdown">Do końca: 180 dni</div>
            </div>
            <div class="rules-content">
                <p>Wyzwanie trwa od 1 kwietnia do 30 września 2025. Pierwszy uczestnik, który osiągnie 2000 punktów, wygrywa!</p>
                <p><strong>Biegacze:</strong> 2 punkty za każdy przebiegnięty kilometr</p>
                <p><strong>Rowerzyści:</strong> 1 punkt za każdy przejechany kilometr</p>
                <p><strong>Biegacze/rowerzyści:</strong> Punkty z obu aktywności</p>
            </div>
            <button class="join-btn" id="joinBtn">
                <i class="fas fa-user-plus"></i> Dołącz do wyzwania
            </button>
        </section>

        <!-- Progress Chart -->
        <section class="chart-section">
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>
        </section>

        <!-- Participants Section -->
        <section class="participants-section">
            <div class="participants-header">
                <h2>Uczestnicy</h2>
            </div>
            <div class="participants-list" id="participantsList">
                <!-- Participants will be added dynamically -->
            </div>
        </section>

        <!-- Activities Section -->
        <section class="activities-section">
            <div class="activities-header">
                <h2>Ostatnie aktywności</h2>
            </div>
            <div class="activities-list" id="activitiesList">
                <!-- Activities will be added dynamically -->
            </div>
            <div class="pagination">
                <button class="pagination-btn" id="prevPageBtn" disabled>Poprzednia</button>
                <button class="pagination-btn" id="nextPageBtn">Następna</button>
            </div>
        </section>
    </div>

    <!-- Admin Panel -->
    <div class="container admin-panel" id="adminPanel">
        <div class="admin-login" id="adminLogin">
            <h2>Panel administratora</h2>
            <div class="form-group">
                <label for="adminPassword">Hasło:</label>
                <input type="password" id="adminPassword" class="form-control">
            </div>
            <button class="admin-login-btn" id="adminLoginBtn">Zaloguj</button>
        </div>

        <div class="admin-controls" id="adminControls">
            <section class="admin-section">
                <h3>Ustawienia wyzwania</h3>
                <div class="date-controls">
                    <div class="date-input">
                        <label for="startDate">Data rozpoczęcia:</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="date-input">
                        <label for="endDate">Data zakończenia:</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>
                <button class="modal-btn modal-btn-primary" id="saveDatesBtn">Zapisz daty</button>
            </section>

            <section class="admin-section">
                <h3>Tryb testowy</h3>
                <div class="test-controls">
                    <button class="modal-btn modal-btn-secondary" id="generateTestDataBtn">Generuj dane testowe</button>
                    <button class="modal-btn modal-btn-secondary" id="resetTestDataBtn">Resetuj dane testowe</button>
                    <button class="modal-btn modal-btn-secondary" id="toggleTestModeBtn">Włącz/Wyłącz tryb testowy</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Join Modal -->
    <div class="modal-overlay" id="joinModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Dołącz do wyzwania</h3>
                <button class="modal-close" id="closeJoinModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p>Wybierz swoją rolę w wyzwaniu. Pamiętaj, że wybór jest ostateczny i nie można go zmienić po dołączeniu.</p>
                
                <div class="role-selection" id="roleSelection">
                    <div class="role-option" data-role="runner">
                        <i class="fas fa-running"></i>
                        <div class="role-name">Biegacz</div>
                        <div class="role-desc">2 punkty za każdy przebiegnięty km</div>
                    </div>
                    <div class="role-option" data-role="cyclist">
                        <i class="fas fa-bicycle"></i>
                        <div class="role-name">Rowerzysta</div>
                        <div class="role-desc">1 punkt za każdy przejechany km</div>
                    </div>
                    <div class="role-option" data-role="both">
                        <i class="fas fa-medal"></i>
                        <div class="role-name">Biegacz + Rowerzysta</div>
                        <div class="role-desc">Punkty z obu aktywności</div>
                    </div>
                </div>
                
                <div class="connecting-strava" id="connectingStrava" style="display: none;">
                    <div class="spinner"></div>
                    <p class="connecting-text">Łączenie z kontem Strava...</p>
                    <p>Zostaniesz przekierowany do strony logowania Strava.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="cancelJoinBtn">Anuluj</button>
                <button class="modal-btn modal-btn-primary" id="connectStravaBtn" disabled>Połącz z Strava</button>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation (for installed PWA) -->
    <nav class="mobile-nav">
        <div class="nav-items">
            <a href="#" class="nav-item active">
                <i class="fas fa-home"></i>
                <span>Główna</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Postęp</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Uczestnicy</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-medal"></i>
                <span>Twój profil</span>
            </a>
        </div>
    </nav>

    <!-- Font Awesome for Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

    <!-- Main JavaScript -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
  apiKey: "AIzaSyCxOfhKBNyIzhkkkiHOhXd3x3mfSUMS6M4",
  authDomain: "wyzwanie2025-a6298.firebaseapp.com",
  projectId: "wyzwanie2025-a6298",
  storageBucket: "wyzwanie2025-a6298.firebasestorage.app",
  messagingSenderId: "74567179841",
  appId: "1:74567179841:web:e7bb1c6f12fc64ef5730c0",
  measurementId: "G-D63RBL1K8E"
};
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // PWA setup
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
        
        // Create a dynamic Web App Manifest
        const manifestContent = {
            "name": "Wyzwanie 2025",
            "short_name": "Wyzwanie",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#005dac",
            "description": "Sportowe wyzwanie 2025",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAL6UExURUdwTABetwBfuABdtgBetgBeuABetgBdtwBdtwBeuABetgBetgBetgBdtwBdtgBetgBeuABetgBetgBdtv///wBeuABdtgBetgBetgBetgBetgBetgBetgBdtv///wBetgBdtwBdtgBetgBetgBdtv///wBetgBdtgBetgBdtwBetgBdtgBetgBetgBdtv///wBdtwBdtwBdtwBetgBdtgBdtgBdtwBdtwBdtwBdtwBdtwBdtwBdtwBdtwBdtgBdtwBdtwBetgBdtgBdtwBetgBdtwBdtgBetgBdtwBdtwBdtgBdtwBdtgBetgBetgBetgBdtgBdtgBetgBdtwBetgBetgBetgBetgBetf///wBdtwBetgBdtgBetgBetgBdtgBetgBetgBdtwBdtwBdtgBdtwBdtwBetwBeuABdtgBdtwBdtwBetgBetf///wBdtwBdtwBdtvr7/ABdtgBdtv///wBdtgBdtwBetgBetgBdtf///wBdtgBetgBetgBdtgBetgBetv///wBetgBetv///wBetgBdtgBdtgBdtgBdtgBetgBetgBdtgBdtgBdtgBdtwBetgBdtgBdtgBetgBdtgBdtgBetgBetgBdtgBdtv///wBdtwBdtgBdtgBetgBetgBdtgBdtgBdtwBetgBdtwBdtgBdtgBetgBdtgBdtgBetgBdtgBetgBdtgBetgBdtgBetgBdtgBdtgBetgBdtgBetgBdtwBdtgBdtwBetgBdtgBetgBetgBdtgBetgBdtgBdtgBdtgBetgBetgBetgBetgBdtgBdtgBetgBdtgBetgBdtgBdtgBdtgBetgBdtgBdtgBetgBdtgBetgBdtgBetgBdtwBetgBdtgBdtgBdtwBdtgBetgBdtwBetgBdtgBetgBetgBetgBetgBetgBdtgBdtgBdtgBdtgBetgBdtgBdtgBetgBetgBetgBetgBdtgBdtgBdtgBetgBdtgBetgBdtgBetgBdtgBetgBdtgBdtgBetgBetgBdtgBetgBdtgBetgBdtgBetgBetgBdtgBdtgBetgBdtvxTTSIAAAA/dFJO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",
                    "sizes": "192x192",
                    "type": "image/png"
                }
            ]
        };
        
        // Create Blob for manifest
        const manifestBlob = new Blob([JSON.stringify(manifestContent)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        
        // Set the manifest link
        document.querySelector('link[rel="manifest"]').href = manifestURL;
        
        // Service worker for PWA
        const swContent = `
            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open('wyzwanie-2025-v1').then((cache) => {
                        return cache.addAll([
                            '/',
                            '/index.html'
                        ]);
                    })
                );
            });
            
            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request).then((response) => {
                        return response || fetch(event.request);
                    })
                );
            });
        `;
        
        // Create Blob for service worker
        const swBlob = new Blob([swContent], {type: 'text/javascript'});
        const swURL = URL.createObjectURL(swBlob);
        
        // Register service worker dynamically
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swURL)
                    .then(registration => {
                        console.log('ServiceWorker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
        
        // App state
        let appState = {
            currentUser: null,
            participants: [],
            activities: [],
            currentPage: 1,
            activitiesPerPage: 8,
            selectedRole: null,
            challenge: {
                startDate: new Date("2025-04-01"),
                endDate: new Date("2025-09-30"),
                testMode: false
            },
            deferredPrompt: null,
            isAdmin: false,
            adminPassword: "admin2025"
        };
        
        // DOM elements
        const elements = {
            joinBtn: document.getElementById('joinBtn'),
            participantsList: document.getElementById('participantsList'),
            activitiesList: document.getElementById('activitiesList'),
            countdown: document.getElementById('countdown'),
            progressChart: document.getElementById('progressChart'),
            prevPageBtn: document.getElementById('prevPageBtn'),
            nextPageBtn: document.getElementById('nextPageBtn'),
            joinModal: document.getElementById('joinModal'),
            closeJoinModalBtn: document.getElementById('closeJoinModalBtn'),
            cancelJoinBtn: document.getElementById('cancelJoinBtn'),
            roleSelection: document.getElementById('roleSelection'),
            connectStravaBtn: document.getElementById('connectStravaBtn'),
            connectingStrava: document.getElementById('connectingStrava'),
            installBanner: document.getElementById('installBanner'),
            installBtn: document.getElementById('installBtn'),
            dismissBtn: document.getElementById('dismissBtn'),
            adminLink: document.getElementById('adminLink'),
            adminPanel: document.getElementById('adminPanel'),
            mainApp: document.getElementById('mainApp'),
            adminLogin: document.getElementById('adminLogin'),
            adminControls: document.getElementById('adminControls'),
            adminPassword: document.getElementById('adminPassword'),
            adminLoginBtn: document.getElementById('adminLoginBtn'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            saveDatesBtn: document.getElementById('saveDatesBtn'),
            generateTestDataBtn: document.getElementById('generateTestDataBtn'),
            resetTestDataBtn: document.getElementById('resetTestDataBtn'),
            toggleTestModeBtn: document.getElementById('toggleTestModeBtn')
        };
        
        // Helper functions
        function formatDate(date) {
            return new Date(date).toLocaleDateString('pl-PL');
        }
        
        function formatDistance(distance) {
            return (distance / 1000).toFixed(2);
        }
        
        function formatPace(seconds, isRunning = true) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            if (isRunning) {
                return `${mins}:${secs.toString().padStart(2, '0')}/km`;
            } else {
                return `${(seconds / 3.6).toFixed(1)} km/h`;
            }
        }
        
        function calculatePoints(distance, role, activityType) {
            const distanceKm = distance / 1000;
            if (role === 'runner' && activityType.includes('run')) {
                return distanceKm * 2;
            } else if (role === 'cyclist' && activityType.includes('ride')) {
                return distanceKm;
            } else if (role === 'both') {
                if (activityType.includes('run')) {
                    return distanceKm * 2;
                } else if (activityType.includes('ride')) {
                    return distanceKm;
                }
            }
            return 0;
        }
        
        function getDaysRemaining() {
            const today = new Date();
            const endDate = appState.challenge.endDate;
            const diffTime = endDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Firebase helpers
        async function saveParticipantToFirebase(participant) {
            try {
                await db.collection('participants').doc(participant.id).set(participant);
                return true;
            } catch (error) {
                console.error('Error saving participant:', error);
                return false;
            }
        }
        
        async function saveActivityToFirebase(activity) {
            try {
                await db.collection('activities').doc(activity.id).set(activity);
                return true;
            } catch (error) {
                console.error('Error saving activity:', error);
                return false;
            }
        }
        
        async function saveChallengeSettingsToFirebase() {
            try {
                await db.collection('settings').doc('challenge').set({
                    startDate: appState.challenge.startDate,
                    endDate: appState.challenge.endDate,
                    testMode: appState.challenge.testMode
                });
                return true;
            } catch (error) {
                console.error('Error saving settings:', error);
                return false;
            }
        }
        
        async function loadDataFromFirebase() {
            try {
                // Load challenge settings
                const settingsDoc = await db.collection('settings').doc('challenge').get();
                if (settingsDoc.exists) {
                    const settings = settingsDoc.data();
                    appState.challenge.startDate = settings.startDate.toDate();
                    appState.challenge.endDate = settings.endDate.toDate();
                    appState.challenge.testMode = settings.testMode;
                }
                
                // Load participants
                const participantsSnapshot = await db.collection('participants').get();
                appState.participants = [];
                participantsSnapshot.forEach(doc => {
                    const participant = doc.data();
                    if (participant.stravaToken) {
                        // Don't expose Strava tokens to the client
                        delete participant.stravaToken;
                        delete participant.stravaRefreshToken;
                    }
                    appState.participants.push(participant);
                });
                
                // Load activities
                const activitiesSnapshot = await db.collection('activities').orderBy('date', 'desc').get();
                appState.activities = [];
                activitiesSnapshot.forEach(doc => {
                    appState.activities.push(doc.data());
                });
                
                // Check if current user is already a participant
                const currentUserId = localStorage.getItem('participantId');
                if (currentUserId) {
                    appState.currentUser = appState.participants.find(p => p.id === currentUserId);
                    if (appState.currentUser) {
                        elements.joinBtn.classList.add('joined-btn');
                        elements.joinBtn.textContent = 'Już uczestniczysz';
                    }
                }
                
                // Render UI components
                renderParticipants();
                renderActivities();
                updateCountdown();
                initializeChart();
                
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                return false;
            }
        }
        
        // UI rendering functions
        function renderParticipants() {
            elements.participantsList.innerHTML = '';
            
            // Sort participants by points
            const sortedParticipants = [...appState.participants].sort((a, b) => b.points - a.points);
            
            sortedParticipants.forEach((participant, index) => {
                const card = document.createElement('div');
                card.className = 'participant-card';
                
                const progressPercentage = Math.min((participant.points / 2000) * 100, 100);
                
                let roleClass, progressClass;
                if (participant.role === 'runner') {
                    roleClass = 'role-runner';
                    progressClass = 'progress-runner';
                } else if (participant.role === 'cyclist') {
                    roleClass = 'role-cyclist';
                    progressClass = 'progress-cyclist';
                } else {
                    roleClass = 'role-both';
                    progressClass = 'progress-both';
                }
                
                let rankClass = '';
                if (index === 0) rankClass = 'rank-1';
                else if (index === 1) rankClass = 'rank-2';
                else if (index === 2) rankClass = 'rank-3';
                
                // Get appropriate level based on points and role
                let level = '';
                if (participant.role === 'runner') {
                    if (participant.points >= 1500) level = 'Mistrz Biegania';
                    else if (participant.points >= 750) level = 'Zaawansowany Biegacz';
                    else if (participant.points >= 250) level = 'Regularny Biegacz';
                    else level = 'Początkujący Biegacz';
                } else if (participant.role === 'cyclist') {
                    if (participant.points >= 1500) level = 'Mistrz Kolarstwa';
                    else if (participant.points >= 750) level = 'Zaawansowany Kolarz';
                    else if (participant.points >= 250) level = 'Regularny Rowerzysta';
                    else level = 'Początkujący Kolarz';
                } else {
                    if (participant.points >= 1500) level = 'Mistrz Multisportu';
                    else if (participant.points >= 750) level = 'Zaawansowany Sportowiec';
                    else if (participant.points >= 250) level = 'Regularny Sportowiec';
                    else level = 'Początkujący Sportowiec';
                }
                
                let roleIcon;
                if (participant.role === 'runner') roleIcon = 'fa-running';
                else if (participant.role === 'cyclist') roleIcon = 'fa-bicycle';
                else roleIcon = 'fa-medal';
                
                let distanceLabel, distanceValue;
                if (participant.role === 'runner') {
                    distanceLabel = 'Kilometry biegu';
                    distanceValue = participant.runDistance ? (participant.runDistance / 1000).toFixed(1) : '0.0';
                } else if (participant.role === 'cyclist') {
                    distanceLabel = 'Kilometry jazdy';
                    distanceValue = participant.rideDistance ? (participant.rideDistance / 1000).toFixed(1) : '0.0';
                } else {
                    distanceLabel = 'Suma kilometrów';
                    const runDist = participant.runDistance ? participant.runDistance : 0;
                    const rideDist = participant.rideDistance ? participant.rideDistance : 0;
                    distanceValue = ((runDist + rideDist) / 1000).toFixed(1);
                }
                
                const isWinner = participant.points >= 2000;
                
                card.innerHTML = `
                    <div class="participant-header">
                        <div class="participant-rank ${rankClass}">#${index + 1}</div>
                        <img src="${participant.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + participant.name}" alt="${participant.name}" class="participant-avatar">
                        <div class="participant-info">
                            <h3 class="participant-name">${participant.name} ${isWinner ? '<i class="fas fa-trophy winner-trophy"></i>' : ''}</h3>
                            <span class="participant-role ${roleClass}"><i class="fas ${roleIcon}"></i> ${participant.role === 'runner' ? 'Biegacz' : participant.role === 'cyclist' ? 'Rowerzysta' : 'Biegacz + Rowerzysta'}</span>
                            <span class="level-indicator">${level}</span>
                        </div>
                    </div>
                    <div class="participant-stats">
                        <div class="stats-row">
                            <span class="stats-label">Punkty</span>
                            <span class="stats-value">${Math.round(participant.points)} / 2000</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">${distanceLabel}</span>
                            <span class="stats-value">${distanceValue} km</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressClass}" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                    <div class="badges-display">
                        ${generateBadgesForParticipant(participant)}
                    </div>
                `;
                
                elements.participantsList.appendChild(card);
            });
        }
        
        function generateBadgesForParticipant(participant) {
            // This would be expanded based on the badges logic
            let badgesHTML = '';
            
            // Example badges based on points
            if (participant.points >= 100) {
                badgesHTML += `<div class="badge" title="Pierwszy krok (100 punktów)"><i class="fas fa-shoe-prints"></i></div>`;
            }
            
            if (participant.points >= 500) {
                badgesHTML += `<div class="badge" title="Na dobrej drodze (500 punktów)"><i class="fas fa-road"></i></div>`;
            }
            
            if (participant.points >= 1000) {
                badgesHTML += `<div class="badge" title="Półmetek (1000 punktów)"><i class="fas fa-flag-checkered"></i></div>`;
            }
            
            return badgesHTML;
        }
        
        function renderActivities() {
            elements.activitiesList.innerHTML = '';
            
            const startIndex = (appState.currentPage - 1) * appState.activitiesPerPage;
            const endIndex = startIndex + appState.activitiesPerPage;
            const activitiesToShow = appState.activities.slice(startIndex, endIndex);
            
            activitiesToShow.forEach(activity => {
                const activityEl = document.createElement('div');
                activityEl.className = 'activity-item';
                
                const participant = appState.participants.find(p => p.id === activity.participantId);
                const participantName = participant ? participant.name : 'Nieznany uczestnik';
                
                let iconClass, activityTypeLabel;
                if (activity.type.includes('run')) {
                    iconClass = 'activity-run';
                    activityTypeLabel = 'Bieganie';
                } else {
                    iconClass = 'activity-cycle';
                    activityTypeLabel = 'Kolarstwo';
                }
                
                activityEl.innerHTML = `
                    <div class="activity-icon ${iconClass}">
                        <i class="fas ${activity.type.includes('run') ? 'fa-running' : 'fa-bicycle'}"></i>
                    </div>
                    <div class="activity-details">
                        <h4 class="activity-title">${activity.name}</h4>
                        <div class="activity-meta">
                            <div class="activity-user">${participantName}</div>
                            <div class="activity-date">${formatDate(activity.date)}</div>
                            <div class="activity-type">${activityTypeLabel}</div>
                        </div>
                    </div>
                    <div class="activity-stats">
                        <div class="activity-distance">
                            <div class="activity-label">Dystans</div>
                            <div class="activity-value">${formatDistance(activity.distance)} km</div>
                        </div>
                        <div class="activity-pace">
                            <div class="activity-label">${activity.type.includes('run') ? 'Tempo' : 'Prędkość'}</div>
                            <div class="activity-value">${formatPace(activity.pace, activity.type.includes('run'))}</div>
                        </div>
                    </div>
                `;
                
                elements.activitiesList.appendChild(activityEl);
            });
            
            // Update pagination buttons
            elements.prevPageBtn.disabled = appState.currentPage === 1;
            elements.nextPageBtn.disabled = endIndex >= appState.activities.length;
        }
        
        function updateCountdown() {
            const daysRemaining = getDaysRemaining();
            elements.countdown.textContent = `Do końca: ${daysRemaining} dni`;
        }
        
        function initializeChart() {
            const ctx = elements.progressChart.getContext('2d');
            
            // Prepare data
            const labels = [];
            const datasets = [];
            
            // Generate dates for the x-axis (from challenge start to end)
            const startDate = new Date(appState.challenge.startDate);
            const endDate = new Date(appState.challenge.endDate);
            const today = new Date();
            
            // Create date range
            const dateRange = [];
            let currentDate = new Date(startDate);
            while (currentDate <= endDate && currentDate <= today) {
                dateRange.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Format labels
            dateRange.forEach(date => {
                labels.push(formatDate(date));
            });
            
            // Prepare participant data
            const participantColors = [
                '#42a5f5',
                '#ff7043',
                '#9575cd',
                '#4caf50',
                '#f06292',
                '#ffa726',
                '#78909c',
                '#66bb6a',
                '#ec407a',
                '#8d6e63'
            ];
            
            // Sort participants by points for chart display order
            const sortedParticipants = [...appState.participants].sort((a, b) => b.points - a.points);
            
            // Create datasets for each participant
            sortedParticipants.forEach((participant, index) => {
                // Calculate cumulative points for each day
                const data = [];
                let cumulativePoints = 0;
                
                dateRange.forEach(date => {
                    // Find activities for this participant on or before this date
                    const relevantActivities = appState.activities.filter(a => 
                        a.participantId === participant.id && 
                        new Date(a.date) <= date
                    );
                    
                    // Calculate points up to this date
                    cumulativePoints = 0;
                    relevantActivities.forEach(activity => {
                        cumulativePoints += calculatePoints(activity.distance, participant.role, activity.type);
                    });
                    
                    data.push(cumulativePoints);
                });
                
                // Create dataset for this participant
                datasets.push({
                    label: participant.name,
                    data: data,
                    borderColor: participantColors[index % participantColors.length],
                    backgroundColor: 'transparent',
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    borderWidth: 3
                });
            });
            
            // Create the chart
            if (window.progressChart) {
                window.progressChart.destroy();
            }
            
            window.progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y || 0;
                                    return `${label}: ${value.toFixed(0)} punktów`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 8,
                                callback: function(value, index, values) {
                                    // Show every nth label to avoid crowding
                                    const step = Math.ceil(labels.length / 8);
                                    return index % step === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' pkt';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        // Strava API integration
        async function connectWithStrava(role) {
            const clientId = '150694'; // Replace with your Strava app client ID
            const redirectUri = window.location.href;
            const scope = 'read,activity:read';
            
            // Store role selection in localStorage
            localStorage.setItem('selectedRole', role);
            
            // Redirect to Strava auth page
            const stravaAuthUrl = `https://www.strava.com/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${scope}`;
            window.location.href = stravaAuthUrl;
        }
        
        async function handleStravaCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                // Remove code from URL
                const newUrl = window.location.href.split('?')[0];
                window.history.replaceState({}, document.title, newUrl);
                
                // Show connecting animation
                elements.connectingStrava.style.display = 'block';
                elements.roleSelection.style.display = 'none';
                elements.connectStravaBtn.style.display = 'none';
                
                try {
                    // Exchange code for token
                    const tokenResponse = await exchangeCodeForToken(code);
                    
                    if (tokenResponse && tokenResponse.access_token) {
                        // Get athlete profile
                        const athleteProfile = await getAthleteProfile(tokenResponse.access_token);
                        
                        if (athleteProfile) {
                            // Check if athlete already exists
                            const existingParticipant = appState.participants.find(p => p.stravaId === athleteProfile.id);
                            
                            if (existingParticipant) {
                                showNotification('Już uczestniczysz w wyzwaniu!', 'warning');
                                elements.joinModal.style.display = 'none';
                                return;
                            }
                            
                            // Get selected role
                            const selectedRole = localStorage.getItem('selectedRole');
                            
                            // Create new participant
                            const newParticipant = {
                                id: 'participant_' + Date.now(),
                                stravaId: athleteProfile.id,
                                name: athleteProfile.firstname + ' ' + athleteProfile.lastname,
                                avatar: athleteProfile.profile,
                                role: selectedRole,
                                points: 0,
                                runDistance: 0,
                                rideDistance: 0,
                                stravaToken: tokenResponse.access_token,
                                stravaRefreshToken: tokenResponse.refresh_token,
                                tokenExpiresAt: Date.now() + (tokenResponse.expires_in * 1000),
                                joinDate: new Date().toISOString(),
                                badges: [],
                                level: 1
                            };
                            
                            // Save participant to Firebase
                            const saved = await saveParticipantToFirebase(newParticipant);
                            
                            if (saved) {
                                // Save participant ID to localStorage
                                localStorage.setItem('participantId', newParticipant.id);
                                
                                // Update UI
                                appState.currentUser = newParticipant;
                                appState.participants.push(newParticipant);
                                
                                elements.joinBtn.classList.add('joined-btn');
                                elements.joinBtn.textContent = 'Już uczestniczysz';
                                
                                // Close modal
                                elements.joinModal.style.display = 'none';
                                
                                // Fetch initial activities
                                await fetchStravaActivities(newParticipant);
                                
                                // Refresh UI
                                renderParticipants();
                                renderActivities();
                                initializeChart();
                                
                                showNotification('Pomyślnie dołączono do wyzwania!', 'success');
                            } else {
                                showNotification('Wystąpił błąd podczas zapisywania danych.', 'error');
                            }
                        } else {
                            showNotification('Nie udało się pobrać profilu ze Strava.', 'error');
                        }
                    } else {
                        showNotification('Nie udało się połączyć z kontem Strava.', 'error');
                    }
                } catch (error) {
                    console.error('Error during Strava authentication:', error);
                    showNotification('Wystąpił błąd podczas łączenia z kontem Strava.', 'error');
                }
                
                // Hide connecting animation
                elements.connectingStrava.style.display = 'none';
                elements.roleSelection.style.display = 'flex';
                elements.connectStravaBtn.style.display = 'block';
            }
        }
        
        async function exchangeCodeForToken(code) {
            const clientId = '150694'; // Replace with your Strava app client ID
            const clientSecret = 'd780e7a6e9bd2493f4e578d5206d4b6921c0a775'; // Replace with your Strava app client secret
            
            // In a real app, this would be a server-side call to protect your client secret
            // For demonstration purposes, we're doing it client-side
            const response = await fetch('https://www.strava.com/oauth/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_id: clientId,
                    client_secret: clientSecret,
                    code: code,
                    grant_type: 'authorization_code'
                })
            });
            
            if (response.ok) {
                return await response.json();
            }
            
            return null;
        }
        
        async function refreshStravaToken(participant) {
            const clientId = '150694';
            const clientSecret = 'd780e7a6e9bd2493f4e578d5206d4b6921c0a775';
            
            try {
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_secret: clientSecret,
                        refresh_token: participant.stravaRefreshToken,
                        grant_type: 'refresh_token'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update participant's token info
                    participant.stravaToken = data.access_token;
                    participant.stravaRefreshToken = data.refresh_token;
                    participant.tokenExpiresAt = Date.now() + (data.expires_in * 1000);
                    
                    // Save updated participant to Firebase
                    await saveParticipantToFirebase(participant);
                    
                    return data.access_token;
                }
            } catch (error) {
                console.error('Error refreshing token:', error);
            }
            
            return null;
        }
        
        async function getAthleteProfile(accessToken) {
            try {
                const response = await fetch('https://www.strava.com/api/v3/athlete', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Error fetching athlete profile:', error);
            }
            
            return null;
        }
        
        async function fetchStravaActivities(participant) {
            // Check if token needs refreshing
            if (Date.now() >= participant.tokenExpiresAt) {
                const newToken = await refreshStravaToken(participant);
                if (!newToken) {
                    console.error('Failed to refresh token');
                    return;
                }
                participant.stravaToken = newToken;
            }
            
            try {
                // Calculate date range
                let afterDate;
                if (appState.challenge.testMode) {
                    // For test mode, get activities from the last 3 months
                    const threeMonthsAgo = new Date();
                    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                    afterDate = Math.floor(threeMonthsAgo.getTime() / 1000);
                } else {
                    // For live mode, get activities from challenge start date
                    afterDate = Math.floor(appState.challenge.startDate.getTime() / 1000);
                }
                
                // Get activities from Strava
                const response = await fetch(`https://www.strava.com/api/v3/athlete/activities?after=${afterDate}&per_page=100`, {
                    headers: {
                        'Authorization': `Bearer ${participant.stravaToken}`
                    }
                });
                
                if (response.ok) {
                    const activities = await response.json();
                    
                    // Filter activities based on participant role
                    let relevantActivities = [];
                    if (participant.role === 'runner') {
                        relevantActivities = activities.filter(a => a.type.toLowerCase().includes('run'));
                    } else if (participant.role === 'cyclist') {
                        relevantActivities = activities.filter(a => a.type.toLowerCase().includes('ride'));
                    } else {
                        relevantActivities = activities.filter(a => 
                            a.type.toLowerCase().includes('run') || a.type.toLowerCase().includes('ride')
                        );
                    }
                    
                    // Process activities
                    let totalPoints = 0;
                    let totalRunDistance = 0;
                    let totalRideDistance = 0;
                    
                    for (const activity of relevantActivities) {
                        // Calculate points
                        const points = calculatePoints(activity.distance, participant.role, activity.type.toLowerCase());
                        totalPoints += points;
                        
                        // Update distances
                        if (activity.type.toLowerCase().includes('run')) {
                            totalRunDistance += activity.distance;
                        } else if (activity.type.toLowerCase().includes('ride')) {
                            totalRideDistance += activity.distance;
                        }
                        
                        // Create activity object for storage
                        const activityObj = {
                            id: 'activity_' + activity.id,
                            stravaId: activity.id,
                            participantId: participant.id,
                            name: activity.name,
                            type: activity.type.toLowerCase(),
                            date: new Date(activity.start_date).toISOString(),
                            distance: activity.distance,
                            pace: activity.average_speed ? (activity.type.toLowerCase().includes('run') ? 1000 / activity.average_speed : activity.average_speed) : 0,
                            points: points
                        };
                        
                        // Check if activity already exists
                        const existingActivity = appState.activities.find(a => a.stravaId === activity.id);
                        if (!existingActivity) {
                            // Save new activity to Firebase
                            await saveActivityToFirebase(activityObj);
                            appState.activities.push(activityObj);
                        }
                    }
                    
                    // Update participant stats
                    participant.points = totalPoints;
                    participant.runDistance = totalRunDistance;
                    participant.rideDistance = totalRideDistance;
                    
                    // Save updated participant to Firebase
                    await saveParticipantToFirebase(participant);
                    
                    return true;
                }
            } catch (error) {
                console.error('Error fetching Strava activities:', error);
            }
            
            return false;
        }
        
        // Test data generation
        function generateTestData() {
            // Clear existing data
            appState.participants = [];
            appState.activities = [];
            
            // Generate participants
            const testParticipants = [
                {
                    id: 'participant_1',
                    name: 'Jan Kowalski',
                    role: 'runner',
                    avatar: '',
                    points: 0,
                    runDistance: 0,
                    rideDistance: 0,
                    joinDate: new Date(2025, 3, 1).toISOString(),
                    badges: [],
                    level: 1
                },
                {
                    id: 'participant_2',
                    name: 'Anna Nowak',
                    role: 'cyclist',
                    avatar: '',
                    points: 0,
                    runDistance: 0,
                    rideDistance: 0,
                    joinDate: new Date(2025, 3, 1).toISOString(),
                    badges: [],
                    level: 1
                },
                {
                    id: 'participant_3',
                    name: 'Piotr Wiśniewski',
                    role: 'both',
                    avatar: '',
                    points: 0,
                    runDistance: 0,
                    rideDistance: 0,
                    joinDate: new Date(2025, 3, 1).toISOString(),
                    badges: [],
                    level: 1
                }
            ];
            
            appState.participants = testParticipants;
            
            // Generate activities for each participant
            const startDate = new Date(appState.challenge.startDate);
            const endDate = new Date();
            const activityTypes = {
                runner: ['run'],
                cyclist: ['ride'],
                both: ['run', 'ride']
            };
            
            let activityId = 1;
            
            for (const participant of testParticipants) {
                const participantTypes = activityTypes[participant.role];
                
                // Generate one activity every 2-3 days
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    // 80% chance to have an activity on this day
                    if (Math.random() < 0.8) {
                        // For 'both' role, alternate between run and ride
                        const activityType = participantTypes.length > 1 
                            ? participantTypes[Math.floor(Math.random() * participantTypes.length)]
                            : participantTypes[0];
                        
                        // Random distance between 5-15km for runs, 20-50km for rides
                        const minDistance = activityType === 'run' ? 5000 : 20000;
                        const maxDistance = activityType === 'run' ? 15000 : 50000;
                        const distance = Math.floor(Math.random() * (maxDistance - minDistance + 1)) + minDistance;
                        
                        // Random pace
                        const pace = activityType === 'run' 
                            ? Math.floor(Math.random() * (360 - 240 + 1)) + 240 // 4:00 - 6:00 min/km
                            : Math.floor(Math.random() * (25 - 15 + 1)) + 15; // 15-25 km/h
                        
                        // Calculate points
                        const points = activityType === 'run' ? distance / 1000 * 2 : distance / 1000;
                        
                        // Create activity
                        const activity = {
                            id: 'activity_' + activityId++,
                            stravaId: 'test_' + activityId,
                            participantId: participant.id,
                            name: activityType === 'run' ? 'Bieganie poranne' : 'Przejażdżka rowerowa',
                            type: activityType,
                            date: new Date(currentDate).toISOString(),
                            distance: distance,
                            pace: pace,
                            points: points
                        };
                        
                        appState.activities.push(activity);
                        
                        // Update participant stats
                        participant.points += points;
                        if (activityType === 'run') {
                            participant.runDistance += distance;
                        } else {
                            participant.rideDistance += distance;
                        }
                    }
                    
                    // Move to next date (2-3 days later)
                    const daysToAdd = Math.floor(Math.random() * 2) + 2;
                    currentDate.setDate(currentDate.getDate() + daysToAdd);
                }
            }
            
            // Save test data to Firebase
            saveTestDataToFirebase();
            
            // Refresh UI
            renderParticipants();
            renderActivities();
            initializeChart();
            
            showNotification('Wygenerowano dane testowe', 'success');
        }
        
        async function saveTestDataToFirebase() {
            try {
                // Clear existing collections
                const participantsSnapshot = await db.collection('participants').get();
                participantsSnapshot.forEach(doc => {
                    doc.ref.delete();
                });
                
                const activitiesSnapshot = await db.collection('activities').get();
                activitiesSnapshot.forEach(doc => {
                    doc.ref.delete();
                });
                
                // Add test participants
                for (const participant of appState.participants) {
                    await db.collection('participants').doc(participant.id).set(participant);
                }
                
                // Add test activities
                for (const activity of appState.activities) {
                    await db.collection('activities').doc(activity.id).set(activity);
                }
                
                return true;
            } catch (error) {
                console.error('Error saving test data:', error);
                return false;
            }
        }
        
        async function resetTestData() {
            try {
                // Clear existing collections
                const participantsSnapshot = await db.collection('participants').get();
                participantsSnapshot.forEach(doc => {
                    doc.ref.delete();
                });
                
                const activitiesSnapshot = await db.collection('activities').get();
                activitiesSnapshot.forEach(doc => {
                    doc.ref.delete();
                });
                
                // Reset app state
                appState.participants = [];
                appState.activities = [];
                appState.currentUser = null;
                
                // Clear localStorage
                localStorage.removeItem('participantId');
                
                // Reset UI
                elements.joinBtn.classList.remove('joined-btn');
                elements.joinBtn.textContent = 'Dołącz do wyzwania';
                
                // Refresh UI
                renderParticipants();
                renderActivities();
                initializeChart();
                
                showNotification('Zresetowano dane testowe', 'success');
                
                return true;
            } catch (error) {
                console.error('Error resetting test data:', error);
                showNotification('Wystąpił błąd podczas resetowania danych', 'error');
                return false;
            }
        }
        
        // Event Handlers
        function setupEventListeners() {
            // Join button click
            elements.joinBtn.addEventListener('click', () => {
                if (elements.joinBtn.classList.contains('joined-btn')) {
                    showNotification('Już uczestniczysz w wyzwaniu!', 'info');
                    return;
                }
                elements.joinModal.style.display = 'flex';
            });
            
            // Close join modal
            elements.closeJoinModalBtn.addEventListener('click', () => {
                elements.joinModal.style.display = 'none';
            });
            
            // Cancel join button
            elements.cancelJoinBtn.addEventListener('click', () => {
                elements.joinModal.style.display = 'none';
            });
            
            // Role selection
            const roleOptions = document.querySelectorAll('.role-option');
            roleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    roleOptions.forEach(o => o.classList.remove('selected'));
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    // Enable connect button
                    elements.connectStravaBtn.disabled = false;
                    // Store selected role
                    appState.selectedRole = option.dataset.role;
                });
            });
            
            // Connect Strava button
            elements.connectStravaBtn.addEventListener('click', () => {
                if (appState.selectedRole) {
                    elements.connectingStrava.style.display = 'block';
                    elements.roleSelection.style.display = 'none';
                    elements.connectStravaBtn.style.display = 'none';
                    
                    // In a real app, this would redirect to Strava
                    // For the demo, we'll simulate the authentication
                    setTimeout(() => {
                        elements.connectingStrava.style.display = 'none';
                        elements.joinModal.style.display = 'none';
                        
                        // Create fake participant for demo
                        const demoParticipant = {
                            id: 'participant_' + Date.now(),
                            name: 'Demo User',
                            avatar: '',
                            role: appState.selectedRole,
                            points: 0,
                            runDistance: 0,
                            rideDistance: 0,
                            joinDate: new Date().toISOString(),
                            badges: [],
                            level: 1
                        };
                        
                        // Save to Firebase and update UI
                        saveParticipantToFirebase(demoParticipant).then(() => {
                            localStorage.setItem('participantId', demoParticipant.id);
                            appState.currentUser = demoParticipant;
                            appState.participants.push(demoParticipant);
                            
                            elements.joinBtn.classList.add('joined-btn');
                            elements.joinBtn.textContent = 'Już uczestniczysz';
                            
                            renderParticipants();
                            initializeChart();
                            
                            showNotification('Pomyślnie dołączono do wyzwania!', 'success');
                        });
                    }, 2000);
                    
                    // In a real app, we would call connectWithStrava(appState.selectedRole);
                }
            });
            
            // Pagination buttons
            elements.prevPageBtn.addEventListener('click', () => {
                if (appState.currentPage > 1) {
                    appState.currentPage--;
                    renderActivities();
                }
            });
            
            elements.nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(appState.activities.length / appState.activitiesPerPage);
                if (appState.currentPage < totalPages) {
                    appState.currentPage++;
                    renderActivities();
                }
            });
            
            // Install banner
            elements.dismissBtn.addEventListener('click', () => {
                elements.installBanner.style.display = 'none';
                localStorage.setItem('installBannerDismissed', 'true');
            });
            
            elements.installBtn.addEventListener('click', () => {
                if (appState.deferredPrompt) {
                    appState.deferredPrompt.prompt();
                    appState.deferredPrompt.userChoice.then(choiceResult => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        } else {
                            console.log('User dismissed the install prompt');
                        }
                        appState.deferredPrompt = null;
                    });
                    
                    elements.installBanner.style.display = 'none';
                }
            });
            
            // Admin panel
            elements.adminLink.addEventListener('click', (e) => {
                e.preventDefault();
                elements.mainApp.style.display = 'none';
                elements.adminPanel.style.display = 'block';
            });
            
            elements.adminLoginBtn.addEventListener('click', () => {
                const password = elements.adminPassword.value;
                if (password === appState.adminPassword) {
                    elements.adminLogin.style.display = 'none';
                    elements.adminControls.style.display = 'block';
                    appState.isAdmin = true;
                    
                    // Set date inputs
                    elements.startDate.value = appState.challenge.startDate.toISOString().split('T')[0];
                    elements.endDate.value = appState.challenge.endDate.toISOString().split('T')[0];
                } else {
                    showNotification('Nieprawidłowe hasło', 'error');
                }
            });
            
            elements.saveDatesBtn.addEventListener('click', async () => {
                const startDate = new Date(elements.startDate.value);
                const endDate = new Date(elements.endDate.value);
                
                if (startDate && endDate && startDate < endDate) {
                    appState.challenge.startDate = startDate;
                    appState.challenge.endDate = endDate;
                    
                    await saveChallengeSettingsToFirebase();
                    updateCountdown();
                    initializeChart();
                    
                    showNotification('Zapisano daty wyzwania', 'success');
                } else {
                    showNotification('Nieprawidłowe daty', 'error');
                }
            });
            
            elements.generateTestDataBtn.addEventListener('click', () => {
                generateTestData();
            });
            
            elements.resetTestDataBtn.addEventListener('click', () => {
                resetTestData();
            });
            
            elements.toggleTestModeBtn.addEventListener('click', async () => {
                appState.challenge.testMode = !appState.challenge.testMode;
                await saveChallengeSettingsToFirebase();
                
                showNotification(`Tryb testowy ${appState.challenge.testMode ? 'włączony' : 'wyłączony'}`, 'success');
            });
        }
        
        // PWA Install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            appState.deferredPrompt = e;
            
            // Show the install banner if not previously dismissed
            if (!localStorage.getItem('installBannerDismissed')) {
                elements.installBanner.style.display = 'block';
            }
        });
        
        // App Initialization
        async function initApp() {
            setupEventListeners();
            await loadDataFromFirebase();
            updateCountdown();
            
            // Check for Strava callback
            handleStravaCallback();
            
            // Set up periodic data refresh (every hour)
            setInterval(async () => {
                await loadDataFromFirebase();
            }, 60 * 60 * 1000);
        }
        
        // Start the app
        initApp();
    </script>
</body>
</html>
