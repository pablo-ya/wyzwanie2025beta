<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#005dac">
    <meta name="description" content="Aplikacja do ≈õledzenia wyzwania sportowego 2025">
    <title>Wyzwanie 2025</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIld5endh
bmllIDIwMjUiLAogICJzaG9ydF9uYW1lIjogIld5endh
bmllIDIwMjUiLAogICJzdGFydF91cmwiOiAiaW5kZXgu
aHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIs
CiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAi
YmFja2dyb3VuZF9jb2xvciI6ICIjMDA1ZGFjIiwKICAi
dGhlbWVfY29sb3IiOiAiIzAwNWRhYyIsCiAgImljb25z
IjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1h
Z2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQw
aU1UQXdJaUJvWldsbmFIUTlJakV3TUNJZ2RtbGxkMEp2
ZUQwaU1DQXdJREV3TUNBeE1EQWlJSGh0Ykc1elBTSm9k
SFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5
SStQSEpsWTNRZ2QybGtkR2c5SWpFd01DSWdhR1ZwWjJo
MFBTSXhNREFpSUdacGJHdzlJaU13TURBM1pDSXZQanhu
SUhOMGVXeGxQU0ptYVd4c0xXTjBZV05sT21OcGNtTnNa
U0lnWm1sc2JEMGlJekF3TlRaa1l5SWdhbUZwYzNSMGVX
eGxQU0p5YjNWdVpDSWdkSEpoYm5ObWIzSnRQU0owY21G
dWMyWnZjbTBvTVRRMUxERTBOU2tpSUc5dVkzTnNhV05y
UFNKbGRtVnVkRjl2ZFhSbGNtVmtJaUIyWlhKMGFXTmhi
R0ZzYVdkdVBTSndZWFJvTFcxcFpHUXNkR1Y0ZENJdlBq
eHpkbWNnZDJsa2RHZzlJakUzT0NJZ2FHVnBaMmgwUFNJ
eE56Z2lJSFpwWlhkQ2IzZzlJakFnTUNBeE56Z2dNVGM0
SWlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZj
bWN2TWpBd01DOXpkbWNpUGp4eVpXTjBJSGRwWkhSb1BT
SXhOemdpSUdobGFXZG9kRDBpTVRjNElpQm1hV3hzUFNJ
ak1EQXdNRFprSWk4K1BITndZVzRnWm1sc2JEMGlJekF3
TURCRVRRPT0iLAogICAgICAic2l6ZXMiOiAiMTgweDE4
MCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwi
CiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6
aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1Iw
YUQwaU1USXdJaUJvWldsbmFIUTlJakV5TUNJZ2RtbGxk
MEp2ZUQwaU1DQXdJREV5TUNBeE1qQWlJSGh0Ykc1elBT
Sm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNO
Mlp5SStQSEpsWTNRZ2QybGtkR2c5SWpFeU1DSWdhR1Zw
WjJoMFBTSXhNakFpSUdacGJHdzlJaU13TURBM1pDSXZQ
anhuSUhOMGVXeGxQU0ptYVd4c0xXTjBZV05sT21OcGNt
TnNaU0lnWm1sc2JEMGlJekF3TlRaa1l5SWdhbUZwYzNS
MGVXeGxQU0p5YjNWdVpDSWdkSEpoYm5ObWIzSnRQU0ow
Y21GdWMyWnZjbTBvTVRRMUxERTBOU2tpSUc5dVkzTnNh
V05yUFNKbGRtVnVkRjl2ZFhSbGNtVmtJaUIyWlhKMGFX
TmhiR0ZzYVdkdVBTSndZWFJvTFcxcFpHUXNkR1Y0ZENJ
dlBqeHpkbWNnZDJsa2RHZzlJakV6T0NJZ2FHVnBaMmgw
UFNJeE16Z2lJSFpwWlhkQ2IzZzlJakFnTUNBeE16Z2dN
VE00SWlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015
NXZjbWN2TWpBd01DOXpkbWNpUGp4eVpXTjBJSGRwWkhS
b1BTSXhNemdpSUdobGFXZG9kRDBpTVRNNElpQm1hV3hz
UFNJak1EQXdNRFprSWk4K1BITndZVzRnWm1sc2JEMGlJ
ekF3TURCRVRRPT0iLAogICAgICAic2l6ZXMiOiAiMTIw
eDEyMCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4
bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRh
dGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNh
V1IwYUQwaU5qUWlJR2hsYVdkb2REMGlOalFpSUhacFpY
ZENiM2c5SWpBZ01DQTJOQzQwSURZMExqUWlJSGh0Ykc1
elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3
TDNOMlp5SStQSEpsWTNRZ2QybGtkR2c5SWpZMElpQm9a
V2xuYUhROUlqWTBJaUJtYVd4c1BTSWpNREF3TURaa0lp
OCtQR2NnYzNSNWJHVTlJbVpwYkd3dFkzUmhZMlU2WTJs
eVkyeGxJaUJtYVd4c1BTSWpNREExTm1SaklpQnFZV2x6
ZEhSNWJHVTlJbkp2ZFc1a0lpQjBjbUZ1YzJadmNtMDlJ
blJ5WVc1elptOXliU2d4TkRVc01UUTFLVElpSUc5dVkz
TnNhV05yUFNKbGRtVnVkRjl2ZFhSbGNtVmtJaUIyWlhK
MGFXTmhiR0ZzYVdkdVBTSndZWFJvTFcxcFpHUXNkR1Y0
ZENJdlBqeHpkbWNnZDJsa2RHZzlJall3SWlCb1pXbG5h
SFE5SWpZd0lpQjJhV1YzUW05NFBTSXdJREFnTmpBZ05q
QWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05
eVp5OHlNREF3TDNOMlp5SStQSEpsWTNRZ2QybGtkR2c5
SWpZd0lpQm9aV2xuYUhROUlqWXdJaUJtYVd4c1BTSWpN
REF3TURaa0lpOCtQSE53WVc0Z1ptbHNiRDBpSXpBd01E
QkVUUT09IiwKICAgICAgInNpemVzIjogIjY0eDY0Iiwg
CiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAg
ICB9CiAgXQp9">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiMwMDAwMDYiLz48ZyBzdHlsZT0iZmlsbC1jdGFjZTpjaXJjbGUiIGZpbGw9IiMwMDVkYWMiIGphaXN0dHlsZT0icm91bmQiIHRyYW5zZm9ybT0idHJhbnNmb3JtKDE0NSwxNDUpIiBvbmNsaWNrPSJldmVudF9vdXRlcmVkIiB2ZXJ0aWNhbGFsaWduPSJwYXRoLW1pZGQsdGV4dCI+PC9nPjxzdmcgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiB2aWV3Qm94PSIwIDAgNjAgNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjMDAwMDA2Ii8+PHNwYW4gZmlsbD0iIzAwMDBETQ==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIGZpbGw9IiMwMDAwMDYiLz48ZyBzdHlsZT0iZmlsbC1jdGFjZTpjaXJjbGUiIGZpbGw9IiMwMDVkYWMiIGphaXN0dHlsZT0icm91bmQiIHRyYW5zZm9ybT0idHJhbnNmb3JtKDE0NSwxNDUpIiBvbmNsaWNrPSJldmVudF9vdXRlcmVkIiB2ZXJ0aWNhbGFsaWduPSJwYXRoLW1pZGQsdGV4dCI+PC9nPjxzdmcgd2lkdGg9IjE3OCIgaGVpZ2h0PSIxNzgiIHZpZXdCb3g9IjAgMCAxNzggMTc4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNzgiIGhlaWdodD0iMTc4IiBmaWxsPSIjMDAwMDA2Ii8+PHNwYW4gZmlsbD0iIzAwMDBETQ==">

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        :root {
            --primary-color: #005dac;
            --secondary-color: #1cb954;
            --text-color: #343434;
            --light-text: #6e6e6e;
            --background-color: #f5f5f5;
            --card-background: #ffffff;
            --runner-color: #FF5722;
            --cyclist-color: #2196F3;
            --combined-color: #9C27B0;
            --gold-color: #FFD700;
            --silver-color: #C0C0C0;
            --bronze-color: #CD7F32;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.15);
            --radius: 8px;
            --header-height: 60px;
            --footer-height: 50px;
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #0073d8;
                --secondary-color: #22d466;
                --text-color: #f0f0f0;
                --light-text: #c0c0c0;
                --background-color: #121212;
                --card-background: #212121;
                --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                --card-shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.4);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            padding: calc(var(--header-height) + var(--safe-area-inset-top)) 0 calc(var(--footer-height) + var(--safe-area-inset-bottom)) 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        body.standalone {
            padding-bottom: calc(var(--footer-height) + var(--safe-area-inset-bottom) + 30px);
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            height: calc(var(--header-height) + var(--safe-area-inset-top));
            padding-top: var(--safe-area-inset-top);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        main {
            flex: 1;
            padding: 16px;
            padding-left: calc(16px + var(--safe-area-inset-left));
            padding-right: calc(16px + var(--safe-area-inset-right));
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            height: calc(var(--footer-height) + var(--safe-area-inset-bottom));
            padding-bottom: var(--safe-area-inset-bottom);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        }

        .mobile-nav {
            display: none;
        }

        body.standalone .mobile-nav {
            display: flex;
            position: fixed;
            bottom: var(--safe-area-inset-bottom);
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--card-background);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .mobile-nav-buttons {
            display: flex;
            width: 100%;
            height: 100%;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.7rem;
            padding: 5px;
            width: 25%;
        }

        .mobile-nav-btn i {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }

        .mobile-nav-btn.active {
            color: var(--primary-color);
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        p {
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .section {
            background-color: var(--card-background);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
        }

        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title i {
            margin-right: 8px;
            color: var(--primary-color);
            font-size: 1.4rem;
        }

        .btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-secondary {
            background-color: var(--primary-color);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Rules section */
        .rules {
            margin-bottom: 24px;
        }

        .countdown {
            margin-top: 16px;
            margin-bottom: 24px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .countdown i {
            margin-right: 8px;
        }

        .join-btn-container {
            display: flex;
            justify-content: center;
            margin: 24px 0;
        }

        /* Progress Chart */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 24px;
        }

        /* Participants */
        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .participant-card {
            background-color: var(--card-background);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            position: relative;
        }

        .participant-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--card-shadow-hover);
        }

        .participant-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .participant-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--light-text);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .rank-1 {
            background-color: var(--gold-color);
            color: black;
        }

        .rank-2 {
            background-color: var(--silver-color);
            color: black;
        }

        .rank-3 {
            background-color: var(--bronze-color);
            color: white;
        }

        .participant-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 3px solid transparent;
            cursor: pointer;
        }

        .runner .participant-avatar {
            border-color: var(--runner-color);
        }

        .cyclist .participant-avatar {
            border-color: var(--cyclist-color);
        }

        .combined .participant-avatar {
            border-color: var(--combined-color);
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .participant-role {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 4px;
            color: white;
        }

        .runner .participant-role {
            background-color: var(--runner-color);
        }

        .cyclist .participant-role {
            background-color: var(--cyclist-color);
        }

        .combined .participant-role {
            background-color: var(--combined-color);
        }

        .participant-stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
        }

        .stat-label {
            color: var(--light-text);
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 600;
        }

        .progress-container {
            margin-top: 12px;
        }

        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .runner .progress-fill {
            background-color: var(--runner-color);
        }

        .cyclist .progress-fill {
            background-color: var(--cyclist-color);
        }

        .combined .progress-fill {
            background-color: var(--combined-color);
        }

        .progress-label {
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            color: var(--light-text);
        }

        /* Activity list */
        .activities-container {
            margin-bottom: 24px;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
        }

        .run-icon {
            background-color: var(--runner-color);
        }

        .ride-icon {
            background-color: var(--cyclist-color);
        }

        .activity-details {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            cursor: pointer;
        }

        .activity-meta {
            display: flex;
            color: var(--light-text);
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .activity-meta div {
            margin-right: 12px;
        }

        .activity-meta .participant-name {
            cursor: pointer;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 8px;
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .page-btn:disabled {
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--card-background);
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.visible .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Role selection */
        .role-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .role-card {
            border: 2px solid transparent;
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .role-card:hover {
            transform: translateY(-2px);
        }

        .role-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 93, 172, 0.05);
        }

        .role-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .runner-role .role-icon {
            color: var(--runner-color);
        }

        .cyclist-role .role-icon {
            color: var(--cyclist-color);
        }

        .combined-role .role-icon {
            color: var(--combined-color);
        }

        .role-name {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .role-description {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 93, 172, 0.2);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Badges and Achievements */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .badge-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: var(--card-background);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            box-shadow: var(--shadow);
            position: relative;
            color: var(--light-text);
        }

        .badge-icon i {
            font-size: 1.8rem;
        }

        .badge.unlocked .badge-icon {
            color: var(--primary-color);
            background-color: rgba(0, 93, 172, 0.1);
        }

        .badge-title {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .badge-description {
            font-size: 0.7rem;
            color: var(--light-text);
        }

        /* Heat Map */
        .heat-map {
            margin-top: 24px;
        }

        .heat-map-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .heat-map-label {
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .heat-map-day {
            text-align: center;
            font-size: 0.7rem;
            color: var(--light-text);
        }

        .heat-map-week {
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 4px;
        }

        .heat-map-week-label {
            font-size: 0.7rem;
            color: var(--light-text);
            display: flex;
            align-items: center;
        }

        .heat-map-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            background-color: #eee;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .heat-map-cell:hover {
            transform: scale(1.1);
        }

        .heat-cell-0 { background-color: #eee; }
        .heat-cell-1 { background-color: #c6e48b; }
        .heat-cell-2 { background-color: #7bc96f; }
        .heat-cell-3 { background-color: #239a3b; }
        .heat-cell-4 { background-color: #196127; }

        /* Level badges */
        .level-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--card-background);
        }

        /* Avatar frames */
        .avatar-frame-1 {
            border: 3px solid #c6e48b;
        }

        .avatar-frame-2 {
            border: 3px solid #7bc96f;
        }

        .avatar-frame-3 {
            border: 3px solid #239a3b;
        }

        .avatar-frame-4 {
            border: 3px solid #196127;
        }

        .avatar-frame-5 {
            border: 3px solid gold;
            box-shadow: 0 0 10px gold;
        }

        /* Streak badges */
        .streak-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: var(--primary-color);
            color: white;
            font-size: 0.7rem;
            padding: 3px 6px;
            border-radius: 12px;
            display: flex;
            align-items: center;
        }

        .streak-badge i {
            font-size: 0.8rem;
            margin-right: 3px;
        }

        /* High five button */
        .high-five-btn {
            background: none;
            border: none;
            color: var(--light-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            margin-top: 12px;
        }

        .high-five-btn i {
            margin-right: 4px;
        }

        .high-five-btn:hover {
            color: var(--primary-color);
        }

        .high-five-count {
            margin-left: 4px;
            background-color: rgba(0, 93, 172, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* Install Banner */
        .install-banner {
            position: fixed;
            bottom: calc(var(--footer-height) + var(--safe-area-inset-bottom));
            left: 0;
            right: 0;
            background-color: var(--card-background);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 900;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .install-banner.visible {
            transform: translateY(0);
        }

        .install-message {
            flex: 1;
            margin-right: 12px;
        }

        .install-actions {
            display: flex;
            gap: 8px;
        }

        /* Admin panel */
        .admin-panel {
            background-color: var(--card-background);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--card-shadow);
            margin-bottom: 24px;
            display: none;
        }

        .admin-section {
            margin-bottom: 24px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }

        .admin-card {
            background-color: var(--card-background);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius);
            padding: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        /* Confetti animation */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            pointer-events: none;
            animation: confetti-fall 5s linear forwards, confetti-shake 3s ease-in-out infinite;
        }

        @keyframes confetti-fall {
            0% { top: -10%; opacity: 1; }
            80% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        @keyframes confetti-shake {
            0% { transform: skew(0deg, 0deg); }
            25% { transform: skew(5deg, 5deg); }
            50% { transform: skew(0deg, 0deg); }
            75% { transform: skew(-5deg, 5deg); }
            100% { transform: skew(0deg, 0deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: calc(var(--header-height) + var(--safe-area-inset-top) + 20px);
            right: 20px;
            background-color: var(--card-background);
            color: var(--text-color);
            padding: 12px 16px;
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            z-index: 1500;
            max-width: 350px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .notification.visible {
            transform: translateX(0);
        }

        .notification-content {
            display: flex;
            align-items: center;
        }

        .notification-icon {
            margin-right: 12px;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .notification-message {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        /* Debug overlay */
        #debug-overlay {
            position: fixed;
            bottom: 60px;
            left: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 10000;
            overflow-y: auto;
            max-height: 200px;
            display: none;
        }

        #debug-overlay pre {
            margin: 0;
            white-space: pre-wrap;
        }

        #debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 10001;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            opacity: 0.7;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .participants-grid {
                grid-template-columns: 1fr;
            }
            
            .role-selection {
                grid-template-columns: 1fr;
            }

            .achievement-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) {
            .achievement-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Font Awesome Icons */
        .fa {
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            line-height: 1;
        }

        .fa-running:before { content: "üèÉ"; }
        .fa-biking:before { content: "üö¥"; }
        .fa-medal:before { content: "üèÖ"; }
        .fa-chart-line:before { content: "üìà"; }
        .fa-users:before { content: "üë•"; }
        .fa-history:before { content: "üïí"; }
        .fa-clock:before { content: "‚è∞"; }
        .fa-calendar:before { content: "üìÖ"; }
        .fa-user-plus:before { content: "üë§+"; }
        .fa-check:before { content: "‚úì"; }
        .fa-times:before { content: "‚úï"; }
        .fa-trophy:before { content: "üèÜ"; }
        .fa-fire:before { content: "üî•"; }
        .fa-bolt:before { content: "‚ö°"; }
        .fa-star:before { content: "‚≠ê"; }
        .fa-heart:before { content: "‚ù§Ô∏è"; }
        .fa-home:before { content: "üè†"; }
        .fa-user:before { content: "üë§"; }
        .fa-badge:before { content: "üî∞"; }
        .fa-list:before { content: "üìã"; }
        .fa-download:before { content: "‚¨áÔ∏è"; }
        .fa-times-circle:before { content: "‚ùå"; }
        .fa-hand-paper:before { content: "‚úã"; }
        .fa-bell:before { content: "üîî"; }
        .fa-wrench:before { content: "üîß"; }
        .fa-lock:before { content: "üîí"; }
        .fa-info-circle:before { content: "‚ÑπÔ∏è"; }
        .fa-calendar-check:before { content: "üìÜ‚úì"; }
        .fa-sunrise:before { content: "üåÖ"; }
        .fa-moon:before { content: "üåô"; }
        .fa-mountain:before { content: "üèîÔ∏è"; }
        .fa-tachometer-alt:before { content: "üèÅ"; }
        .fa-stopwatch:before { content: "‚è±Ô∏è"; }
        .fa-map-marker:before { content: "üìç"; }
        .fa-chevron-left:before { content: "‚óÄ"; }
        .fa-chevron-right:before { content: "‚ñ∂"; }
        .fa-bug:before { content: "üêõ"; }
    </style>
</head>
<body>
    <!-- Debug tools -->
    <div id="debug-overlay"></div>
    <button id="debug-toggle">Debug</button>

    <header>
        <h1>Wyzwanie 2025</h1>
    </header>

    <main>
        <!-- Rules and Countdown Section -->
        <section id="rules" class="section rules">
            <div class="section-title">
                <i class="fa fa-info-circle"></i>
                <h2>Zasady wyzwania</h2>
            </div>
            <p>
                Witaj w sportowym wyzwaniu 2025! Celem jest zdobycie <strong>2000 punkt√≥w</strong> jako pierwszy lub zgromadzenie najwiƒôkszej liczby punkt√≥w do ko≈Ñca wyzwania.
            </p>
            <ul>
                <li>Wyzwanie trwa od <strong>1 kwietnia do 30 wrze≈õnia 2025</strong>.</li>
                <li>Masz trzy opcje udzia≈Çu: jako <strong>biegacz</strong> (2 punkty/km), <strong>rowerzysta</strong> (1 punkt/km) lub <strong>biegacz+rowerzysta</strong> (punkty z obu aktywno≈õci).</li>
                <li>Po wyborze roli, nie mo≈ºesz jej zmieniƒá podczas wyzwania.</li>
                <li>Wszystkie aktywno≈õci sƒÖ automatycznie pobierane z Twojego konta Strava.</li>
            </ul>
            <div class="countdown">
                <i class="fa fa-clock"></i>
                <span id="countdown-timer">Trwa ≈Çadowanie...</span>
            </div>
            
            <div class="join-btn-container">
                <button id="join-btn" class="btn">
                    <i class="fa fa-user-plus"></i>
                    Do≈ÇƒÖcz do wyzwania
                </button>
            </div>
        </section>

        <!-- Progress Chart Section -->
        <section id="progress" class="section">
            <div class="section-title">
                <i class="fa fa-chart-line"></i>
                <h2>Postƒôp wszystkich uczestnik√≥w</h2>
            </div>
            <div class="chart-container">
                <canvas id="progress-chart"></canvas>
            </div>
        </section>

        <!-- Participants Section -->
        <section id="participants" class="section">
            <div class="section-title">
                <i class="fa fa-users"></i>
                <h2>Ranking uczestnik√≥w</h2>
            </div>
            <div id="participants-grid" class="participants-grid">
                <!-- Participants will be dynamically added here -->
                <div class="loading">
                    <div class="spinner"></div>
                    <p>≈Åadowanie uczestnik√≥w...</p>
                </div>
            </div>
        </section>

        <!-- Recent Activities Section -->
        <section id="activities" class="section activities-container">
            <div class="section-title">
                <i class="fa fa-history"></i>
                <h2>Ostatnie aktywno≈õci</h2>
            </div>
            <ul id="activity-list" class="activity-list">
                <!-- Activities will be dynamically added here -->
                <div class="loading">
                    <div class="spinner"></div>
                    <p>≈Åadowanie aktywno≈õci...</p>
                </div>
            </ul>
            <div class="pagination">
                <button id="prev-page" class="page-btn" disabled>
                    <i class="fa fa-chevron-left"></i> Poprzednia
                </button>
                <button id="next-page" class="page-btn" disabled>
                    Nastƒôpna <i class="fa fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Admin Panel Link -->
        <p style="text-align: center; margin-top: 20px;">
            <a href="#" id="admin-link">Panel administratora</a>
        </p>
    </main>

    <footer>
        <p>&copy; 2025 Wyzwanie 2025</p>
    </footer>

    <!-- Mobile Navigation for PWA -->
    <div class="mobile-nav">
        <div class="mobile-nav-buttons">
            <a href="#rules" class="mobile-nav-btn active">
                <i class="fa fa-info-circle"></i>
                <span>Zasady</span>
            </a>
            <a href="#progress" class="mobile-nav-btn">
                <i class="fa fa-chart-line"></i>
                <span>Postƒôp</span>
            </a>
            <a href="#participants" class="mobile-nav-btn">
                <i class="fa fa-users"></i>
                <span>Ranking</span>
            </a>
            <a href="#activities" class="mobile-nav-btn">
                <i class="fa fa-history"></i>
                <span>Aktywno≈õci</span>
            </a>
        </div>
    </div>

    <!-- Join Modal -->
    <div id="join-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Do≈ÇƒÖcz do wyzwania</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Wybierz swojƒÖ rolƒô w wyzwaniu. Pamiƒôtaj, ≈ºe tego wyboru nie mo≈ºna zmieniƒá p√≥≈∫niej!</p>
                
                <div class="role-selection">
                    <div class="role-card runner-role" data-role="runner">
                        <div class="role-icon">
                            <i class="fa fa-running"></i>
                        </div>
                        <div class="role-name">Biegacz</div>
                        <div class="role-description">2 punkty za ka≈ºdy przebiegniƒôty kilometr</div>
                    </div>
                    
                    <div class="role-card cyclist-role" data-role="cyclist">
                        <div class="role-icon">
                            <i class="fa fa-biking"></i>
                        </div>
                        <div class="role-name">Rowerzysta</div>
                        <div class="role-description">1 punkt za ka≈ºdy przejechany kilometr</div>
                    </div>
                    
                    <div class="role-card combined-role" data-role="combined">
                        <div class="role-icon">
                            <i class="fa fa-running"></i>
                            <i class="fa fa-biking"></i>
                        </div>
                        <div class="role-name">Biegacz + Rowerzysta</div>
                        <div class="role-description">Punkty z obu aktywno≈õci</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="connect-strava-btn" class="btn btn-secondary" disabled>
                    Po≈ÇƒÖcz ze Strava
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="modal-overlay">
        <div class="modal">
            <div class="loading">
                <div class="spinner"></div>
                <p id="loading-message">≈ÅƒÖczenie z kontem Strava...</p>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Panel administratora</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="admin-login">
                    <div class="form-group">
                        <label for="admin-password">Has≈Ço administratora:</label>
                        <input type="password" id="admin-password" placeholder="Wprowad≈∫ has≈Ço">
                    </div>
                    <button id="admin-login-btn" class="btn">Zaloguj</button>
                </div>
                
                <div id="admin-panel" class="admin-panel">
                    <div class="admin-section">
                        <div class="admin-header">
                            <h3>Ustawienia wyzwania</h3>
                        </div>
                        <div class="admin-grid">
                            <div class="admin-card">
                                <div class="form-group">
                                    <label for="challenge-start">Data rozpoczƒôcia:</label>
                                    <input type="date" id="challenge-start" value="2025-04-01">
                                </div>
                                <div class="form-group">
                                    <label for="challenge-end">Data zako≈Ñczenia:</label>
                                    <input type="date" id="challenge-end" value="2025-09-30">
                                </div>
                                <button id="save-dates-btn" class="btn btn-outline">Zapisz daty</button>
                            </div>
                            
                            <div class="admin-card">
                                <div class="form-group">
                                    <label for="test-mode">Tryb testowy:</label>
                                    <select id="test-mode">
                                        <option value="0">Wy≈ÇƒÖczony</option>
                                        <option value="1">W≈ÇƒÖczony</option>
                                    </select>
                                </div>
                                <button id="toggle-test-btn" class="btn btn-outline">Zastosuj</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <div class="admin-header">
                            <h3>Dane testowe</h3>
                        </div>
                        <div class="admin-grid">
                            <div class="admin-card">
                                <div class="form-group">
                                    <label for="test-users">Liczba uczestnik√≥w testowych:</label>
                                    <input type="number" id="test-users" min="1" max="20" value="5">
                                </div>
                                <button id="generate-data-btn" class="btn btn-outline">Generuj dane</button>
                            </div>
                            
                            <div class="admin-card">
                                <div class="form-group">
                                    <label>Resetowanie:</label>
                                </div>
                                <button id="reset-data-btn" class="btn btn-outline">Resetuj dane testowe</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Install Banner -->
    <div id="install-banner" class="install-banner">
        <div class="install-message">
            <strong>Zainstaluj aplikacjƒô Wyzwanie 2025</strong>
            <p>Dodaj do ekranu g≈Ç√≥wnego dla lepszego do≈õwiadczenia!</p>
        </div>
        <div class="install-actions">
            <button id="install-btn" class="btn">
                <i class="fa fa-download"></i> Zainstaluj
            </button>
            <button id="close-install-btn" class="btn btn-outline">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <div class="notification-icon">
                <i class="fa fa-info-circle"></i>
            </div>
            <div class="notification-message">
                <div class="notification-title">Tytu≈Ç powiadomienia</div>
                <div id="notification-text">Tre≈õƒá powiadomienia</div>
            </div>
        </div>
    </div>

    <!-- Confetti Container -->
    <div id="confetti-container" class="confetti-container"></div>

    <script>
        // Debugging tools
        const debugElement = document.getElementById('debug-overlay');
        const debugToggle = document.getElementById('debug-toggle');
        let debugEnabled = false;

        // Enable debug mode with 3 taps on the header
        let tapCount = 0;
        const header = document.querySelector('header');
        header.addEventListener('click', () => {
            tapCount++;
            if (tapCount >= 3) {
                debugEnabled = !debugEnabled;
                debugElement.style.display = debugEnabled ? 'block' : 'none';
                debugToggle.style.display = debugEnabled ? 'block' : 'none';
                debug('Debug mode ' + (debugEnabled ? 'activated' : 'deactivated'));
                tapCount = 0;
            }
            setTimeout(() => { tapCount = 0 }, 500);
        });

        debugToggle.addEventListener('click', () => {
            debugEnabled = !debugEnabled;
            debugElement.style.display = debugEnabled ? 'block' : 'none';
            debug('Debug mode ' + (debugEnabled ? 'activated' : 'deactivated'));
        });

        function debug(message, obj = null) {
            if (debugEnabled) {
                const timestamp = new Date().toISOString().substring(11, 23);
                let logMessage = `[${timestamp}] ${message}`;
                
                if (obj) {
                    try {
                        logMessage += '\n' + JSON.stringify(obj, null, 2);
                    } catch (e) {
                        logMessage += '\n[Object cannot be stringified]';
                    }
                }
                
                console.log(logMessage);
                
                const pre = document.createElement('pre');
                pre.textContent = logMessage;
                debugElement.appendChild(pre);
                debugElement.scrollTop = debugElement.scrollHeight;
            }
        }

        // Tryb testowy Firebase (do zastƒÖpienia prawid≈ÇowƒÖ konfiguracjƒÖ)
        const firebaseConfig = {
  apiKey: "AIzaSyCxOfhKBNyIzhkkkiHOhXd3x3mfSUMS6M4",
  authDomain: "wyzwanie2025-a6298.firebaseapp.com",
  projectId: "wyzwanie2025-a6298",
  storageBucket: "wyzwanie2025-a6298.firebasestorage.app",
  messagingSenderId: "74567179841",
  appId: "1:74567179841:web:e7bb1c6f12fc64ef5730c0",
  measurementId: "G-D63RBL1K8E"
        };

        // Uproszczona implementacja dla testowania
        let localFirestore = {
            participants: [],
            activities: [],
            settings: {
                startDate: new Date('2025-04-01').toISOString(),
                endDate: new Date('2025-09-30').toISOString(),
                testMode: true
            }
        };

        // Firebase Database Manager with fallback
        class FirebaseManager {
            constructor() {
                this.useLocalFallback = true;
                this.db = null;
                this.auth = null;
                
                // Try to initialize Firebase
                try {
                    debug('Initializing Firebase');
                    firebase.initializeApp(firebaseConfig);
                    this.db = firebase.firestore();
                    this.auth = firebase.auth();
                    this.useLocalFallback = false;
                    debug('Firebase initialized successfully');
                    
                    // Enable offline persistence if Firebase is working
                    this.db.enablePersistence()
                        .then(() => {
                            debug('Firebase offline persistence enabled');
                        })
                        .catch(err => {
                            debug('Firebase persistence error:', err);
                        });
                } catch (error) {
                    debug('Firebase initialization error - using local fallback:', error);
                    this.showNotification("U≈ºywam trybu lokalnego", "Firebase nie jest skonfigurowany lub niedostƒôpny. Dane bƒôdƒÖ przechowywane lokalnie.", "warning");
                }
            }
            
            // Helper to check if we should use local fallback
            _shouldUseLocalFallback() {
                return this.useLocalFallback || !this.db;
            }
            
            // Authentication methods
            async signInAnonymously() {
                if (this._shouldUseLocalFallback()) {
                    debug('Using local fallback for anonymous auth');
                    return { user: { uid: 'local-' + Date.now() } };
                }
                
                try {
                    debug('Attempting Firebase anonymous sign-in');
                    return await this.auth.signInAnonymously();
                } catch (error) {
                    debug('Anonymous sign-in error:', error);
                    this.useLocalFallback = true;
                    return { user: { uid: 'local-' + Date.now() } };
                }
            }
            
            // Participants methods
            async saveParticipant(participant) {
                debug('Saving participant', participant);
                if (this._shouldUseLocalFallback()) {
                    const existingIndex = localFirestore.participants.findIndex(p => p.id === participant.id);
                    if (existingIndex >= 0) {
                        localFirestore.participants[existingIndex] = participant;
                    } else {
                        localFirestore.participants.push(participant);
                    }
                    localStorage.setItem('wyzwanie2025_participants', JSON.stringify(localFirestore.participants));
                    return true;
                }
                
                try {
                    await this.db.collection('participants').doc(participant.id).set(participant);
                    return true;
                } catch (error) {
                    debug('Save participant error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.saveParticipant(participant);
                }
            }
            
            async getParticipants() {
                debug('Getting participants');
                if (this._shouldUseLocalFallback()) {
                    const storedParticipants = localStorage.getItem('wyzwanie2025_participants');
                    if (storedParticipants) {
                        localFirestore.participants = JSON.parse(storedParticipants);
                    }
                    return localFirestore.participants;
                }
                
                try {
                    const snapshot = await this.db.collection('participants').get();
                    return snapshot.docs.map(doc => doc.data());
                } catch (error) {
                    debug('Get participants error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.getParticipants();
                }
            }
            
            async updateParticipant(participantId, data) {
                debug(`Updating participant ${participantId}`, data);
                if (this._shouldUseLocalFallback()) {
                    const existingIndex = localFirestore.participants.findIndex(p => p.id === participantId);
                    if (existingIndex >= 0) {
                        localFirestore.participants[existingIndex] = {
                            ...localFirestore.participants[existingIndex],
                            ...data
                        };
                        localStorage.setItem('wyzwanie2025_participants', JSON.stringify(localFirestore.participants));
                    }
                    return true;
                }
                
                try {
                    await this.db.collection('participants').doc(participantId).update(data);
                    return true;
                } catch (error) {
                    debug('Update participant error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.updateParticipant(participantId, data);
                }
            }
            
            // Activities methods
            async saveActivity(activity) {
                debug('Saving activity', activity);
                if (this._shouldUseLocalFallback()) {
                    const existingIndex = localFirestore.activities.findIndex(a => a.id === activity.id);
                    if (existingIndex >= 0) {
                        localFirestore.activities[existingIndex] = activity;
                    } else {
                        localFirestore.activities.push(activity);
                    }
                    localStorage.setItem('wyzwanie2025_activities', JSON.stringify(localFirestore.activities));
                    return true;
                }
                
                try {
                    await this.db.collection('activities').doc(activity.id).set(activity);
                    return true;
                } catch (error) {
                    debug('Save activity error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.saveActivity(activity);
                }
            }
            
            async saveActivities(activities) {
                debug(`Saving ${activities.length} activities`);
                if (this._shouldUseLocalFallback()) {
                    activities.forEach(activity => {
                        const existingIndex = localFirestore.activities.findIndex(a => a.id === activity.id);
                        if (existingIndex >= 0) {
                            localFirestore.activities[existingIndex] = activity;
                        } else {
                            localFirestore.activities.push(activity);
                        }
                    });
                    localStorage.setItem('wyzwanie2025_activities', JSON.stringify(localFirestore.activities));
                    return true;
                }
                
                try {
                    const batch = this.db.batch();
                    
                    activities.forEach(activity => {
                        const ref = this.db.collection('activities').doc(activity.id);
                        batch.set(ref, activity);
                    });
                    
                    await batch.commit();
                    return true;
                } catch (error) {
                    debug('Save activities batch error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.saveActivities(activities);
                }
            }
            
            async getActivities() {
                debug('Getting activities');
                if (this._shouldUseLocalFallback()) {
                    const storedActivities = localStorage.getItem('wyzwanie2025_activities');
                    if (storedActivities) {
                        localFirestore.activities = JSON.parse(storedActivities);
                    }
                    return localFirestore.activities;
                }
                
                try {
                    const snapshot = await this.db.collection('activities').get();
                    return snapshot.docs.map(doc => doc.data());
                } catch (error) {
                    debug('Get activities error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.getActivities();
                }
            }
            
            async updateActivity(activityId, data) {
                debug(`Updating activity ${activityId}`, data);
                if (this._shouldUseLocalFallback()) {
                    const existingIndex = localFirestore.activities.findIndex(a => a.id === activityId);
                    if (existingIndex >= 0) {
                        localFirestore.activities[existingIndex] = {
                            ...localFirestore.activities[existingIndex],
                            ...data
                        };
                        localStorage.setItem('wyzwanie2025_activities', JSON.stringify(localFirestore.activities));
                    }
                    return true;
                }
                
                try {
                    await this.db.collection('activities').doc(activityId).update(data);
                    return true;
                } catch (error) {
                    debug('Update activity error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.updateActivity(activityId, data);
                }
            }
            
            // Settings methods
            async saveSettings(settings) {
                debug('Saving settings', settings);
                if (this._shouldUseLocalFallback()) {
                    localFirestore.settings = settings;
                    localStorage.setItem('wyzwanie2025_settings', JSON.stringify(settings));
                    return true;
                }
                
                try {
                    await this.db.collection('settings').doc('challenge').set(settings);
                    return true;
                } catch (error) {
                    debug('Save settings error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.saveSettings(settings);
                }
            }
            
            async getSettings() {
                debug('Getting settings');
                if (this._shouldUseLocalFallback()) {
                    const storedSettings = localStorage.getItem('wyzwanie2025_settings');
                    if (storedSettings) {
                        localFirestore.settings = JSON.parse(storedSettings);
                    }
                    return localFirestore.settings;
                }
                
                try {
                    const doc = await this.db.collection('settings').doc('challenge').get();
                    if (doc.exists) {
                        return doc.data();
                    } else {
                        return null;
                    }
                } catch (error) {
                    debug('Get settings error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.getSettings();
                }
            }
            
            // Listen for changes in realtime - simplified for local fallback
            onParticipantsChange(callback) {
                debug('Setting up participants listener');
                if (this._shouldUseLocalFallback()) {
                    // For local fallback, we'll just call the callback once with current data
                    const storedParticipants = localStorage.getItem('wyzwanie2025_participants');
                    if (storedParticipants) {
                        localFirestore.participants = JSON.parse(storedParticipants);
                        callback(localFirestore.participants);
                    }
                    // Return a dummy unsubscribe function
                    return () => {};
                }
                
                try {
                    return this.db.collection('participants')
                        .onSnapshot(snapshot => {
                            const participants = snapshot.docs.map(doc => doc.data());
                            callback(participants);
                        }, error => {
                            debug('Participants listener error, falling back to local:', error);
                            this.useLocalFallback = true;
                            return this.onParticipantsChange(callback);
                        });
                } catch (error) {
                    debug('Setting up participants listener error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.onParticipantsChange(callback);
                }
            }
            
            onActivitiesChange(callback) {
                debug('Setting up activities listener');
                if (this._shouldUseLocalFallback()) {
                    // For local fallback, we'll just call the callback once with current data
                    const storedActivities = localStorage.getItem('wyzwanie2025_activities');
                    if (storedActivities) {
                        localFirestore.activities = JSON.parse(storedActivities);
                        callback(localFirestore.activities);
                    }
                    // Return a dummy unsubscribe function
                    return () => {};
                }
                
                try {
                    return this.db.collection('activities')
                        .onSnapshot(snapshot => {
                            const activities = snapshot.docs.map(doc => doc.data());
                            callback(activities);
                        }, error => {
                            debug('Activities listener error, falling back to local:', error);
                            this.useLocalFallback = true;
                            return this.onActivitiesChange(callback);
                        });
                } catch (error) {
                    debug('Setting up activities listener error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.onActivitiesChange(callback);
                }
            }
            
            onSettingsChange(callback) {
                debug('Setting up settings listener');
                if (this._shouldUseLocalFallback()) {
                    // For local fallback, we'll just call the callback once with current data
                    const storedSettings = localStorage.getItem('wyzwanie2025_settings');
                    if (storedSettings) {
                        localFirestore.settings = JSON.parse(storedSettings);
                        callback(localFirestore.settings);
                    }
                    // Return a dummy unsubscribe function
                    return () => {};
                }
                
                try {
                    return this.db.collection('settings').doc('challenge')
                        .onSnapshot(doc => {
                            if (doc.exists) {
                                callback(doc.data());
                            }
                        }, error => {
                            debug('Settings listener error, falling back to local:', error);
                            this.useLocalFallback = true;
                            return this.onSettingsChange(callback);
                        });
                } catch (error) {
                    debug('Setting up settings listener error, falling back to local:', error);
                    this.useLocalFallback = true;
                    return this.onSettingsChange(callback);
                }
            }
            
            // Clear data (for testing)
            async clearCollection(collectionName) {
                debug(`Clearing collection ${collectionName}`);
                if (this._shouldUseLocalFallback()) {
                    if (collectionName === 'participants') {
                        localFirestore.participants = [];
                        localStorage.removeItem('wyzwanie2025_participants');
                    } else if (collectionName === 'activities') {
                        localFirestore.activities = [];
                        localStorage.removeItem('wyzwanie2025_activities');
                    }
                    return true;
                }
                
                try {
                    const snapshot = await this.db.collection(collectionName).get();
                    const batch = this.db.batch();
                    
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    return true;
                } catch (error) {
                    debug(`Clear ${collectionName} error, falling back to local:`, error);
                    this.useLocalFallback = true;
                    return this.clearCollection(collectionName);
                }
            }

            // Pass-through to app's notification system
            showNotification(title, message, type) {
                const notification = document.getElementById('notification');
                const notificationTitle = notification.querySelector('.notification-title');
                const notificationText = document.getElementById('notification-text');
                const notificationIcon = notification.querySelector('.notification-icon i');
                
                // Set content
                notificationTitle.textContent = title;
                notificationText.textContent = message;
                
                // Set icon based on type
                switch (type) {
                    case 'success':
                        notificationIcon.className = 'fa fa-check';
                        notificationIcon.style.color = '#27ae60';
                        break;
                    case 'error':
                        notificationIcon.className = 'fa fa-times';
                        notificationIcon.style.color = '#e74c3c';
                        break;
                    case 'warning':
                        notificationIcon.className = 'fa fa-exclamation';
                        notificationIcon.style.color = '#f39c12';
                        break;
                    default: // info
                        notificationIcon.className = 'fa fa-info-circle';
                        notificationIcon.style.color = '#3498db';
                        break;
                }
                
                // Show notification
                notification.classList.add('visible');
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('visible');
                }, 5000);
            }
        }

        // Main App Class
        class WyzwanieApp {
            constructor() {
                // App state
                this.state = {
                    user: null,
                    participants: [],
                    activities: [],
                    currentPage: 0,
                    itemsPerPage: 8,
                    challengeStartDate: new Date('2025-04-01'),
                    challengeEndDate: new Date('2025-09-30'),
                    testMode: false,
                    deferredPrompt: null,
                    activitiesLoaded: false,
                    tokens: null, // Strava API tokens
                    unsubscribers: [] // For Firebase listeners
                };

                // Initialize Firebase
                this.firebase = new FirebaseManager();

                // Initialize the app
                this.init();
            }

            async init() {
                debug("App initialization started");
                // Initialize UI elements
                this.initUI();
                
                // Load stored settings and challenge dates
                await this.loadStoredSettings();
                
                // Load data
                await this.loadData();
                
                // Initialize event listeners
                this.initEventListeners();
                
                // Initialize service worker
                this.initServiceWorker();
                
                // Setup PWA installation
                this.setupPWA();
                
                // Update countdown
                this.updateCountdown();
                setInterval(() => this.updateCountdown(), 1000 * 60); // Update every minute
                
                // Setup realtime listeners
                this.setupRealtimeListeners();
                
                debug("App initialization completed");
                this.showNotification("Aplikacja gotowa", "Wyzwanie 2025 zosta≈Ço za≈Çadowane pomy≈õlnie.", "success");
            }

            initUI() {
                debug("Initializing UI");
                // Progress chart
                this.initChart();
                
                // Update countdown
                this.updateCountdown();
                
                // Check if the app is in standalone mode
                if (window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true) {
                    document.body.classList.add('standalone');
                }

                // Admin password (normally would be stored securely)
                this.adminPassword = 'admin1234';

                // Initialize Strava API credentials
                this.stravaClientId = '150694';
                
                // This would be kept server-side in a real app
                this.stravaClientSecret = 'd780e7a6e9bd2493f4e578d5206d4b6921c0a775';
                
                // Initialize Strava auth redirect URI
                this.stravaRedirectUri = window.location.href.split('?')[0];
                
                debug("UI initialization completed");
            }

            async loadStoredSettings() {
                debug("Loading stored settings");
                // Try to load settings from Firebase
                const settings = await this.firebase.getSettings();
                
                if (settings) {
                    debug("Found settings in Firebase/localStorage", settings);
                    // We have settings in Firebase, use them
                    if (settings.startDate) {
                        this.state.challengeStartDate = new Date(settings.startDate);
                    }
                    
                    if (settings.endDate) {
                        this.state.challengeEndDate = new Date(settings.endDate);
                    }
                    
                    if (settings.testMode !== undefined) {
                        this.state.testMode = settings.testMode;
                    }
                    
                    // Update UI with loaded settings
                    document.getElementById('challenge-start').value = this.formatDateForInput(this.state.challengeStartDate);
                    document.getElementById('challenge-end').value = this.formatDateForInput(this.state.challengeEndDate);
                    document.getElementById('test-mode').value = this.state.testMode ? '1' : '0';
                } else {
                    debug("No settings found, using defaults");
                    // No settings in Firebase, use default values
                    // Save default settings to Firebase
                    await this.firebase.saveSettings({
                        startDate: this.state.challengeStartDate.toISOString(),
                        endDate: this.state.challengeEndDate.toISOString(),
                        testMode: this.state.testMode
                    });
                }
                
                // Load Strava tokens from localStorage (temporary storage)
                const stravaTokens = localStorage.getItem('wyzwanie2025_stravaTokens');
                if (stravaTokens) {
                    debug("Found Strava tokens in localStorage");
                    this.state.tokens = JSON.parse(stravaTokens);
                }
                
                debug("Settings loaded");
            }

            initChart() {
                debug("Initializing chart");
                const ctx = document.getElementById('progress-chart').getContext('2d');
                
                // Create empty chart (will be populated later)
                this.progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: 'rgba(0, 93, 172, 0.8)',
                                titleFont: {
                                    weight: 'bold'
                                },
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y} punkt√≥w`;
                                    }
                                }
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + ' pkt';
                                    }
                                }
                            }
                        }
                    }
                });
                debug("Chart initialized");
            }

            async loadData() {
                debug("Loading app data");
                // Check for Strava authentication callback
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (code) {
                    debug("Found Strava auth code in URL, processing...");
                    // Show loading
                    this.showLoadingModal("Autoryzacja w Strava... Proszƒô czekaƒá.");
                    
                    try {
                        // Exchange code for access token
                        await this.handleStravaCallback(code);
                        
                        // Clear URL parameters
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (error) {
                        console.error('Strava auth error:', error);
                        this.showNotification("B≈ÇƒÖd autoryzacji", "Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z kontem Strava. Spr√≥buj ponownie.", "error");
                    } finally {
                        // Hide loading
                        this.hideLoadingModal();
                    }
                }
                
                // Check for stored user data
                const storedUser = localStorage.getItem('wyzwanie2025_user');
                if (storedUser) {
                    debug("Found stored user data");
                    this.state.user = JSON.parse(storedUser);
                    this.updateJoinButton();
                }

                // Load participants and activities from Firebase
                try {
                    debug("Loading participants and activities");
                    // Load participants
                    const participants = await this.firebase.getParticipants();
                    if (participants && participants.length > 0) {
                        debug(`Loaded ${participants.length} participants`);
                        this.state.participants = participants;
                    } else if (this.state.testMode) {
                        debug("No participants found and test mode is enabled, generating test data");
                        // Generate test data if in test mode and no participants exist
                        this.generateTestData(5);
                    }
                    
                    // Load activities
                    const activities = await this.firebase.getActivities();
                    if (activities && activities.length > 0) {
                        debug(`Loaded ${activities.length} activities`);
                        this.state.activities = activities;
                        this.state.activitiesLoaded = true;
                    } else if (this.state.testMode && this.state.participants.length > 0) {
                        debug("No activities found and test mode is enabled, generating test activities");
                        // Generate test activities if in test mode and participants exist
                        this.generateTestActivities();
                    }
                    
                    // Sort data
                    this.sortParticipants();
                    this.sortActivities();
                    
                    // Update UI
                    this.updateParticipantsList();
                    this.updateActivitiesList();
                    this.updateProgressChart();
                } catch (error) {
                    debug('Error loading data:', error);
                    this.showNotification("B≈ÇƒÖd ≈Çadowania", "Nie uda≈Ço siƒô pobraƒá danych. Spr√≥buj od≈õwie≈ºyƒá stronƒô.", "error");
                    
                    // Use empty data
                    this.state.participants = [];
                    this.state.activities = [];
                    this.updateParticipantsList();
                    this.updateActivitiesList();
                }
                
                // If user is logged in and we have tokens, fetch activities from Strava
                if (this.state.user && this.state.tokens) {
                    debug("User is logged in and has Strava tokens, fetching activities");
                    this.fetchStravaActivities();
                }
                
                debug("Data loading completed");
            }
            
            setupRealtimeListeners() {
                debug("Setting up realtime listeners");
                // Listen for changes in participants
                const participantsUnsubscribe = this.firebase.onParticipantsChange(participants => {
                    debug(`Received update with ${participants.length} participants`);
                    this.state.participants = participants;
                    this.sortParticipants();
                    this.updateParticipantsList();
                    this.updateProgressChart();
                });
                
                // Listen for changes in activities
                const activitiesUnsubscribe = this.firebase.onActivitiesChange(activities => {
                    debug(`Received update with ${activities.length} activities`);
                    this.state.activities = activities;
                    this.state.activities = activities;
                    this.sortActivities();
                    this.updateActivitiesList();
                    this.updateProgressChart();
                });
                
                // Listen for changes in settings
                const settingsUnsubscribe = this.firebase.onSettingsChange(settings => {
                    debug('Received settings update', settings);
                    if (settings.startDate) {
                        this.state.challengeStartDate = new Date(settings.startDate);
                    }
                    
                    if (settings.endDate) {
                        this.state.challengeEndDate = new Date(settings.endDate);
                    }
                    
                    if (settings.testMode !== undefined) {
                        this.state.testMode = settings.testMode;
                    }
                    
                    // Update UI
                    document.getElementById('challenge-start').value = this.formatDateForInput(this.state.challengeStartDate);
                    document.getElementById('challenge-end').value = this.formatDateForInput(this.state.challengeEndDate);
                    document.getElementById('test-mode').value = this.state.testMode ? '1' : '0';
                    
                    this.updateCountdown();
                    this.updateProgressChart();
                });
                
                // Save unsubscribe functions
                this.state.unsubscribers.push(participantsUnsubscribe, activitiesUnsubscribe, settingsUnsubscribe);
                debug("Realtime listeners setup complete");
            }

            sortParticipants() {
                this.state.participants.sort((a, b) => b.points - a.points);
            }

            sortActivities() {
                this.state.activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            updateParticipantsList() {
                debug("Updating participants list");
                const container = document.getElementById('participants-grid');
                container.innerHTML = '';

                if (this.state.participants.length === 0) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'empty-message';
                    emptyMessage.textContent = 'Brak uczestnik√≥w. BƒÖd≈∫ pierwszy i do≈ÇƒÖcz do wyzwania!';
                    container.appendChild(emptyMessage);
                    return;
                }

                this.state.participants.forEach((participant, index) => {
                    const card = document.createElement('div');
                    card.className = `participant-card ${participant.role}`;

                    // Get level based on points
                    const level = this.getParticipantLevel(participant);
                    
                    // Get streak badge if applicable
                    const streakDays = this.getParticipantStreak(participant);
                    
                    card.innerHTML = `
                        <div class="participant-header">
                            <div class="participant-rank ${index < 3 ? 'rank-' + (index + 1) : ''}">#${index + 1}</div>
                            <img src="${participant.avatar}" alt="${participant.name}" class="participant-avatar avatar-frame-${level.level}" data-strava-id="${participant.stravaId || ''}">
                            <div class="participant-info">
                                <div class="participant-name" data-strava-id="${participant.stravaId || ''}">${participant.name}</div>
                                <div class="participant-role">
                                    <i class="fa fa-${participant.role === 'runner' ? 'running' : participant.role === 'cyclist' ? 'biking' : 'medal'}"></i>
                                    ${participant.role === 'runner' ? 'Biegacz' : participant.role === 'cyclist' ? 'Rowerzysta' : 'Biegacz+Rowerzysta'}
                                </div>
                            </div>
                        </div>
                        ${streakDays >= 3 ? `<div class="streak-badge"><i class="fa fa-fire"></i>${streakDays} dni</div>` : ''}
                        <div class="participant-stats">
                            <div class="stat-row">
                                <div class="stat-label">Punkty:</div>
                                <div class="stat-value">${participant.points}</div>
                            </div>
                            <div class="stat-row">
                                <div class="stat-label">Do celu:</div>
                                <div class="stat-value">${Math.max(0, 2000 - participant.points)}</div>
                            </div>
                            <div class="stat-row">
                                <div class="stat-label">${participant.role === 'runner' ? 'Przebiegniƒôte:' : participant.role === 'cyclist' ? 'Przejechane:' : 'Dystans:'}</div>
                                <div class="stat-value">
                                    ${participant.role === 'runner' ? 
                                        `${(participant.runDistance || 0).toFixed(1)} km` : 
                                        participant.role === 'cyclist' ? 
                                        `${(participant.rideDistance || 0).toFixed(1)} km` : 
                                        `${(participant.runDistance || 0).toFixed(1)} km / ${(participant.rideDistance || 0).toFixed(1)} km`}
                                </div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(100, (participant.points / 2000) * 100)}%"></div>
                            </div>
                            <div class="progress-label">
                                <span>${level.name}</span>
                                <span>${Math.min(100, ((participant.points / 2000) * 100).toFixed(1))}%</span>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
                // Dodaj obs≈Çugƒô klikniƒôƒá w awatar i nazwƒô uczestnika
                debug("Adding click handlers for participant avatars and names");
                document.querySelectorAll('.participant-avatar, .participant-name').forEach(element => {
                    element.addEventListener('click', () => {
                        const stravaId = element.dataset.stravaId;
                        if (stravaId) {
                            window.open(`https://www.strava.com/athletes/${stravaId}`, '_blank');
                        }
                    });
                });
                
                debug("Participants list updated");
            }

            updateActivitiesList() {
                debug("Updating activities list");
                const container = document.getElementById('activity-list');
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                container.innerHTML = '';

                if (this.state.activities.length === 0) {
                    const emptyMessage = document.createElement('li');
                    emptyMessage.className = 'empty-message';
                    emptyMessage.textContent = 'Brak aktywno≈õci. Rozpocznij wyzwanie!';
                    container.appendChild(emptyMessage);
                    
                    prevBtn.disabled = true;
                    nextBtn.disabled = true;
                    return;
                }

                // Calculate pagination
                const startIdx = this.state.currentPage * this.state.itemsPerPage;
                const endIdx = Math.min(startIdx + this.state.itemsPerPage, this.state.activities.length);
                const pageActivities = this.state.activities.slice(startIdx, endIdx);

                // Update pagination buttons
                prevBtn.disabled = this.state.currentPage === 0;
                nextBtn.disabled = endIdx >= this.state.activities.length;

                // Create activity items
                pageActivities.forEach(activity => {
                    const participant = this.state.participants.find(p => p.id === activity.participantId);
                    if (!participant) return;

                    const item = document.createElement('li');
                    item.className = 'activity-item';

                    const activityDate = new Date(activity.date);
                    const formattedDate = activityDate.toLocaleDateString('pl-PL', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    
                    const formattedTime = activityDate.toLocaleTimeString('pl-PL', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Dodaj atrybut ze Strava ID aktywno≈õci, je≈õli istnieje
                    const stravaActivityId = activity.id.startsWith('strava-') ? activity.id.replace('strava-', '') : '';
                    const stravaAthleteId = participant.stravaId || '';

                    item.innerHTML = `
                        <div class="activity-icon ${activity.type === 'run' ? 'run-icon' : 'ride-icon'}">
                            <i class="fa fa-${activity.type === 'run' ? 'running' : 'biking'}"></i>
                        </div>
                        <div class="activity-details">
                            <div class="activity-title" data-strava-id="${stravaActivityId}">${activity.name}</div>
                            <div class="activity-meta">
                                <div class="participant-name" data-strava-id="${stravaAthleteId}">${participant.name}</div>
                                <div>${formattedDate} ${formattedTime}</div>
                                <div>${activity.distance.toFixed(1)} km</div>
                                <div>${activity.type === 'run' ? 
                                    this.formatPace(activity.pace) : 
                                    activity.speed.toFixed(1) + ' km/h'}</div>
                            </div>
                        </div>
                        <div>
                            <button class="high-five-btn" data-activity-id="${activity.id}">
                                <i class="fa fa-hand-paper"></i>
                                <span class="high-five-count">${activity.highFives || 0}</span>
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
                
                // Dodaj obs≈Çugƒô klikniƒôƒá w nazwƒô aktywno≈õci
                debug("Adding click handlers for activity titles");
                document.querySelectorAll('.activity-title').forEach(element => {
                    element.addEventListener('click', () => {
                        const stravaId = element.dataset.stravaId;
                        if (stravaId) {
                            window.open(`https://www.strava.com/activities/${stravaId}`, '_blank');
                        }
                    });
                });
                
                // Dodaj obs≈Çugƒô klikniƒôƒá w nazwƒô uczestnika
                debug("Adding click handlers for activity participant names");
                document.querySelectorAll('.activity-meta .participant-name').forEach(element => {
                    element.addEventListener('click', () => {
                        const stravaId = element.dataset.stravaId;
                        if (stravaId) {
                            window.open(`https://www.strava.com/athletes/${stravaId}`, '_blank');
                        }
                    });
                });
                
                // Add event listeners for high five buttons
                debug("Adding click handlers for high five buttons");
                document.querySelectorAll('.high-five-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const activityId = e.currentTarget.dataset.activityId;
                        this.sendHighFive(activityId);
                    });
                });
                
                debug("Activities list updated");
            }

            updateProgressChart() {
                debug("Updating progress chart");
                // If no participants, clear the chart
                if (this.state.participants.length === 0) {
                    this.progressChart.data.labels = [];
                    this.progressChart.data.datasets = [];
                    this.progressChart.update();
                    return;
                }

                // Generate date labels from challenge start to current date
                const labels = [];
                const startDate = new Date(this.state.challengeStartDate);
                const endDate = new Date(Math.min(new Date(), this.state.challengeEndDate));
                
                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                    labels.push(date.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' }));
                }

                // Prepare datasets for each participant
                const datasets = this.state.participants.map((participant, index) => {
                    // Get activities for this participant
                    const participantActivities = this.state.activities.filter(
                        a => a.participantId === participant.id
                    );
                    
                    // Colors for different roles
                    const roleColors = {
                        'runner': 'rgb(255, 87, 34)',
                        'cyclist': 'rgb(33, 150, 243)',
                        'combined': 'rgb(156, 39, 176)'
                    };

                    // Generate daily points data
                    const data = new Array(labels.length).fill(0);
                    let totalPoints = 0;
                    
                    participantActivities.forEach(activity => {
                        const activityDate = new Date(activity.date);
                        const index = Math.floor((activityDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        if (index >= 0 && index < data.length) {
                            const points = activity.type === 'run' ? activity.distance * 2 : activity.distance;
                            totalPoints += points;
                            
                            // Set cumulative points for this and all future days
                            for (let i = index; i < data.length; i++) {
                                data[i] = totalPoints;
                            }
                        }
                    });

                    // Create dataset for this participant
                    return {
                        label: participant.name,
                        data: data,
                        borderColor: roleColors[participant.role],
                        backgroundColor: `${roleColors[participant.role]}20`,
                        borderWidth: 2,
                        pointRadius: 1,
                        pointHoverRadius: 5,
                        cubicInterpolationMode: 'monotone',
                        tension: 0.4
                    };
                });

                // Update chart data
                this.progressChart.data.labels = labels;
                this.progressChart.data.datasets = datasets;
                this.progressChart.update();
                debug("Progress chart updated");
            }

            updateCountdown() {
                debug("Updating countdown");
                const countdownEl = document.getElementById('countdown-timer');
                const now = new Date();
                
                // Challenge hasn't started yet
                if (now < this.state.challengeStartDate) {
                    const daysToStart = Math.ceil((this.state.challengeStartDate - now) / (1000 * 60 * 60 * 24));
                    countdownEl.textContent = `Wyzwanie rozpocznie siƒô za ${daysToStart} dni`;
                    countdownEl.style.color = '#f39c12';
                }
                // Challenge is ongoing
                else if (now >= this.state.challengeStartDate && now <= this.state.challengeEndDate) {
                    const daysLeft = Math.ceil((this.state.challengeEndDate - now) / (1000 * 60 * 60 * 24));
                    countdownEl.textContent = `Pozosta≈Ço ${daysLeft} dni do ko≈Ñca wyzwania`;
                    countdownEl.style.color = '#27ae60';
                }
                // Challenge has ended
                else {
                    countdownEl.textContent = 'Wyzwanie zosta≈Ço zako≈Ñczone';
                    countdownEl.style.color = '#e74c3c';
                }
            }

            updateJoinButton() {
                debug("Updating join button state");
                const joinBtn = document.getElementById('join-btn');
                
                if (this.state.user) {
                    joinBtn.textContent = 'Ju≈º uczestniczysz';
                    joinBtn.disabled = true;
                    joinBtn.classList.add('btn-disabled');
                } else {
                    joinBtn.innerHTML = '<i class="fa fa-user-plus"></i> Do≈ÇƒÖcz do wyzwania';
                    joinBtn.disabled = false;
                    joinBtn.classList.remove('btn-disabled');
                }
            }

            getParticipantLevel(participant) {
                const points = participant.points;
                const role = participant.role;
                
                // Define levels based on role
                const levels = {
                    runner: [
                        { level: 1, min: 0, max: 249, name: "PoczƒÖtkujƒÖcy Biegacz" },
                        { level: 2, min: 250, max: 749, name: "Regularny Biegacz" },
                       { level: 3, min: 750, max: 1499, name: "Zaawansowany Biegacz" },
                        { level: 4, min: 1500, max: 1999, name: "Mistrz Biegania" },
                        { level: 5, min: 2000, max: Infinity, name: "Ultramarato≈Ñczyk" }
                    ],
                    cyclist: [
                        { level: 1, min: 0, max: 249, name: "PoczƒÖtkujƒÖcy Kolarz" },
                        { level: 2, min: 250, max: 749, name: "Regularny Rowerzysta" },
                        { level: 3, min: 750, max: 1499, name: "Zaawansowany Kolarz" },
                        { level: 4, min: 1500, max: 1999, name: "Mistrz Kolarstwa" },
                        { level: 5, min: 2000, max: Infinity, name: "Szosowy Czempion" }
                    ],
                    combined: [
                        { level: 1, min: 0, max: 249, name: "PoczƒÖtkujƒÖcy Sportowiec" },
                        { level: 2, min: 250, max: 749, name: "Regularny Sportowiec" },
                        { level: 3, min: 750, max: 1499, name: "Zaawansowany Sportowiec" },
                        { level: 4, min: 1500, max: 1999, name: "Mistrz Wszechstronny" },
                        { level: 5, min: 2000, max: Infinity, name: "Multi-czempion" }
                    ]
                };
                
                // Get level for current role and points
                return levels[role].find(level => points >= level.min && points <= level.max);
            }

            getParticipantStreak(participant) {
                if (!this.state.activities || this.state.activities.length === 0) {
                    return 0;
                }
                
                // Get participant activities
                const activities = this.state.activities.filter(a => a.participantId === participant.id);
                if (activities.length === 0) {
                    return 0;
                }
                
                // Sort by date (newest first)
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get today's date
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Check if there's an activity today
                const latestActivity = new Date(activities[0].date);
                latestActivity.setHours(0, 0, 0, 0);
                
                if (latestActivity < today) {
                    // No activity today, streak broken
                    return 0;
                }
                
                // Count streak days
                let streak = 1;
                let currentDate = today;
                
                // Go back in time day by day
                for (let i = 1; i <= 30; i++) {
                    const prevDate = new Date(currentDate);
                    prevDate.setDate(prevDate.getDate() - 1);
                    
                    // Check if there's an activity on this day
                    const hasActivity = activities.some(activity => {
                        const activityDate = new Date(activity.date);
                        activityDate.setHours(0, 0, 0, 0);
                        return activityDate.getTime() === prevDate.getTime();
                    });
                    
                    if (hasActivity) {
                        streak++;
                        currentDate = prevDate;
                    } else {
                        break;
                    }
                }
                
                return streak;
            }

            initEventListeners() {
                debug("Initializing event listeners");
                
                // Join button
                debug("Adding join button click handler");
                document.getElementById('join-btn').addEventListener('click', () => {
                    this.openJoinModal();
                });
                
                // Modal close buttons
                debug("Adding modal close button handlers");
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const modalId = e.target.closest('.modal-overlay').id;
                        document.getElementById(modalId).classList.remove('visible');
                    });
                });
                
                // Role selection
                debug("Adding role selection handlers");
                document.querySelectorAll('.role-card').forEach(card => {
                    card.addEventListener('click', () => {
                        // Remove selected class from all cards
                        document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
                        
                        // Add selected class to clicked card
                        card.classList.add('selected');
                        
                        // Enable connect button
                        document.getElementById('connect-strava-btn').disabled = false;
                    });
                });
                
                // Connect Strava button
                debug("Adding connect Strava button handler");
                document.getElementById('connect-strava-btn').addEventListener('click', () => {
                    const selectedRole = document.querySelector('.role-card.selected')?.dataset.role;
                    
                    if (selectedRole) {
                        this.connectWithStrava(selectedRole);
                    }
                });
                
                // Pagination buttons
                debug("Adding pagination button handlers");
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (this.state.currentPage > 0) {
                        this.state.currentPage--;
                        this.updateActivitiesList();
                    }
                });
                
                document.getElementById('next-page').addEventListener('click', () => {
                    const maxPage = Math.ceil(this.state.activities.length / this.state.itemsPerPage) - 1;
                    if (this.state.currentPage < maxPage) {
                        this.state.currentPage++;
                        this.updateActivitiesList();
                    }
                });
                
                // Admin link
                debug("Adding admin link handler");
                document.getElementById('admin-link').addEventListener('click', e => {
                    e.preventDefault();
                    this.openAdminModal();
                });
                
                // Admin login button
                debug("Adding admin login button handler");
                document.getElementById('admin-login-btn').addEventListener('click', () => {
                    this.loginAdmin();
                });
                
                // Admin password input (enter key)
                debug("Adding admin password keyup handler");
                document.getElementById('admin-password').addEventListener('keyup', e => {
                    if (e.key === 'Enter') {
                        this.loginAdmin();
                    }
                });
                
                // Save challenge dates button
                debug("Adding save dates button handler");
                document.getElementById('save-dates-btn').addEventListener('click', () => {
                    this.saveChallengeSettings();
                });
                
                // Toggle test mode button
                debug("Adding toggle test mode button handler");
                document.getElementById('toggle-test-btn').addEventListener('click', () => {
                    this.toggleTestMode();
                });
                
                // Generate test data button
                debug("Adding generate test data button handler");
                document.getElementById('generate-data-btn').addEventListener('click', () => {
                    const numUsers = parseInt(document.getElementById('test-users').value) || 5;
                    this.generateTestData(numUsers);
                });
                
                // Reset test data button
                debug("Adding reset test data button handler");
                document.getElementById('reset-data-btn').addEventListener('click', () => {
                    this.resetTestData();
                });
                
                // Install button
                debug("Adding install button handler");
                document.getElementById('install-btn').addEventListener('click', () => {
                    this.installPWA();
                });
                
                // Close install banner button
                debug("Adding close install banner button handler");
                document.getElementById('close-install-btn').addEventListener('click', () => {
                    document.getElementById('install-banner').classList.remove('visible');
                    localStorage.setItem('wyzwanie2025_installBannerClosed', 'true');
                });
                
                // Mobile navigation
                debug("Adding mobile navigation handlers");
                document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                });
                
                // Add click handler to close modals when clicking outside
                debug("Adding modal overlay click handlers");
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('click', e => {
                        if (e.target === overlay) {
                            overlay.classList.remove('visible');
                        }
                    });
                });
                
                debug("Event listeners initialized");
            }

            openJoinModal() {
                debug("Opening join modal");
                // Reset role selection
                document.querySelectorAll('.role-card').forEach(card => card.classList.remove('selected'));
                document.getElementById('connect-strava-btn').disabled = true;
                
                // Show modal
                document.getElementById('join-modal').classList.add('visible');
            }

            openAdminModal() {
                debug("Opening admin modal");
                // Reset admin form
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-login').style.display = 'block';
                document.getElementById('admin-panel').style.display = 'none';
                
                // Show modal
                document.getElementById('admin-modal').classList.add('visible');
            }

            loginAdmin() {
                debug("Attempting admin login");
                const password = document.getElementById('admin-password').value;
                
                if (password === this.adminPassword) {
                    debug("Admin login successful");
                    document.getElementById('admin-login').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    
                    // Set form values
                    document.getElementById('challenge-start').value = this.formatDateForInput(this.state.challengeStartDate);
                    document.getElementById('challenge-end').value = this.formatDateForInput(this.state.challengeEndDate);
                    document.getElementById('test-mode').value = this.state.testMode ? '1' : '0';
                } else {
                    debug("Admin login failed - incorrect password");
                    this.showNotification("B≈ÇƒÖd logowania", "Niepoprawne has≈Ço administratora.", "error");
                }
            }

            async saveChallengeSettings() {
                debug("Saving challenge settings");
                const startDate = new Date(document.getElementById('challenge-start').value);
                const endDate = new Date(document.getElementById('challenge-end').value);
                
                if (startDate >= endDate) {
                    debug("Invalid date range - start date must be before end date");
                    this.showNotification("B≈ÇƒÖd ustawie≈Ñ", "Data rozpoczƒôcia musi byƒá wcze≈õniejsza ni≈º data zako≈Ñczenia.", "error");
                    return;
                }
                
                this.state.challengeStartDate = startDate;
                this.state.challengeEndDate = endDate;
                
                // Save to Firebase
                try {
                    debug("Saving settings to Firebase/localStorage");
                    await this.firebase.saveSettings({
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString(),
                        testMode: this.state.testMode
                    });
                    
                    this.updateCountdown();
                    this.updateProgressChart();
                    
                    this.showNotification("Sukces", "Daty wyzwania zosta≈Çy zaktualizowane.", "success");
                } catch (error) {
                    debug('Error saving challenge settings:', error);
                    this.showNotification("B≈ÇƒÖd", "Nie uda≈Ço siƒô zapisaƒá ustawie≈Ñ. Spr√≥buj ponownie.", "error");
                }
            }

            async toggleTestMode() {
                debug("Toggling test mode");
                const testMode = document.getElementById('test-mode').value === '1';
                this.state.testMode = testMode;
                
                // Save to Firebase
                try {
                    debug(`Setting test mode to ${testMode}`);
                    await this.firebase.saveSettings({
                        startDate: this.state.challengeStartDate.toISOString(),
                        endDate: this.state.challengeEndDate.toISOString(),
                        testMode: testMode
                    });
                    
                    if (testMode && !this.state.activitiesLoaded && this.state.participants.length === 0) {
                        // Generate test data if not already loaded
                        debug("Generating test data since test mode was enabled");
                        const numUsers = parseInt(document.getElementById('test-users').value) || 5;
                        this.generateTestData(numUsers);
                    }
                    
                    this.showNotification(
                        "Tryb testowy", 
                        testMode ? "Tryb testowy zosta≈Ç w≈ÇƒÖczony." : "Tryb testowy zosta≈Ç wy≈ÇƒÖczony.", 
                        "info"
                    );
                } catch (error) {
                    debug('Error toggling test mode:', error);
                    this.showNotification("B≈ÇƒÖd", "Nie uda≈Ço siƒô zmieniƒá trybu testowego.", "error");
                }
            }

            async generateTestData(numUsers = 5) {
                debug(`Generating test data for ${numUsers} users`);
                // Show loading modal
                this.showLoadingModal("Generowanie danych testowych...");
                
                try {
                    // Clear existing data
                    await this.resetTestData(false);
                    
                    // Create test participants
                    const roles = ['runner', 'cyclist', 'combined'];
                    const avatars = [
                        'https://i.pravatar.cc/150?img=1',
                        'https://i.pravatar.cc/150?img=2',
                        'https://i.pravatar.cc/150?img=3',
                        'https://i.pravatar.cc/150?img=4',
                        'https://i.pravatar.cc/150?img=5',
                        'https://i.pravatar.cc/150?img=6',
                        'https://i.pravatar.cc/150?img=7',
                        'https://i.pravatar.cc/150?img=8',
                        'https://i.pravatar.cc/150?img=9',
                        'https://i.pravatar.cc/150?img=10'
                    ];
                    
                    const testParticipants = [];
                    
                    for (let i = 0; i < numUsers; i++) {
                        const role = roles[Math.floor(Math.random() * roles.length)];
                        const participant = {
                            id: `test-${i + 1}`,
                            name: `Uczestnik ${i + 1}`,
                            role: role,
                            avatar: avatars[i % avatars.length],
                            points: 0,
                            runDistance: 0,
                            rideDistance: 0,
                            streak: Math.floor(Math.random() * 14),
                            stravaId: `10000${i + 1}` // Dodajemy symulowane ID Strava
                        };
                        
                        testParticipants.push(participant);
                        
                        // Save to Firebase one by one to avoid large batch operations
                        await this.firebase.saveParticipant(participant);
                        debug(`Created test participant: ${participant.name}`);
                    }
                    
                    this.state.participants = testParticipants;
                    
                    // Generate activities
                    await this.generateTestActivities();
                    
                    // Sorting is done by Firebase listeners
                    
                    this.showNotification("Dane testowe", `Wygenerowano ${numUsers} uczestnik√≥w testowych z aktywno≈õciami.`, "success");
                } catch (error) {
                    debug('Error generating test data:', error);
                    this.showNotification("B≈ÇƒÖd", "Nie uda≈Ço siƒô wygenerowaƒá danych testowych.", "error");
                } finally {
                    this.hideLoadingModal();
                }
            }

            async generateTestActivities() {
                debug("Generating test activities");
                const testActivities = [];
                const activityNames = [
                    'Poranny trening',
                    'Popo≈Çudniowy wypad',
                    'Weekendowa przeja≈ºd≈ºka',
                    'Interwa≈Çy',
                    'Regeneracyjne bieganie',
                    'D≈Çugi dystans',
                    'Tempo run',
                    'G√≥rska przeja≈ºd≈ºka',
                    'Miejska trasa',
                    'Trening si≈Çowy',
                    'Trening szybko≈õciowy'
                ];
                
                // Start from 10 days before challenge start
                const startDate = new Date(this.state.challengeStartDate);
                startDate.setDate(startDate.getDate() - 10);
                
                // End on today or challenge end date, whichever comes first
                const endDate = new Date(Math.min(new Date(), this.state.challengeEndDate));
                
                try {
                    // For each participant
                    for (const participant of this.state.participants) {
                        debug(`Generating activities for: ${participant.name}`);
                        // Reset points and distances
                        participant.points = 0;
                        participant.runDistance = 0;
                        participant.rideDistance = 0;
                        
                        // Random number of activities (10-30)
                        const numActivities = 10 + Math.floor(Math.random() * 21);
                        const participantActivities = [];
                        
                        // Generate activities
                        for (let i = 0; i < numActivities; i++) {
                            // Random date between startDate and endDate
                            const activityDate = new Date(startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime()));
                            
                            // Only include activities during the challenge period
                            if (activityDate >= this.state.challengeStartDate && activityDate <= endDate) {
                                // Determine activity type based on participant role
                                let activityType;
                               if (participant.role === 'runner') {
                                    activityType = 'run';
                                } else if (participant.role === 'cyclist') {
                                    activityType = 'ride';
                                } else {
                                    // Combined role - randomly choose run or ride
                                    activityType = Math.random() < 0.5 ? 'run' : 'ride';
                                }
                                
                                // Random distance (3-30km for runs, 10-80km for rides)
                                const distance = activityType === 'run' 
                                    ? 3 + Math.random() * 27 
                                    : 10 + Math.random() * 70;
                                
                                // Random pace for runs (4-7 min/km)
                                const pace = 4 * 60 + Math.random() * 3 * 60; // seconds per km
                                
                                // Random speed for rides (15-35 km/h)
                                const speed = 15 + Math.random() * 20;
                                
                                // Calculate points
                                const points = activityType === 'run' ? distance * 2 : distance;
                                
                                // Generuj identyfikator aktywno≈õci Strava
                                const stravaActivityId = `90000${participant.id.replace('test-', '')}${i}`;
                                
                                // Create activity with high fives
                                const activity = {
                                    id: `strava-${stravaActivityId}`,
                                    participantId: participant.id,
                                    name: activityNames[Math.floor(Math.random() * activityNames.length)],
                                    type: activityType,
                                    distance: distance,
                                    date: activityDate.toISOString(),
                                    pace: pace,
                                    speed: speed,
                                    highFives: Math.floor(Math.random() * 10) // Random high fives
                                };
                                
                                // Add activity to lists
                                testActivities.push(activity);
                                participantActivities.push(activity);
                                
                                // Update participant stats
                                participant.points += points;
                                if (activityType === 'run') {
                                    participant.runDistance += distance;
                                } else {
                                    participant.rideDistance += distance;
                                }
                            }
                        }
                        
                        // Update participant in Firebase
                        await this.firebase.updateParticipant(participant.id, {
                            points: participant.points,
                            runDistance: participant.runDistance,
                            rideDistance: participant.rideDistance
                        });
                        
                        // Save activities in small batches to avoid large operations
                        if (participantActivities.length > 0) {
                            debug(`Saving ${participantActivities.length} activities for ${participant.name}`);
                            await this.firebase.saveActivities(participantActivities);
                        }
                    }
                    
                    this.state.activities = testActivities;
                    this.state.activitiesLoaded = true;
                    debug(`Generated ${testActivities.length} test activities in total`);
                } catch (error) {
                    debug('Error generating test activities:', error);
                    throw error;
                }
            }

            async resetTestData(showNotification = true) {
                debug("Resetting test data");
                // Show loading modal
                if (showNotification) {
                    this.showLoadingModal("Resetowanie danych testowych...");
                }
                
                try {
                    // Clear data from Firebase
                    await this.firebase.clearCollection('participants');
                    await this.firebase.clearCollection('activities');
                    
                    // Clear local state
                    this.state.participants = [];
                    this.state.activities = [];
                    this.state.activitiesLoaded = false;
                    
                    if (showNotification) {
                        this.showNotification("Reset danych", "Dane testowe zosta≈Çy zresetowane.", "info");
                    }
                } catch (error) {
                    debug('Error resetting test data:', error);
                    if (showNotification) {
                        this.showNotification("B≈ÇƒÖd", "Nie uda≈Ço siƒô zresetowaƒá danych testowych.", "error");
                    }
                } finally {
                    if (showNotification) {
                        this.hideLoadingModal();
                    }
                }
            }

            connectWithStrava(role) {
                debug(`Connecting with Strava for role: ${role}`);
                // Store selected role for after authorization
                localStorage.setItem('wyzwanie2025_pendingRole', role);
                
                // Hide join modal
                document.getElementById('join-modal').classList.remove('visible');
                
                // Show loading modal
                this.showLoadingModal("Przekierowywanie do Strava...");
                
                // Redirect to Strava OAuth
                setTimeout(() => {
                    const authUrl = `https://www.strava.com/oauth/authorize?client_id=${this.stravaClientId}&redirect_uri=${encodeURIComponent(this.stravaRedirectUri)}&response_type=code&scope=read,activity:read`;
                    
                    // For test mode, we can skip the actual Strava auth
                    if (this.state.testMode) {
                        debug("Test mode: simulating Strava auth callback");
                        this.hideLoadingModal();
                        // Generate a fake user with the selected role
                        const fakeAthleteData = {
                            id: 12345678,
                            firstname: 'Jan',
                            lastname: 'Kowalski',
                            profile: 'https://i.pravatar.cc/150?img=50'
                        };
                        
                        // Create user and generate activities
                        this.createUserFromStravaData(fakeAthleteData, role)
                            .then(() => this.generateMockActivitiesForUser(this.state.user))
                            .then(() => {
                                this.showConfetti();
                                this.showNotification(
                                    "Gratulacje (tryb testowy)!", 
                                    "Do≈ÇƒÖczy≈Çe≈õ do wyzwania w trybie testowym!", 
                                    "success"
                                );
                            });
                    } else {
                        // Actual Strava auth
                        debug("Redirecting to Strava auth URL");
                        window.location.href = authUrl;
                    }
                }, 1000);
            }

            async handleStravaCallback(code) {
                debug("Handling Strava callback");
                try {
                    // Exchange authorization code for access token
                    const tokenResponse = await this.exchangeCodeForToken(code);
                    
                    if (!tokenResponse || !tokenResponse.access_token) {
                        throw new Error('Failed to get Strava access token');
                    }
                    
                    // Save tokens
                    this.state.tokens = {
                        accessToken: tokenResponse.access_token,
                        refreshToken: tokenResponse.refresh_token,
                        expiresAt: tokenResponse.expires_at
                    };
                    
                    // W prawdziwej aplikacji, token by≈Çby zapisany na serwerze
                    localStorage.setItem('wyzwanie2025_stravaTokens', JSON.stringify(this.state.tokens));
                    
                    // Fetch athlete data from Strava
                    const athleteData = await this.fetchStravaAthleteData();
                    
                    if (!athleteData) {
                        throw new Error('Failed to fetch athlete data');
                    }
                    
                    // Get selected role
                    const role = localStorage.getItem('wyzwanie2025_pendingRole') || 'runner';
                    localStorage.removeItem('wyzwanie2025_pendingRole');
                    
                    // Create user
                    await this.createUserFromStravaData(athleteData, role);
                    
                    // Fetch activities
                    await this.fetchStravaActivities();
                    
                    // Show success notification
                    this.showConfetti();
                    this.showNotification(
                        "Gratulacje!", 
                        "Do≈ÇƒÖczy≈Çe≈õ do wyzwania! Twoje aktywno≈õci ze Strava bƒôdƒÖ teraz automatycznie synchronizowane.", 
                        "success"
                    );
                    
                } catch (error) {
                    debug('Error handling Strava callback:', error);
                    this.showNotification(
                        "B≈ÇƒÖd integracji", 
                        "WystƒÖpi≈Ç problem podczas ≈ÇƒÖczenia ze Strava. Spr√≥buj ponownie.", 
                        "error"
                    );
                }
            }

            async exchangeCodeForToken(code) {
                debug("Exchanging code for Strava token");
                try {
                    // W rzeczywistej aplikacji, ten proces powinien odbywaƒá siƒô po stronie serwera
                    // dla bezpiecze≈Ñstwa. Jednak dla uproszczenia, robimy to tutaj.
                    if (this.state.testMode) {
                        debug("Test mode: returning mock tokens");
                        // W trybie testowym symulujemy odpowied≈∫
                        return {
                            access_token: 'mock_access_token',
                            refresh_token: 'mock_refresh_token',
                            expires_at: Math.floor(Date.now() / 1000) + 21600
                        };
                    }
                    
                    // Wywo≈Çanie Strava API OAuth
                    const response = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            client_id: this.stravaClientId,
                            client_secret: this.stravaClientSecret,
                            code: code,
                            grant_type: 'authorization_code'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Strava token exchange failed');
                    }
                    
                    return await response.json();
                } catch (error) {
                    debug('Error exchanging code for token:', error);
                    
                    // W trybie testowym zwracamy symulowane dane
                    if (this.state.testMode) {
                        debug("Falling back to mock tokens after error");
                        return {
                            access_token: 'mock_access_token',
                            refresh_token: 'mock_refresh_token',
                            expires_at: Math.floor(Date.now() / 1000) + 21600
                        };
                    }
                    throw error;
                }
            }

            async fetchStravaAthleteData() {
                debug("Fetching Strava athlete data");
                try {
                    // Check if we have a valid token
                    if (!this.state.tokens || !this.state.tokens.accessToken) {
                        throw new Error('No Strava access token');
                    }
                    
                    // In test mode, return mock data
                    if (this.state.testMode) {
                        debug("Test mode: returning mock athlete data");
                        return {
                            id: 12345678,
                            firstname: 'Jan',
                            lastname: 'Kowalski',
                            profile: 'https://i.pravatar.cc/150?img=50'
                        };
                    }
                    
                    // Fetch athlete data from Strava API
                    const response = await fetch('https://www.strava.com/api/v3/athlete', {
                        headers: {
                            'Authorization': `Bearer ${this.state.tokens.accessToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Strava athlete data fetch failed');
                    }
                    
                    return await response.json();
                } catch (error) {
                    debug('Error fetching athlete data:', error);
                    
                    // For demo purposes in test mode
                    if (this.state.testMode) {
                        debug("Falling back to mock athlete data after error");
                        return {
                            id: 12345678,
                            firstname: 'Jan',
                            lastname: 'Kowalski',
                            profile: 'https://i.pravatar.cc/150?img=50'
                        };
                    }
                    throw error;
                }
            }

            async createUserFromStravaData(athleteData, role) {
                debug(`Creating user from Strava data, role: ${role}`, athleteData);
                // Create user from Strava data
                const user = {
                    id: `strava-${athleteData.id}`,
                    name: `${athleteData.firstname} ${athleteData.lastname}`,
                    role: role,
                    avatar: athleteData.profile || 'https://i.pravatar.cc/150?img=50',
                    points: 0,
                    runDistance: 0,
                    rideDistance: 0,
                    streak: 0,
                    stravaId: athleteData.id.toString()
                };
                
                // Save user to state
                this.state.user = user;
                
                // Save to localStorage for persistence across sessions
                localStorage.setItem('wyzwanie2025_user', JSON.stringify(user));
                localStorage.setItem('wyzwanie2025_stravaId', athleteData.id.toString());
                
                // Create Firebase auth token
                try {
                    // Sign in anonymously for demo purposes
                    // In a real app, we would use custom auth
                    await this.firebase.signInAnonymously();
                    debug("Firebase anonymous sign-in successful");
                } catch (error) {
                    debug('Error creating auth token:', error);
                }
                
                // Add to participants if not already present
                const existingParticipant = this.state.participants.find(p => p.id === user.id);
                if (!existingParticipant) {
                    // Add to Firebase
                    await this.firebase.saveParticipant(user);
                    debug("Added new participant to Firebase/localStorage");
                    
                    // Add to local state
                    this.state.participants.push(user);
                    this.sortParticipants();
                } else {
                    debug("User already exists as a participant");
                }
                
                // Update UI
                this.updateJoinButton();
                debug("User created successfully");
            }

            async fetchStravaActivities() {
                debug("Fetching Strava activities");
                try {
                    // Check if we have a valid token
                    if (!this.state.tokens || !this.state.tokens.accessToken) {
                        throw new Error('No Strava access token');
                    }
                    
                    // Check if token is expired
                    if (this.state.tokens.expiresAt * 1000 < Date.now()) {
                        debug("Token expired, refreshing");
                        await this.refreshStravaToken();
                    }
                    
                    this.showLoadingModal("Pobieranie aktywno≈õci ze Strava...");
                    
                    // In test mode, generate mock activities
                    if (this.state.testMode && this.state.user) {
                        debug("Test mode: generating mock activities");
                        await this.generateMockActivitiesForUser(this.state.user);
                        this.hideLoadingModal();
                        return;
                    }
                    
                    // Calculate date range for activities
                    const after = Math.floor(this.state.challengeStartDate.getTime() / 1000);
                    const before = Math.floor(this.state.challengeEndDate.getTime() / 1000);
                    
                    // Fetch activities from Strava API
                    debug("Making request to Strava API");
                    const response = await fetch(`https://www.strava.com/api/v3/athlete/activities?after=${after}&before=${before}&per_page=100`, {
                        headers: {
                            'Authorization': `Bearer ${this.state.tokens.accessToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Strava activities fetch failed');
                    }
                    
                    const stravaActivities = await response.json();
                    debug(`Received ${stravaActivities.length} activities from Strava`);
                    
                    // Process Strava activities
                    await this.processStravaActivities(stravaActivities);
                    
                    this.hideLoadingModal();
                    
                } catch (error) {
                    debug('Error fetching Strava activities:', error);
                    this.hideLoadingModal();
                    
                    // For demo purposes in test mode
                    if (this.state.testMode && this.state.user) {
                        debug("Falling back to mock activities after error");
                        await this.generateMockActivitiesForUser(this.state.user);
                    } else {
                        this.showNotification(
                            "B≈ÇƒÖd synchronizacji", 
                            "Nie uda≈Ço siƒô pobraƒá aktywno≈õci ze Strava. Spr√≥buj ponownie p√≥≈∫niej.", 
                            "error"
                        );
                    }
                }
            }

            async refreshStravaToken() {
                debug("Refreshing Strava token");
                try {
                    // In test mode, simulate a refreshed token
                    if (this.state.testMode) {
                        debug("Test mode: simulating token refresh");
                        this.state.tokens = {
                            accessToken: 'refreshed_mock_access_token',
                            refreshToken: 'refreshed_mock_refresh_token',
                            expiresAt: Math.floor(Date.now() / 1000) + 21600
                        };
                        
                        localStorage.setItem('wyzwanie2025_stravaTokens', JSON.stringify(this.state.tokens));
                        return;
                    }
                    
                    // Refresh token with Strava API
                    const response = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            client_id: this.stravaClientId,
                            client_secret: this.stravaClientSecret,
                            refresh_token: this.state.tokens.refreshToken,
                            grant_type: 'refresh_token'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Strava token refresh failed');
                    }
                    
                    const data = await response.json();
                    
                    // Update tokens
                    this.state.tokens = {
                        accessToken: data.access_token,
                        refreshToken: data.refresh_token,
                        expiresAt: data.expires_at
                    };
                    
                    localStorage.setItem('wyzwanie2025_stravaTokens', JSON.stringify(this.state.tokens));
                    debug("Token refreshed successfully");
                    
                } catch (error) {
                    debug('Error refreshing Strava token:', error);
                    throw error;
                }
            }

            async processStravaActivities(stravaActivities) {
                if (!this.state.user) {
                    debug("No user, cannot process activities");
                    return;
                }
                
                debug(`Processing ${stravaActivities.length} Strava activities`);
                
                // Reset user stats
                this.state.user.points = 0;
                this.state.user.runDistance = 0;
                this.state.user.rideDistance = 0;
                
                // Get existing activities for this user
                const existingActivitiesForOtherUsers = this.state.activities.filter(a => a.participantId !== this.state.user.id);
                const newActivities = [];
                
                // Process each activity
                for (const activity of stravaActivities) {
                    // Only process runs and rides
                    if (activity.type !== 'Run' && activity.type !== 'Ride') continue;
                    
                    const activityType = activity.type === 'Run' ? 'run' : 'ride';
                    const distance = activity.distance / 1000; // Convert meters to kilometers
                    const points = activityType === 'run' ? distance * 2 : distance;
                    
                    // Create activity object
                    const newActivity = {
                        id: `strava-${activity.id}`,
                        participantId: this.state.user.id,
                        name: activity.name,
                        type: activityType,
                        distance: distance,
                        date: new Date(activity.start_date).toISOString(),
                        pace: activityType === 'run' ? (activity.moving_time / 60) / distance : 0, // minutes per km
                        speed: activityType === 'ride' ? (distance / (activity.moving_time / 3600)) : 0, // km/h
                        highFives: 0 // Start with zero high fives
                    };
                    
                    newActivities.push(newActivity);
                    
                    // Update user stats
                    this.state.user.points += points;
                    if (activityType === 'run') {
                        this.state.user.runDistance += distance;
                    } else {
                        this.state.user.rideDistance += distance;
                    }
                }
                
                debug(`Created ${newActivities.length} new activity objects`);
                
                // Update user in participants list and Firebase
                const userIndex = this.state.participants.findIndex(p => p.id === this.state.user.id);
                if (userIndex >= 0) {
                    // Update local state
                    this.state.participants[userIndex] = { ...this.state.user };
                    
                    // Update Firebase
                    await this.firebase.updateParticipant(this.state.user.id, {
                        points: this.state.user.points,
                        runDistance: this.state.user.runDistance,
                        rideDistance: this.state.user.rideDistance
                    });
                    
                    // Update localStorage
                    localStorage.setItem('wyzwanie2025_user', JSON.stringify(this.state.user));
                    
                    debug("Updated user stats");
                }
                
                // Save new activities to Firebase
                if (newActivities.length > 0) {
                    debug("Saving new activities to Firebase/localStorage");
                    await this.firebase.saveActivities(newActivities);
                }
                
                // Update local activities
                this.state.activities = [...existingActivitiesForOtherUsers, ...newActivities];
                this.sortActivities();
                
                debug("Strava activities processed successfully");
            }

            async generateMockActivitiesForUser(user) {
                // For demo/test mode only
                if (!user) {
                    debug("No user, cannot generate mock activities");
                    return;
                }
                
                debug(`Generating mock activities for user: ${user.name}`);
                
                // Reset user stats
                user.points = 0;
                user.runDistance = 0;
                user.rideDistance = 0;
                
                // Generate 10-20 random activities
                const numActivities = 10 + Math.floor(Math.random() * 11);
                const newActivities = [];
                const activityNames = [
                    'Poranny trening',
                    'Popo≈Çudniowy bieg',
                    'Weekendowy d≈Çugi bieg',
                    'Interwa≈Çy na bie≈ºni',
                    'Regeneracyjne bieganie',
                    'Tempo run',
                    'Jogging z przyjaci√≥≈Çmi',
                    'Trening szybko≈õciowy',
                    'D≈Çugi rower',
                    'MTB na trasie',
                    'Przeja≈ºd≈ºka po mie≈õcie'
                ];
                
                // Start date for activities
                const startDate = new Date(this.state.challengeStartDate);
                startDate.setDate(startDate.getDate() + 1);
                
                // End date for activities
                const endDate = new Date(Math.min(new Date(), this.state.challengeEndDate));
                
                // Get existing activities for other users
                const existingActivitiesForOtherUsers = this.state.activities.filter(a => a.participantId !== user.id);
                
                // Generate activities
                for (let i = 0; i < numActivities; i++) {
                    // Random date between startDate and endDate
                    const activityDate = new Date(startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime()));
                    
                    // Determine activity type based on user role
                    let activityType;
                    if (user.role === 'runner') {
                        activityType = 'run';
                    } else if (user.role === 'cyclist') {
                        activityType = 'ride';
                    } else {
                        // Combined role - randomly choose run or ride
                        activityType = Math.random() < 0.5 ? 'run' : 'ride';
                    }
                    
                    // Random distance (3-30km for runs, 10-80km for rides)
                    const distance = activityType === 'run' 
                        ? 3 + Math.random() * 27 
                        : 10 + Math.random() * 70;
                    
                    // Random pace for runs (4-7 min/km)
                    const pace = 4 + Math.random() * 3; // minutes per km
                    
                    // Random speed for rides (15-35 km/h)
                    const speed = 15 + Math.random() * 20;
                    
                    // Calculate points
                    const points = activityType === 'run' ? distance * 2 : distance;
                    
                    // Generate Strava activity ID
                    const stravaActivityId = `mock-${Date.now()}-${i}`;
                    
                    // Create activity
                    const activity = {
                        id: `strava-${stravaActivityId}`,
                        participantId: user.id,
                        name: activityNames[Math.floor(Math.random() * activityNames.length)],
                        type: activityType,
                        distance: distance,
                        date: activityDate.toISOString(),
                        pace: pace * 60, // Convert to seconds
                        speed: speed,
                        highFives: 0
                    };
                    
                    newActivities.push(activity);
                    
                    // Update user stats
                    user.points += points;
                    if (activityType === 'run') {
                        user.runDistance += distance;
                    } else {
                        user.rideDistance += distance;
                    }
                }
                
                debug(`Generated ${newActivities.length} mock activities`);
                
                // Update user in participants list and Firebase
                const userIndex = this.state.participants.findIndex(p => p.id === user.id);
                if (userIndex >= 0) {
                    // Update local state
                    this.state.participants[userIndex] = { ...user };
                    
                    // Update Firebase
                    await this.firebase.updateParticipant(user.id, {
                        points: user.points,
                        runDistance: user.runDistance,
                        rideDistance: user.rideDistance
                    });
                    
                    // Update localStorage
                    localStorage.setItem('wyzwanie2025_user', JSON.stringify(user));
                    
                    debug("Updated user stats");
                }
                
                // Save new activities to Firebase
                if (newActivities.length > 0) {
                    debug("Saving mock activities to Firebase/localStorage");
                    await this.firebase.saveActivities(newActivities);
                }
                
                // Update local activities
                this.state.activities = [...existingActivitiesForOtherUsers, ...newActivities];
                this.sortActivities();
                
                this.showNotification(
                    "Demo aktywno≈õci", 
                    "Wygenerowano przyk≈Çadowe aktywno≈õci dla Twojego konta.", 
                    "info"
                );
                
                debug("Mock activities generation complete");
            }

            async sendHighFive(activityId) {
                debug(`Sending high five for activity ${activityId}`);
                // Find activity
                const activityIndex = this.state.activities.findIndex(a => a.id === activityId);
                
                if (activityIndex >= 0) {
                    // Increment high fives for this activity
                    const activity = this.state.activities[activityIndex];
                    activity.highFives = (activity.highFives || 0) + 1;
                    
                    // Update in state
                    this.state.activities[activityIndex] = activity;
                    
                    // Update in Firebase
                    try {
                        await this.firebase.updateActivity(activity.id, {
                            highFives: activity.highFives
                        });
                        
                        // Find participant
                        const participant = this.state.participants.find(p => p.id === activity.participantId);
                        
                        // Show notification
                        this.showNotification(
                            "Wys≈Çano piƒÖtkƒô!", 
                            `Wys≈Ça≈Çe≈õ piƒÖtkƒô dla aktywno≈õci "${activity.name}" u≈ºytkownika ${participant.name}.`, 
                            "success"
                        );
                        
                        debug("High five sent successfully");
                    } catch (error) {
                        debug('Error sending high five:', error);
                        this.showNotification("B≈ÇƒÖd", "Nie uda≈Ço siƒô wys≈Çaƒá piƒÖtki. Spr√≥buj ponownie.", "error");
                    }
                } else {
                    debug("Activity not found");
                }
            }

            showLoadingModal(message) {
                debug(`Showing loading modal: ${message}`);
                document.getElementById('loading-message').textContent = message;
                document.getElementById('loading-modal').classList.add('visible');
            }

            hideLoadingModal() {
                debug("Hiding loading modal");
                document.getElementById('loading-modal').classList.remove('visible');
            }

            showNotification(title, message, type = 'info') {
                debug(`Showing notification: ${title}`, { message, type });
                const notification = document.getElementById('notification');
                const notificationTitle = notification.querySelector('.notification-title');
                const notificationText = document.getElementById('notification-text');
                const notificationIcon = notification.querySelector('.notification-icon i');
                
                // Set content
                notificationTitle.textContent = title;
                notificationText.textContent = message;
                
                // Set icon based on type
                switch (type) {
                    case 'success':
                        notificationIcon.className = 'fa fa-check';
                        notificationIcon.style.color = '#27ae60';
                        break;
                    case 'error':
                        notificationIcon.className = 'fa fa-times';
                        notificationIcon.style.color = '#e74c3c';
                        break;
                    case 'warning':
                        notificationIcon.className = 'fa fa-exclamation';
                        notificationIcon.style.color = '#f39c12';
                        break;
                    default: // info
                        notificationIcon.className = 'fa fa-info-circle';
                        notificationIcon.style.color = '#3498db';
                        break;
                }
                
                // Show notification
                notification.classList.add('visible');
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('visible');
                }, 5000);
            }

            showConfetti() {
                debug("Showing confetti animation");
                const container = document.getElementById('confetti-container');
                container.innerHTML = '';
                
                const colors = ['#f44336', '#2196F3', '#FFEB3B', '#4CAF50', '#9C27B0'];
                
                // Create confetti pieces
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = -10 + 'px';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = 3 + Math.random() * 2 + 's';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    
                    container.appendChild(confetti);
                }
                
                // Clean up after animation
                setTimeout(() => {
                    container.innerHTML = '';
                }, 6000);
            }

            formatPace(paceInSeconds) {
                const minutes = Math.floor(paceInSeconds / 60);
                const seconds = Math.floor(paceInSeconds % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')} min/km`;
            }

            formatDateForInput(date) {
                return date.toISOString().split('T')[0];
            }

            initServiceWorker() {
                debug("Initializing service worker");
                if ('serviceWorker' in navigator) {
                    // Register service worker from inline script
                    const swCode = `
                        self.addEventListener('install', (event) => {
                            event.waitUntil(
                                caches.open('wyzwanie2025-v1').then((cache) => {
                                    return cache.addAll([
                                        './',
                                        './index.html'
                                    ]);
                                })
                            );
                        });
                        
                        self.addEventListener('fetch', (event) => {
                            // Don't cache Firebase API calls and Strava API calls
                            if (event.request.url.includes('firebaseio.com') || 
                                event.request.url.includes('api.strava.com')) {
                                return fetch(event.request);
                            }
                            
                            event.respondWith(
                                caches.match(event.request).then((response) => {
                                    return response || fetch(event.request).then((fetchRes) => {
                                        return caches.open('wyzwanie2025-v1').then((cache) => {
                                            cache.put(event.request, fetchRes.clone());
                                            return fetchRes;
                                        });
                                    });
                                }).catch(() => {
                                    // Return offline fallback
                                    if (event.request.headers.get('accept').includes('text/html')) {
                                        return caches.match('./index.html');
                                    }
                                })
                            );
                        });
                    `;
                    
                    // Create a Blob containing the service worker code
                    const blob = new Blob([swCode], {type: 'application/javascript'});
                    const swUrl = URL.createObjectURL(blob);
                    
                    // Register the service worker
                    navigator.serviceWorker.register(swUrl)
                        .then((registration) => {
                            debug('Service Worker registered with scope:', registration.scope);
                        })
                        .catch((error) => {
                            debug('Service Worker registration failed:', error);
                        });
                } else {
                    debug("Service Worker API not available in this browser");
                }
            }

            setupPWA() {
                debug("Setting up PWA installation");
                // Listen for beforeinstallprompt event
                window.addEventListener('beforeinstallprompt', (e) => {
                    // Prevent Chrome from automatically showing the prompt
                    e.preventDefault();
                    // Stash the event so it can be triggered later
                    this.state.deferredPrompt = e;
                    
                    debug("PWA install prompt detected and deferred");
                    
                    // Show the install banner if not previously closed
                    const bannerClosed = localStorage.getItem('wyzwanie2025_installBannerClosed');
                    if (!bannerClosed) {
                        document.getElementById('install-banner').classList.add('visible');
                    }
                });
                
                // Listen for app installed event
                window.addEventListener('appinstalled', () => {
                    // Hide the install banner
                    document.getElementById('install-banner').classList.remove('visible');
                    // Clear the deferredPrompt
                    this.state.deferredPrompt = null;
                    // Log the installation
                    debug("PWA was installed");
                });
            }

            installPWA() {
                debug("Installing PWA");
                if (this.state.deferredPrompt) {
                    // Show the install prompt
                    this.state.deferredPrompt.prompt();
                    
                    // Wait for the user to respond to the prompt
                    this.state.deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            debug("User accepted the install prompt");
                        } else {
                            debug("User dismissed the install prompt");
                        }
                        // Clear the deferredPrompt
                        this.state.deferredPrompt = null;
                    });
                } else {
                    debug("No deferred prompt available, cannot install");
                }
            }
        }

        // Initialize the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            try {
                debug("DOM loaded, initializing app");
                const app = new WyzwanieApp();
            } catch (error) {
                console.error("Error initializing app:", error);
                debug("Critical error during app initialization:", error);
                
                // Show error notification
                const notification = document.getElementById('notification');
                const notificationTitle = notification.querySelector('.notification-title');
                const notificationText = document.getElementById('notification-text');
                const notificationIcon = notification.querySelector('.notification-icon i');
                
                notificationTitle.textContent = "B≈ÇƒÖd inicjalizacji";
                notificationText.textContent = "WystƒÖpi≈Ç problem podczas ≈Çadowania aplikacji. Od≈õwie≈º stronƒô lub spr√≥buj ponownie p√≥≈∫niej.";
                notificationIcon.className = 'fa fa-bug';
                notificationIcon.style.color = '#e74c3c';
                
                notification.classList.add('visible');
            }
        });
    </script>
</body>
</html>
