<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#005dac">
    <title>Wyzwanie 2025</title>
    
    <!-- PWA manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiV3l6d2FuaWUgMjAyNSIsInNob3J0X25hbWUiOiJXeXp3YW5pZSAyMDI1IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBSUFBQUFDQUNBTUFBQUFwQVRCpQT09Iiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9XSwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJzdGFydF91cmwiOiIvIiwib3JpZW50YXRpb24iOiJwb3J0cmFpdCIsImJhY2tncm91bmRfY29sb3IiOiIjMDA1ZGFjIiwidGhlbWVfY29sb3IiOiIjMDA1ZGFjIn0=">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAGBQTFRFAAAAACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6ACZ6////drQh3QAAAAdFJOUwB8DhgHNVVnqQEmWGsAAAABYktHRCCzaz2AAAAAo0lEQVR42u3PNxLCQBREwQGiYNa5tP/FYByQFRoXlV+ddx+Gb8I4zfOyrMJaa5NjtdabTbzV7qDTIw8RERERERERERERERERERH9oK6qqm4UvW3bbtdN3a7r+mPqpmk+lmX5vPLYr86FEI6N3p9iyOcmno/FxSWl67W8FmO63aenew6P51BdXul9e7/H8flK9/3n++cv+gMAAAAAAAAAAAAAAAAAAAB8AHiLEABj0lwvAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDI0LTAzLTA0VDIwOjM1OjA1KzAwOjAwlg/lSgAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyNC0wMy0wNFQyMDozNTowNSswMDowMOdSXfYAAAAASUVORK5CYII=">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #005dac;
            --action-color: #1cb954;
            --text-color: #343434;
            --background-color: #f5f5f7;
            --card-background: #ffffff;
            --border-radius: 8px;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
            --runner-color: #ff5252;
            --cyclist-color: #4caf50;
            --dual-color: #9c27b0;
            
            /* Safe area variables for notched devices */
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #1e1e1e;
                --card-background: #2d2d2d;
                --text-color: #e0e0e0;
                --shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            padding: calc(10px + var(--safe-area-inset-top)) 
                    calc(10px + var(--safe-area-inset-right)) 
                    calc(10px + var(--safe-area-inset-bottom)) 
                    calc(10px + var(--safe-area-inset-left));
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
        }
        
        /* Header Styles */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }
        
        /* Rules Section */
        .rules-section {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .rules-section h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .countdown {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 15px 0;
        }
        
        /* Join Button */
        .join-btn {
            background-color: var(--action-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            margin: 20px auto;
            box-shadow: var(--shadow);
        }
        
        .join-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .join-btn i {
            font-size: 1.2rem;
        }
        
        /* Progress Chart */
        .chart-container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            position: relative;
            height: 400px;
        }
        
        .chart-container h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        /* Participants List */
        .participants-section {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .participants-section h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .participant-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.08);
            cursor: pointer;
        }
        
        .participant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .ranking {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .rank-1 {
            background-color: var(--gold);
            color: black;
        }
        
        .rank-2 {
            background-color: var(--silver);
            color: black;
        }
        
        .rank-3 {
            background-color: var(--bronze);
            color: white;
        }
        
        .participant-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .participant-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }
        
        .participant-level-1 .participant-avatar {
            border-color: #7986cb;
        }
        
        .participant-level-2 .participant-avatar {
            border-color: #4db6ac;
        }
        
        .participant-level-3 .participant-avatar {
            border-color: #ffb74d;
        }
        
        .participant-level-4 .participant-avatar {
            border-color: #ff8a65;
        }
        
        .participant-level-5 .participant-avatar {
            border-color: #e57373;
        }
        
        .participant-info {
            flex: 1;
        }
        
        .participant-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .participant-role {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .role-runner {
            background-color: rgba(255, 82, 82, 0.2);
            color: var(--runner-color);
        }
        
        .role-cyclist {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--cyclist-color);
        }
        
        .role-dual {
            background-color: rgba(156, 39, 176, 0.2);
            color: var(--dual-color);
        }
        
        .participant-stats {
            margin-top: 10px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            width: 0;
            transition: width 1s ease;
        }
        
        .progress-runner {
            background-color: var(--runner-color);
        }
        
        .progress-cyclist {
            background-color: var(--cyclist-color);
        }
        
        .progress-dual {
            background: linear-gradient(to right, var(--runner-color), var(--dual-color), var(--cyclist-color));
        }
        
        /* Recent Activities Section */
        .activities-section {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .activities-section h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .activities-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .activity-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: var(--border-radius);
            background-color: rgba(0, 0, 0, 0.03);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .activity-card:hover {
            background-color: rgba(0, 0, 0, 0.06);
            transform: translateX(5px);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }
        
        .icon-run {
            background-color: var(--runner-color);
        }
        
        .icon-bike {
            background-color: var(--cyclist-color);
        }
        
        .activity-details {
            flex: 1;
        }
        
        .activity-title {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .activity-user {
            font-size: 0.85rem;
            color: #666;
        }
        
        .activity-metrics {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }
        
        .activity-metric {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .activity-metric i {
            color: var(--primary-color);
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .pagination-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 16px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .pagination-btn:hover {
            background-color: #004d8a;
        }
        
        .pagination-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 30px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            transition: var(--transition);
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .modal-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Role Selection */
        .role-options {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .role-option {
            flex: 1;
            min-width: 120px;
            background-color: var(--card-background);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .role-option:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .role-option.selected {
            border-color: var(--action-color);
            box-shadow: 0 0 0 2px rgba(28, 185, 84, 0.3);
        }
        
        .role-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .runner-icon {
            color: var(--runner-color);
        }
        
        .cyclist-icon {
            color: var(--cyclist-color);
        }
        
        .dual-icon {
            color: var(--dual-color);
        }
        
        .role-details {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .connect-btn {
            background-color: #fc4c02; /* Strava orange */
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            margin: 0 auto;
            width: 100%;
            max-width: 300px;
        }
        
        .connect-btn:hover {
            background-color: #e34402;
        }
        
        /* Admin panel styles */
        .admin-panel-content h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .admin-section {
            margin-bottom: 25px;
        }
        
        .admin-section h3 {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .admin-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            transition: var(--transition);
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .admin-btn:hover {
            background-color: #004d8a;
        }
        
        .danger-btn {
            background-color: #ff5252;
        }
        
        .danger-btn:hover {
            background-color: #d32f2f;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .admin-table th, .admin-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .admin-table th {
            background-color: #f5f5f5;
        }
        
        /* Badges */
        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .badge i {
            color: var(--primary-color);
        }
        
        .badge-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s;
            pointer-events: none;
            z-index: 10;
        }
        
        .badge:hover .badge-tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        /* Loading Animation */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--action-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Install Banner */
        .install-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .install-banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .install-btn {
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-banner {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        /* Footer with admin link */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .admin-link {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }
        
        .admin-link:hover {
            text-decoration: underline;
        }
        
        /* Mobile Styles */
        @media (max-width: 768px) {
            .participants-grid {
                grid-template-columns: 1fr;
            }
            
            .role-options {
                flex-direction: column;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .activity-metrics {
                flex-direction: column;
                gap: 5px;
            }
            
            /* Mobile navigation for installed PWA */
            .mobile-nav {
                display: none;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: var(--card-background);
                padding: 10px 0;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                z-index: 100;
            }
            
            .mobile-nav-links {
                display: flex;
                justify-content: space-around;
            }
            
            .mobile-nav-link {
                display: flex;
                flex-direction: column;
                align-items: center;
                color: var(--text-color);
                text-decoration: none;
                font-size: 0.8rem;
            }
            
            .mobile-nav-link i {
                font-size: 1.5rem;
                margin-bottom: 3px;
            }
            
            .mobile-nav-link.active {
                color: var(--action-color);
            }
            
            /* Adjust padding for installed PWA */
            body.pwa-installed {
                padding-bottom: 70px;
            }
        }
        
        /* For larger desktop screens */
        @media (min-width: 1400px) {
            .container {
                max-width: 1400px;
            }
            
            .participants-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .slide-up {
            animation: slideUp 0.5s ease forwards;
        }
        
        /* Confetti animation for achievements */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2000;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f0f;
            opacity: 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Wyzwanie 2025</h1>
    </header>
    
    <div class="container">
        <section class="rules-section">
            <h2>Zasady wyzwania</h2>
            <ul>
                <li>Wyzwanie trwa od 1 kwietnia do 30 września 2025</li>
                <li>Cel: zdobyć 2000 punktów jako pierwszy lub mieć najwięcej punktów na koniec wyzwania</li>
                <li>Biegacze: 2 punkty za każdy kilometr biegu</li>
                <li>Rowerzyści: 1 punkt za każdy kilometr jazdy na rowerze</li>
                <li>Biegacze/rowerzyści: punkty z obu aktywności</li>
                <li>Po dołączeniu nie możesz zmienić wybranej roli</li>
            </ul>
            <div class="countdown" id="countdown">
                Do rozpoczęcia: <span id="countdown-value">...</span>
            </div>
            <button class="join-btn" id="join-btn">
                <i class="fas fa-user-plus"></i> Dołącz do wyzwania
            </button>
        </section>
        
        <section class="chart-container">
            <h2>Wykres postępu</h2>
            <canvas id="progressChart"></canvas>
        </section>
        
        <section class="participants-section">
            <h2>Ranking uczestników</h2>
            <div class="participants-grid" id="participants-grid">
                <!-- Participant cards will be dynamically generated here -->
            </div>
        </section>
        
        <section class="activities-section">
            <h2>Ostatnie aktywności</h2>
            <div class="activities-list" id="activities-list">
                <!-- Activity cards will be dynamically generated here -->
            </div>
            <div class="pagination">
                <button class="pagination-btn" id="prev-page" disabled>Poprzednia</button>
                <button class="pagination-btn" id="next-page">Następna</button>
            </div>
        </section>
    </div>
    
    <div class="install-banner" id="install-banner">
        <div class="install-banner-content">
            <span>Zainstaluj aplikację Wyzwanie 2025 na swoim urządzeniu!</span>
            <button class="install-btn" id="install-btn">Zainstaluj</button>
            <button class="close-banner" id="close-banner"><i class="fas fa-times"></i></button>
        </div>
    </div>
    
    <nav class="mobile-nav" id="mobile-nav">
        <div class="mobile-nav-links">
            <a href="#" class="mobile-nav-link active" data-section="rules-section">
                <i class="fas fa-list-ul"></i>
                <span>Zasady</span>
            </a>
            <a href="#" class="mobile-nav-link" data-section="chart-container">
                <i class="fas fa-chart-line"></i>
                <span>Wykres</span>
            </a>
            <a href="#" class="mobile-nav-link" data-section="participants-section">
                <i class="fas fa-users"></i>
                <span>Ranking</span>
            </a>
            <a href="#" class="mobile-nav-link" data-section="activities-section">
                <i class="fas fa-running"></i>
                <span>Aktywności</span>
            </a>
        </div>
    </nav>
    
    <!-- Join Modal -->
    <div class="modal" id="join-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-join-modal"><i class="fas fa-times"></i></button>
            <h2 class="modal-title">Dołącz do wyzwania</h2>
            
            <div id="role-selection">
                <h3>Wybierz swoją rolę:</h3>
                <div class="role-options">
                    <div class="role-option" data-role="runner">
                        <div class="role-icon runner-icon">
                            <i class="fas fa-running"></i>
                        </div>
                        <h4>Biegacz</h4>
                        <div class="role-details">
                            <p>2 punkty za każdy kilometr biegu</p>
                            <p>Tylko aktywności biegowe</p>
                        </div>
                    </div>
                    
                    <div class="role-option" data-role="cyclist">
                        <div class="role-icon cyclist-icon">
                            <i class="fas fa-biking"></i>
                        </div>
                        <h4>Rowerzysta</h4>
                        <div class="role-details">
                            <p>1 punkt za każdy kilometr jazdy</p>
                            <p>Tylko aktywności rowerowe</p>
                        </div>
                    </div>
                    
                    <div class="role-option" data-role="dual">
                        <div class="role-icon dual-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h4>Biegacz/Rowerzysta</h4>
                        <div class="role-details">
                            <p>Punkty z obu aktywności</p>
                            <p>2 pkt/km (bieg), 1 pkt/km (rower)</p>
                        </div>
                    </div>
                </div>
                
                <button class="connect-btn" id="connect-strava-btn" disabled>
                    <i class="fab fa-strava"></i> Połącz ze Strava
                </button>
            </div>
            
            <div id="connecting-strava" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Łączenie z kontem Strava...</p>
            </div>
        </div>
    </div>
    
    <!-- Admin Modal -->
    <div class="modal" id="admin-modal">
        <div class="modal-content admin-panel-content">
            <button class="close-modal" id="close-admin-modal"><i class="fas fa-times"></i></button>
            <h2 class="modal-title">Panel Administratora</h2>
            
            <div id="admin-login" style="display: block;">
                <div class="form-group">
                    <label for="admin-password">Hasło administratora:</label>
                    <input type="password" id="admin-password" placeholder="Wprowadź hasło...">
                </div>
                <button class="admin-btn" id="admin-login-btn">Zaloguj</button>
            </div>
            
            <div id="admin-panel" style="display: none;">
                <div class="admin-section">
                    <h3>Parametry wyzwania</h3>
                    <div class="form-group">
                        <label for="start-date">Data rozpoczęcia:</label>
                        <input type="date" id="start-date" value="2025-04-01">
                    </div>
                    <div class="form-group">
                        <label for="end-date">Data zakończenia:</label>
                        <input type="date" id="end-date" value="2025-09-30">
                    </div>
                    <div class="form-group">
                        <label for="point-goal">Cel punktowy:</label>
                        <input type="number" id="point-goal" value="2000">
                    </div>
                    <button class="admin-btn" id="save-params-btn">Zapisz parametry</button>
                </div>
                
                <div class="admin-section">
                    <h3>Tryb testowy</h3>
                    <div class="form-group">
                        <label for="test-participants">Liczba testowych uczestników:</label>
                        <input type="number" id="test-participants" value="5" min="1" max="20">
                    </div>
                    <button class="admin-btn" id="generate-test-data-btn">Generuj dane testowe</button>
                    <button class="admin-btn danger-btn" id="reset-test-data-btn">Resetuj dane testowe</button>
                </div>
                
                <div class="admin-section">
                    <h3>Uczestnicy</h3>
                    <table class="admin-table" id="admin-participants-table">
                        <thead>
                            <tr>
                                <th>Nazwa</th>
                                <th>Rola</th>
                                <th>Punkty</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamically filled -->
                        </tbody>
                    </table>
                </div>
                
                <div class="admin-section">
                    <h3>Logi i statystyki</h3>
                    <div id="admin-logs">
                        <p>Ostatnie odświeżenie danych: <span id="last-refresh">-</span></p>
                        <p>Liczba uczestników: <span id="participant-count">0</span></p>
                        <p>Liczba aktywności: <span id="activity-count">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="confetti-container" id="confetti-container"></div>
    
    <footer>
        <p>Wyzwanie 2025 &copy; 2025 | <a href="#" class="admin-link" id="admin-link">Panel administratora</a></p>
    </footer>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyCxOfhKBNyIzhkkkiHOhXd3x3mfSUMS6M4",
  authDomain: "wyzwanie2025-a6298.firebaseapp.com",
  projectId: "wyzwanie2025-a6298",
  storageBucket: "wyzwanie2025-a6298.firebasestorage.app",
  messagingSenderId: "74567179841",
  appId: "1:74567179841:web:e7bb1c6f12fc64ef5730c0",
  measurementId: "G-D63RBL1K8E"
};
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Strava API Configuration
        const STRAVA_CLIENT_ID = "150694"; // Zastąp swoim prawdziwym CLIENT_ID
        const STRAVA_CLIENT_SECRET = "d780e7a6e9bd2493f4e578d5206d4b6921c0a775"; // Zastąp swoim prawdziwym CLIENT_SECRET
        const STRAVA_REDIRECT_URI = window.location.href.split('?')[0]; // Obecna strona bez parametrów
        
        // Global Variables
        let participants = [];
        let activities = [];
        let currentUser = null;
        let progressChart = null;
        let currentPage = 1;
        let activitiesPerPage = 8;
        let deferredPrompt = null;
        let selectedRole = null;
        let challengeParams = {
            startDate: new Date("2025-04-01T00:00:00"),
            endDate: new Date("2025-09-30T23:59:59"),
            pointGoal: 2000
        };
        
        // DOM Elements
        const countdownElement = document.getElementById('countdown-value');
        const joinBtn = document.getElementById('join-btn');
        const joinModal = document.getElementById('join-modal');
        const closeJoinModal = document.getElementById('close-join-modal');
        const roleOptions = document.querySelectorAll('.role-option');
        const connectStravaBtn = document.getElementById('connect-strava-btn');
        const connectingStravaDiv = document.getElementById('connecting-strava');
        const roleSelectionDiv = document.getElementById('role-selection');
        const progressChartCanvas = document.getElementById('progressChart');
        const participantsGrid = document.getElementById('participants-grid');
        const activitiesList = document.getElementById('activities-list');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const installBanner = document.getElementById('install-banner');
        const installBtn = document.getElementById('install-btn');
        const closeBannerBtn = document.getElementById('close-banner');
        const mobileNav = document.getElementById('mobile-nav');
        const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
        const adminLink = document.getElementById('admin-link');
        const adminModal = document.getElementById('admin-modal');
        const closeAdminModal = document.getElementById('close-admin-modal');
        const adminLoginDiv = document.getElementById('admin-login');
        const adminPanelDiv = document.getElementById('admin-panel');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const pointGoalInput = document.getElementById('point-goal');
        const saveParamsBtn = document.getElementById('save-params-btn');
        const testParticipantsInput = document.getElementById('test-participants');
        const generateTestDataBtn = document.getElementById('generate-test-data-btn');
        const resetTestDataBtn = document.getElementById('reset-test-data-btn');
        const adminParticipantsTable = document.getElementById('admin-participants-table').querySelector('tbody');
        const lastRefreshSpan = document.getElementById('last-refresh');
        const participantCountSpan = document.getElementById('participant-count');
        const activityCountSpan = document.getElementById('activity-count');
        
        // Helper Functions
        function formatDate(date) {
            return new Date(date).toLocaleDateString('pl-PL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function formatTime(date) {
            return new Date(date).toLocaleTimeString('pl-PL', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatDateTime(date) {
            return `${formatDate(date)} ${formatTime(date)}`;
        }
        
        function formatDistance(distance) {
            return (distance / 1000).toFixed(2);
        }
        
        function formatPace(seconds, distance) {
            if (!seconds || !distance) return "-";
            
            const totalMinutes = (seconds / 60) / (distance / 1000);
            const minutes = Math.floor(totalMinutes);
            const secondsRemainder = Math.round((totalMinutes - minutes) * 60);
            
            return `${minutes}:${secondsRemainder.toString().padStart(2, '0')}/km`;
        }
        
        function formatSpeed(speed) {
            return speed ? `${speed.toFixed(1)} km/h` : "-";
        }
        
        function calculatePoints(activity, role) {
            if (!activity || !activity.distance) {
                console.log('Nieprawidłowa aktywność do obliczenia punktów:', activity);
                return 0;
            }
            
            const distanceKm = activity.distance / 1000;
            const activityType = activity.type?.toLowerCase() || '';
            
            // Logowanie dla debugowania
            console.log(`Obliczanie punktów dla aktywności: ${activity.name}, typ: ${activityType}, dystans: ${distanceKm.toFixed(2)} km, rola: ${role}`);
            
            // Aktywności biegowe
            const isRunActivity = activityType.includes('run') || 
                                  activityType.includes('treadmill') || 
                                  activityType === 'track' || 
                                  activityType === 'trail';
            
            // Aktywności rowerowe
            const isRideActivity = activityType.includes('ride') || 
                                   activityType.includes('cycling') || 
                                   activityType === 'virtualride' || 
                                   activityType === 'ebikeride';
            
            if (isRunActivity && (role === 'runner' || role === 'dual')) {
                const points = Math.round(distanceKm * 2);
                console.log(`Punkty za bieg: ${points} (${distanceKm.toFixed(2)} km * 2)`);
                return points;
            } else if (isRideActivity && (role === 'cyclist' || role === 'dual')) {
                const points = Math.round(distanceKm);
                console.log(`Punkty za jazdę na rowerze: ${points} (${distanceKm.toFixed(2)} km * 1)`);
                return points;
            }
            
            console.log('Aktywność nie kwalifikuje się do punktacji');
            return 0;
        }
        
        function isActivityEligible(activity, role) {
            if (!activity || !activity.type) {
                console.log('Nieprawidłowa aktywność:', activity);
                return false;
            }
            
            const activityType = activity.type.toLowerCase();
            
            if (role === 'runner') {
                // Wszystkie aktywności biegowe
                return activityType.includes('run') || 
                       activityType.includes('treadmill') || 
                       activityType === 'track' || 
                       activityType === 'trail';
            } else if (role === 'cyclist') {
                // Wszystkie aktywności rowerowe
                return activityType.includes('ride') || 
                       activityType.includes('cycling') || 
                       activityType === 'virtualride' || 
                       activityType === 'ebikeride';
            } else if (role === 'dual') {
                // Zarówno biegowe jak i rowerowe
                return (activityType.includes('run') || 
                        activityType.includes('treadmill') || 
                        activityType === 'track' || 
                        activityType === 'trail') || 
                       (activityType.includes('ride') || 
                        activityType.includes('cycling') || 
                        activityType === 'virtualride' || 
                        activityType === 'ebikeride');
            }
            
            return false;
        }
        
        function updateCountdown() {
            const now = new Date();
            const start = challengeParams.startDate;
            const end = challengeParams.endDate;
            
            if (now < start) {
                const diff = start - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                countdownElement.textContent = `${days} dni i ${hours} godzin`;
                document.getElementById('countdown').textContent = 'Do rozpoczęcia: ' + countdownElement.textContent;
            } else if (now <= end) {
                const diff = end - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                countdownElement.textContent = `${days} dni i ${hours} godzin`;
                document.getElementById('countdown').textContent = 'Do zakończenia: ' + countdownElement.textContent;
            } else {
                countdownElement.textContent = 'Wyzwanie zakończone';
                document.getElementById('countdown').textContent = countdownElement.textContent;
            }
        }
        
        // Initialize and update the progress chart
        function initProgressChart() {
            const ctx = progressChartCanvas.getContext('2d');
            
            // Create empty chart
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const dataset = context.dataset;
                                    const value = dataset.data[context.dataIndex] || 0;
                                    return `${dataset.label}: ${value} punktów`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' pkt';
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        },
                        point: {
                            radius: 3,
                            hoverRadius: 6
                        }
                    }
                }
            });
        }
        
        function updateProgressChart() {
            // Generate dates array from challenge start to now (or end if challenge ended)
            const now = new Date();
            const startDate = challengeParams.startDate;
            const endDate = now > challengeParams.endDate ? challengeParams.endDate : now;
            
            const dates = [];
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            const formattedDates = dates.map(date => formatDate(date));
            
            // Calculate cumulative points for each participant
            const participantDatasets = participants.map(participant => {
                const pointsHistory = calculateCumulativePoints(participant, dates);
                
                const roleColor = {
                    runner: 'rgb(255, 82, 82)',
                    cyclist: 'rgb(76, 175, 80)',
                    dual: 'rgb(156, 39, 176)'
                };
                
                return {
                    label: participant.name,
                    data: pointsHistory,
                    borderColor: roleColor[participant.role],
                    backgroundColor: roleColor[participant.role] + '20',
                    pointBackgroundColor: roleColor[participant.role],
                    borderWidth: 2,
                    fill: false
                };
            });
            
            // Update chart data
            progressChart.data.labels = formattedDates;
            progressChart.data.datasets = participantDatasets;
            progressChart.update();
        }
        
        function calculateCumulativePoints(participant, dates) {
            const points = [];
            let cumulativePoints = 0;
            
            for (const date of dates) {
                const dateStr = formatDate(date);
                const dateMillis = date.getTime();
                
                // Find activities for this participant on or before this date
                const relevantActivities = activities.filter(activity => {
                    return activity.athleteId === participant.id && 
                           new Date(activity.startDate).getTime() <= dateMillis;
                });
                
                // Calculate total points up to this date
                cumulativePoints = relevantActivities.reduce((sum, activity) => {
                    return sum + activity.points;
                }, 0);
                
                points.push(cumulativePoints);
            }
            
            return points;
        }
        
        // Render participants grid
        function renderParticipants() {
            // Sort participants by points
            const sortedParticipants = [...participants].sort((a, b) => b.totalPoints - a.totalPoints);
            
            participantsGrid.innerHTML = '';
            
            sortedParticipants.forEach((participant, index) => {
                const rank = index + 1;
                const pointsToGoal = Math.max(0, challengeParams.pointGoal - participant.totalPoints);
                const progressPercentage = Math.min(100, (participant.totalPoints / challengeParams.pointGoal) * 100);
                
                // Determine participant level
                let level = 1;
                if (participant.totalPoints >= 250) level = 1;
                if (participant.totalPoints >= 750) level = 2;
                if (participant.totalPoints >= 1500) level = 3;
                if (participant.totalPoints >= 2000) level = 4;
                
                const card = document.createElement('div');
                card.className = `participant-card participant-level-${level} fade-in`;
                card.setAttribute('data-id', participant.id);
                card.addEventListener('click', () => {
                    window.open(`https://www.strava.com/athletes/${participant.id}`, '_blank');
                });
                
                // Role icon and color
                let roleIcon, roleClass;
                if (participant.role === 'runner') {
                    roleIcon = 'fa-running';
                    roleClass = 'role-runner';
                } else if (participant.role === 'cyclist') {
                    roleIcon = 'fa-biking';
                    roleClass = 'role-cyclist';
                } else {
                    roleIcon = 'fa-trophy';
                    roleClass = 'role-dual';
                }
                
                // Progress bar class
                let progressClass;
                if (participant.role === 'runner') {
                    progressClass = 'progress-runner';
                } else if (participant.role === 'cyclist') {
                    progressClass = 'progress-cyclist';
                } else {
                    progressClass = 'progress-dual';
                }
                
                // Rank badge
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                if (rank === 2) rankClass = 'rank-2';
                if (rank === 3) rankClass = 'rank-3';
                
                card.innerHTML = `
                    <div class="ranking ${rankClass}">#${rank}</div>
                    <div class="participant-header">
                        <img src="${participant.profile}" alt="${participant.name}" class="participant-avatar">
                        <div class="participant-info">
                            <div class="participant-name">${participant.name}</div>
                            <div class="participant-role ${roleClass}">
                                <i class="fas ${roleIcon}"></i>
                                ${participant.role === 'runner' ? 'Biegacz' : participant.role === 'cyclist' ? 'Rowerzysta' : 'Biegacz/Rowerzysta'}
                            </div>
                        </div>
                    </div>
                    <div class="participant-stats">
                        <div class="stat-row">
                            <div class="stat-label">Punkty:</div>
                            <div class="stat-value">${participant.totalPoints}</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-label">Do celu:</div>
                            <div class="stat-value">${pointsToGoal}</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-label">${participant.role === 'runner' ? 'Przebiegane km:' : participant.role === 'cyclist' ? 'Przejechane km:' : 'Suma km:'}</div>
                            <div class="stat-value">${participant.totalDistance.toFixed(1)} km</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${progressClass}" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="badges-container">
                        ${renderBadges(participant)}
                    </div>
                `;
                
                participantsGrid.appendChild(card);
            });
        }
        
        // Render badges for a participant
        function renderBadges(participant) {
            const badges = [];
            
            // Progress badges
            if (participant.totalPoints >= 100) {
                badges.push({icon: 'fa-flag-checkered', name: 'Pierwszy krok'});
            }
            if (participant.totalPoints >= 250) {
                badges.push({icon: 'fa-shoe-prints', name: 'Dobry początek'});
            }
            if (participant.totalPoints >= 500) {
                badges.push({icon: 'fa-road', name: 'Na dobrej drodze'});
            }
            if (participant.totalPoints >= 750) {
                badges.push({icon: 'fa-mountain', name: 'Wytrwały uczestnik'});
            }
            if (participant.totalPoints >= 1000) {
                badges.push({icon: 'fa-medal', name: 'Półmetek'});
            }
            if (participant.totalPoints >= 1500) {
                badges.push({icon: 'fa-award', name: 'Mistrz wytrwałości'});
            }
            if (participant.totalPoints >= 2000) {
                badges.push({icon: 'fa-trophy', name: 'Zwycięzca wyzwania'});
            }
            
            // Only show up to 5 badges
            const displayBadges = badges.slice(-5);
            
            return displayBadges.map(badge => {
                return `
                <div class="badge">
                    <i class="fas ${badge.icon}"></i>
                    <div class="badge-tooltip">${badge.name}</div>
                </div>
                `;
            }).join('');
        }
        
        // Render recent activities
        function renderActivities() {
            // Sort activities by date (newest first)
            const sortedActivities = [...activities].sort((a, b) => {
                return new Date(b.startDate) - new Date(a.startDate);
            });
            
            const startIndex = (currentPage - 1) * activitiesPerPage;
            const endIndex = startIndex + activitiesPerPage;
            const paginatedActivities = sortedActivities.slice(startIndex, endIndex);
            
            activitiesList.innerHTML = '';
            
            if (paginatedActivities.length === 0) {
                activitiesList.innerHTML = '<p class="no-activities">Brak aktywności do wyświetlenia</p>';
                return;
            }
            
            paginatedActivities.forEach(activity => {
                const participant = participants.find(p => p.id === activity.athleteId);
                if (!participant) return;
                
                const activityCard = document.createElement('div');
                activityCard.className = 'activity-card slide-up';
                activityCard.addEventListener('click', () => {
                    window.open(`https://www.strava.com/activities/${activity.id}`, '_blank');
                });
                
                // Activity icon based on type
                let iconClass = activity.type.includes('Run') ? 'icon-run' : 'icon-bike';
                let iconFA = activity.type.includes('Run') ? 'fa-running' : 'fa-biking';
                
                activityCard.innerHTML = `
                    <div class="activity-icon ${iconClass}">
                        <i class="fas ${iconFA}"></i>
                    </div>
                    <div class="activity-details">
                        <div class="activity-title">${activity.name}</div>
                        <div class="activity-user">${participant.name} · ${formatDate(activity.startDate)}</div>
                        <div class="activity-metrics">
                            <div class="activity-metric">
                                <i class="fas fa-ruler-horizontal"></i>
                                ${formatDistance(activity.distance)} km
                            </div>
                            <div class="activity-metric">
                                <i class="fas fa-stopwatch"></i>
                                ${activity.type.includes('Run') ? formatPace(activity.movingTime, activity.distance) : formatSpeed(activity.averageSpeed)}
                            </div>
                            <div class="activity-metric">
                                <i class="fas fa-star"></i>
                                +${activity.points} pkt
                            </div>
                        </div>
                    </div>
                `;
                
                activitiesList.appendChild(activityCard);
            });
            
            // Update pagination buttons
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = endIndex >= sortedActivities.length;
        }
        
        // Load data from Firebase
        async function loadData() {
            try {
                // Load challenge parameters
                const paramsDoc = await db.collection('challengeParams').doc('main').get();
                if (paramsDoc.exists) {
                    const params = paramsDoc.data();
                    challengeParams = {
                        startDate: params.startDate.toDate(),
                        endDate: params.endDate.toDate(),
                        pointGoal: params.pointGoal
                    };
                    
                    // Update inputs in admin panel
                    startDateInput.value = challengeParams.startDate.toISOString().split('T')[0];
                    endDateInput.value = challengeParams.endDate.toISOString().split('T')[0];
                    pointGoalInput.value = challengeParams.pointGoal;
                } else {
                    console.warn('Nie znaleziono parametrów wyzwania, tworzenie domyślnych...');
                    // Ustaw domyślne parametry wyzwania na rok 2024 (bieżący rok)
                    const currentYear = new Date().getFullYear();
                    const defaultStartDate = new Date(`${currentYear}-01-01T00:00:00`);
                    const defaultEndDate = new Date(`${currentYear}-12-31T23:59:59`);
                    
                    await db.collection('challengeParams').doc('main').set({
                        startDate: firebase.firestore.Timestamp.fromDate(defaultStartDate),
                        endDate: firebase.firestore.Timestamp.fromDate(defaultEndDate),
                        pointGoal: 2000
                    });
                    
                    challengeParams = {
                        startDate: defaultStartDate,
                        endDate: defaultEndDate,
                        pointGoal: 2000
                    };
                    
                    // Update inputs in admin panel
                    startDateInput.value = challengeParams.startDate.toISOString().split('T')[0];
                    endDateInput.value = challengeParams.endDate.toISOString().split('T')[0];
                    pointGoalInput.value = challengeParams.pointGoal;
                }
                
                console.log('Załadowane parametry wyzwania:', {
                    startDate: challengeParams.startDate.toLocaleDateString(),
                    endDate: challengeParams.endDate.toLocaleDateString(),
                    pointGoal: challengeParams.pointGoal
                });
                
                // Load participants
                const participantsSnapshot = await db.collection('participants').get();
                participants = participantsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        name: data.name,
                        profile: data.profile,
                        role: data.role,
                        totalPoints: data.totalPoints || 0,
                        totalDistance: data.totalDistance || 0
                    };
                });
                
                // Load activities
                const activitiesSnapshot = await db.collection('activities').get();
                activities = activitiesSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        athleteId: data.athleteId,
                        name: data.name,
                        type: data.type,
                        startDate: data.startDate.toDate(),
                        distance: data.distance,
                        movingTime: data.movingTime,
                        averageSpeed: data.averageSpeed,
                        points: data.points
                    };
                });
                
                // Update UI
                updateCountdown();
                updateProgressChart();
                renderParticipants();
                renderActivities();
                updateAdminStats();
                
                // Check if current user is a participant
                checkCurrentUser();
                
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                return false;
            }
        }
        
        // Check if current user is already a participant
        function checkCurrentUser() {
            const token = localStorage.getItem('stravaToken');
            const athleteId = localStorage.getItem('athleteId');
            
            if (token && athleteId) {
                currentUser = participants.find(p => p.id === athleteId);
                
                if (currentUser) {
                    // User is already a participant
                    joinBtn.textContent = 'Już uczestniczysz';
                    joinBtn.disabled = true;
                } else {
                    // Token exists but user is not a participant
                    // This might happen if admin deleted the user
                    localStorage.removeItem('stravaToken');
                    localStorage.removeItem('athleteId');
                }
            }
        }
        
        // Handle OAuth redirect from Strava
        function handleStravaRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                // Użytkownik anulował autoryzację
                alert('Autoryzacja ze Strava została anulowana. Spróbuj ponownie.');
                
                // Usuń parametry z URL
                const newUrl = window.location.href.split('?')[0];
                window.history.replaceState({}, document.title, newUrl);
                return;
            }
            
            if (code) {
                console.log('Otrzymano kod autoryzacyjny:', code);
                
                // Remove code from URL to prevent issues with sharing links
                const newUrl = window.location.href.split('?')[0];
                window.history.replaceState({}, document.title, newUrl);
                
                // Show joining modal with loading state
                joinModal.style.display = 'flex';
                roleSelectionDiv.style.display = 'none';
                connectingStravaDiv.style.display = 'flex';
                
                // Pobierz wybraną rolę z localStorage
                const storedRole = localStorage.getItem('selectedRole');
                if (!storedRole) {
                    console.error('Nie znaleziono wybranej roli w localStorage');
                    connectingStravaDiv.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Wystąpił błąd podczas łączenia ze Strava - brak informacji o wybranej roli. Spróbuj ponownie.</p>
                        </div>
                        <button class="connect-btn" id="retry-connect-btn">
                            <i class="fas fa-redo"></i> Spróbuj ponownie
                        </button>
                    `;
                    
                    document.getElementById('retry-connect-btn').addEventListener('click', () => {
                        joinModal.style.display = 'none';
                        setTimeout(() => {
                            joinBtn.click();
                        }, 100);
                    });
                    return;
                }
                
                // Exchange code for token
                exchangeCodeForToken(code)
                    .then(data => {
                        console.log('Otrzymano dane atlety:', data.athlete);
                        
                        // Save token to localStorage
                        localStorage.setItem('stravaToken', data.access_token);
                        localStorage.setItem('refreshToken', data.refresh_token);
                        localStorage.setItem('tokenExpiry', new Date().getTime() + data.expires_in * 1000);
                        localStorage.setItem('athleteId', data.athlete.id);
                        
                        // Add user as participant
                        addParticipant(data.athlete, storedRole);
                        
                        // Usuń wybraną rolę z localStorage po użyciu
                        localStorage.removeItem('selectedRole');
                    })
                    .catch(error => {
                        console.error('Error connecting with Strava:', error);
                        connectingStravaDiv.innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                <p>Wystąpił błąd podczas łączenia ze Strava:</p>
                                <p>${error.message || 'Nieznany błąd'}</p>
                                <div style="margin-top: 20px;">
                                    <h4>Wprowadź dane Strava ręcznie:</h4>
                                    <div class="form-group">
                                        <label for="manual-access-token">Token dostępu:</label>
                                        <input type="text" id="manual-access-token" placeholder="Wprowadź access_token...">
                                    </div>
                                    <div class="form-group">
                                        <label for="manual-refresh-token">Token odświeżający:</label>
                                        <input type="text" id="manual-refresh-token" placeholder="Wprowadź refresh_token...">
                                    </div>
                                    <div class="form-group">
                                        <label for="manual-athlete-id">ID atlety:</label>
                                        <input type="text" id="manual-athlete-id" placeholder="Wprowadź athlete.id...">
                                    </div>
                                    <div class="form-group">
                                        <label for="manual-athlete-name">Imię i nazwisko:</label>
                                        <input type="text" id="manual-athlete-name" placeholder="Wprowadź swoją nazwę...">
                                    </div>
                                </div>
                                <button class="connect-btn" id="save-manual-tokens-btn">
                                    <i class="fas fa-save"></i> Zapisz dane ręcznie
                                </button>
                                <button class="connect-btn" style="background-color: #777;" id="retry-connect-btn">
                                    <i class="fas fa-redo"></i> Spróbuj ponownie automatycznie
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('retry-connect-btn').addEventListener('click', () => {
                            joinModal.style.display = 'none';
                            localStorage.removeItem('selectedRole');
                            setTimeout(() => {
                                joinBtn.click();
                            }, 100);
                        });
                        
                        document.getElementById('save-manual-tokens-btn').addEventListener('click', () => {
                            const accessToken = document.getElementById('manual-access-token').value.trim();
                            const refreshToken = document.getElementById('manual-refresh-token').value.trim();
                            const athleteId = document.getElementById('manual-athlete-id').value.trim();
                            const athleteName = document.getElementById('manual-athlete-name').value.trim();
                            
                            if (!accessToken || !athleteId || !athleteName) {
                                alert('Wypełnij przynajmniej pola: token dostępu, ID atlety oraz imię i nazwisko!');
                                return;
                            }
                            
                            // Save token to localStorage
                            localStorage.setItem('stravaToken', accessToken);
                            if (refreshToken) localStorage.setItem('refreshToken', refreshToken);
                            localStorage.setItem('tokenExpiry', new Date().getTime() + 7200 * 1000); // 2 godziny
                            localStorage.setItem('athleteId', athleteId);
                            
                            // Add user as participant
                            const athleteData = {
                                id: athleteId,
                                firstname: athleteName.split(' ')[0] || athleteName,
                                lastname: athleteName.split(' ').slice(1).join(' ') || '',
                                profile: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png'
                            };
                            
                            addParticipant(athleteData, storedRole);
                            
                            // Usuń wybraną rolę z localStorage po użyciu
                            localStorage.removeItem('selectedRole');
                        });
                    });
            }
        }
        
        // Exchange authorization code for token
        async function exchangeCodeForToken(code) {
            console.log('Wymiana kodu autoryzacyjnego na token...');
            
            try {
                // Sprawdź, czy mamy skonfigurowane ID i Secret
                if (STRAVA_CLIENT_ID === "TWÓJ_STRAVA_CLIENT_ID" || STRAVA_CLIENT_SECRET === "TWÓJ_STRAVA_CLIENT_SECRET") {
                    console.warn('Używanie symulowanych danych, ponieważ nie skonfigurowano CLIENT_ID i CLIENT_SECRET');
                    // Symulowane dane dla celów demonstracyjnych
                    return {
                        access_token: 'simulated_access_token_' + Date.now(),
                        refresh_token: 'simulated_refresh_token_' + Date.now(),
                        expires_in: 21600,
                        athlete: {
                            id: 'user_' + Math.floor(Math.random() * 1000000),
                            firstname: 'Demo',
                            lastname: 'User',
                            profile: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png'
                        }
                    };
                }
                
                // WAŻNE: TESTOWA IMPLEMENTACJA BEZ PROXY - Bezpośrednie połączenie
                console.log("Próba bezpośredniego połączenia z API Strava dla wymiany tokenu...");
                const tokenUrl = `https://www.strava.com/oauth/token`;
                
                console.log("Dane zapytania:", {
                    client_id: STRAVA_CLIENT_ID,
                    client_secret: "[ukryte dla bezpieczeństwa]",
                    code: code,
                    grant_type: 'authorization_code'
                });
                
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: STRAVA_CLIENT_ID,
                        client_secret: STRAVA_CLIENT_SECRET,
                        code: code,
                        grant_type: 'authorization_code'
                    })
                });
                
                const responseStatus = `${response.status} ${response.statusText}`;
                const responseText = await response.text();
                console.log("Odpowiedź API Strava:", responseStatus);
                console.log("Treść odpowiedzi:", responseText);
                
                if (response.ok) {
                    const data = JSON.parse(responseText);
                    console.log('SUKCES! Otrzymano token z API Strava:', {
                        access_token_prefix: data.access_token ? data.access_token.substring(0, 10) + '...' : 'brak',
                        token_type: data.token_type,
                        expires_in: data.expires_in,
                        athlete: data.athlete ? { 
                            id: data.athlete.id,
                            firstname: data.athlete.firstname,
                            lastname: data.athlete.lastname
                        } : 'brak'
                    });
                    return data;
                } else {
                    // Jeśli nie udało się bezpośrednio, to możemy spróbować przez proxy
                    throw new Error(`Problem z wymianą kodu na token: ${responseStatus}. Odpowiedź: ${responseText}`);
                }
                
            } catch (error) {
                console.error('Błąd podczas wymiany kodu na token:', error);
                
                if (confirm('Wystąpił błąd podczas łączenia ze Strava API. Czy chcesz użyć danych demonstracyjnych?\n\nSzczegóły błędu: ' + error.message)) {
                    // Symulowane dane dla celów demonstracyjnych
                    console.warn('Używanie symulowanych danych po błędzie');
                    return {
                        access_token: 'simulated_error_token_' + Date.now(),
                        refresh_token: 'simulated_error_refresh_' + Date.now(),
                        expires_in: 21600,
                        athlete: {
                            id: 'demo_' + Math.floor(Math.random() * 1000000),
                            firstname: 'Demo',
                            lastname: 'User (po błędzie)',
                            profile: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png'
                        }
                    };
                } else {
                    throw error; // Jeśli użytkownik nie chce danych demonstracyjnych, rzuć błąd dalej
                }
            }
        }
        
        // Add participant to Firebase
        async function addParticipant(athlete, role) {
            try {
                console.log('Dodawanie uczestnika:', athlete, 'z rolą:', role);
                const athleteId = athlete.id.toString();
                const participantRef = db.collection('participants').doc(athleteId);
                
                // Check if participant already exists
                const doc = await participantRef.get();
                if (doc.exists) {
                    alert('Już uczestniczysz w wyzwaniu!');
                    joinModal.style.display = 'none';
                    window.location.reload(); // Odśwież stronę aby pokazać dane
                    return;
                }
                
                // Create new participant
                await participantRef.set({
                    name: `${athlete.firstname} ${athlete.lastname}`,
                    profile: athlete.profile,
                    role: role,
                    totalPoints: 0,
                    totalDistance: 0,
                    joinDate: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Pobierz lub utwórz parametry wyzwania, jeśli nie istnieją
                const paramsDoc = await db.collection('challengeParams').doc('main').get();
                if (!paramsDoc.exists) {
                    console.log('Tworzenie domyślnych parametrów wyzwania...');
                    // Ustaw domyślne parametry wyzwania na rok 2024 (bieżący rok)
                    const currentYear = new Date().getFullYear();
                    const defaultStartDate = new Date(`${currentYear}-01-01T00:00:00`);
                    const defaultEndDate = new Date(`${currentYear}-12-31T23:59:59`);
                    
                    await db.collection('challengeParams').doc('main').set({
                        startDate: firebase.firestore.Timestamp.fromDate(defaultStartDate),
                        endDate: firebase.firestore.Timestamp.fromDate(defaultEndDate),
                        pointGoal: 2000
                    });
                    
                    challengeParams = {
                        startDate: defaultStartDate,
                        endDate: defaultEndDate,
                        pointGoal: 2000
                    };
                }
                
                // Fetch activities from Strava (simulated)
                fetchStravaActivities().then(stravaActivities => {
                    // Add activities to Firebase
                    addActivities(athleteId, stravaActivities, role);
                });
                
                // Show success message
                connectingStravaDiv.innerHTML = `
                    <div class="success-message">
                        <i class="fas fa-check-circle"></i>
                        <p>Dołączyłeś do wyzwania! Twoje dotychczasowe aktywności zostaną zsynchronizowane.</p>
                    </div>
                    <button class="connect-btn" id="close-success-btn">
                        Zamknij
                    </button>
                `;
                
                document.getElementById('close-success-btn').addEventListener('click', () => {
                    joinModal.style.display = 'none';
                    window.location.reload();
                });
                
            } catch (error) {
                console.error('Error adding participant:', error);
                connectingStravaDiv.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Wystąpił błąd podczas dołączania do wyzwania: ${error.message}</p>
                    </div>
                    <button class="connect-btn" id="retry-join-btn">
                        <i class="fas fa-redo"></i> Spróbuj ponownie
                    </button>
                `;
                
                document.getElementById('retry-join-btn').addEventListener('click', () => {
                    joinModal.style.display = 'none';
                    setTimeout(() => {
                        joinBtn.click();
                    }, 100);
                });
            }
        }
        
        // Fetch activities from Strava API
        async function fetchStravaActivities() {
            const token = localStorage.getItem('stravaToken');
            if (!token) {
                console.error('Brak tokenu Strava!');
                return [];
            }
            
            try {
                console.log('Pobieranie aktywności z API Strava...');
                
                // Ustal zakres dat - pobierz aktywności od początku wyzwania lub z ostatnich 12 miesięcy (pełna historia)
                const now = new Date();
                const oneYearAgo = new Date(now);
                oneYearAgo.setFullYear(now.getFullYear() - 1); // Pobierz aktywności z ostatniego roku
                
                // Nie używamy daty rozpoczęcia wyzwania, aby pobrać pełną historię
                const startTime = Math.floor(oneYearAgo.getTime() / 1000);
                
                console.log(`Pobieranie aktywności od ${new Date(startTime * 1000).toLocaleDateString()}`);
                
                // Sprawdź, czy używamy symulowanych danych
                if (token.startsWith('fake_')) {
                    console.warn('Używanie symulowanych danych Strava - token testowy');
                    return generateTestActivities(20); // Więcej aktywności w trybie demonstracyjnym
                }
                
                // Spróbuj różnych sposobów pobierania danych
                let allActivities = [];
                let successfulFetch = false;
                
                // Podejście 1: Bezpośrednie połączenie (bez proxy)
                if (!successfulFetch) {
                    try {
                        console.log("Próba bezpośredniego połączenia z API Strava (może nie działać z powodu CORS)...");
                        const directUrl = `https://www.strava.com/api/v3/athlete/activities?after=${startTime}&per_page=100`;
                        
                        const response = await fetch(directUrl, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            allActivities = data;
                            successfulFetch = true;
                            console.log(`Pobrano ${data.length} aktywności bezpośrednio z API Strava`);
                        } else {
                            console.log("Bezpośrednie połączenie nie powiodło się, próbuję przez proxy...");
                        }
                    } catch (error) {
                        console.log("Błąd podczas bezpośredniego połączenia:", error);
                    }
                }
                
                // Podejście 2: Użycie proxy CORS Anywhere
                if (!successfulFetch) {
                    try {
                        console.log("Próba przez proxy CORS Anywhere...");
                        const proxyUrl = "https://cors-anywhere.herokuapp.com/https://www.strava.com/api/v3/athlete/activities";
                        
                        const response = await fetch(`${proxyUrl}?after=${startTime}&per_page=100`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Origin': window.location.origin
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            allActivities = data;
                            successfulFetch = true;
                            console.log(`Pobrano ${data.length} aktywności przez CORS Anywhere`);
                        } else {
                            if (response.status === 403) {
                                console.log("Dostęp do CORS Anywhere wymaga autoryzacji: https://cors-anywhere.herokuapp.com/corsdemo");
                            } else {
                                console.log(`Błąd proxy CORS Anywhere: ${response.status} ${response.statusText}`);
                            }
                        }
                    } catch (error) {
                        console.log("Błąd podczas używania CORS Anywhere:", error);
                    }
                }
                
                // Podejście 3: Użycie alternatywnego proxy
                if (!successfulFetch) {
                    try {
                        console.log("Próba przez alternatywne proxy CORS...");
                        const altProxyUrl = "https://api.allorigins.win/raw?url=" + 
                            encodeURIComponent(`https://www.strava.com/api/v3/athlete/activities?after=${startTime}&per_page=100`);
                        
                        const response = await fetch(altProxyUrl, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            allActivities = data;
                            successfulFetch = true;
                            console.log(`Pobrano ${data.length} aktywności przez alternatywne proxy`);
                        } else {
                            console.log(`Błąd alternatywnego proxy: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.log("Błąd podczas używania alternatywnego proxy:", error);
                    }
                }
                
                // Jeśli wszystkie metody zawiodły, użyj danych demonstracyjnych
                if (!successfulFetch) {
                    console.warn("Wszystkie metody pobierania danych zawiodły. Używanie danych demonstracyjnych.");
                    return generateTestActivities(30); // Więcej aktywności w trybie awaryjnym
                }
                
                console.log(`Łącznie pobrano ${allActivities.length} aktywności z API Strava`);
                
                // Przetwórz odpowiedź na format używany w aplikacji
                return allActivities.map(a => ({
                    id: a.id.toString(),
                    name: a.name,
                    type: a.type,
                    distance: a.distance, // w metrach
                    movingTime: a.moving_time, // w sekundach
                    averageSpeed: a.average_speed * 3.6, // konwersja z m/s na km/h
                    startDate: new Date(a.start_date)
                }));
                
            } catch (error) {
                console.error('Błąd podczas pobierania aktywności z API Strava:', error);
                console.log('Użycie danych demonstracyjnych z powodu błędu');
                
                return generateTestActivities(25);
            }
        }
        
        // Generowanie testowych aktywności
        function generateTestActivities(count = 15) {
            console.log(`Generowanie ${count} przykładowych aktywności...`);
            const testActivities = [];
            const types = ['Run', 'Ride'];
            const names = [
                'Poranny bieg', 'Popołudniowa jazda', 'Wieczorny bieg', 
                'Długi weekend', 'Regeneracja', 'Bieg w terenie',
                'Dojazd do pracy', 'Trening tempowy', 'Interwały', 'Grupowa jazda',
                'Przygotowanie do zawodów', 'Bieg w parku', 'Przełaje',
                'Wycieczka rowerowa', 'Commute', 'Trening w górach'
            ];
            
            const now = new Date();
            const oneYearAgo = new Date(now);
            oneYearAgo.setFullYear(now.getFullYear() - 1);
            
            // Utwórz lepiej rozmieszczone aktywności
            for (let i = 0; i < count; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                const nameIndex = Math.floor(Math.random() * names.length);
                const name = names[nameIndex];
                
                // Dystans zależny od typu aktywności
                let distance;
                if (type === 'Run') {
                    distance = (Math.random() * 15 + 3) * 1000; // 3-18km dla biegania
                } else {
                    distance = (Math.random() * 40 + 10) * 1000; // 10-50km dla jazdy rowerem
                }
                
                const movingTime = distance * (Math.random() * 30 + 240); // 4-7 min/km tempo
                const averageSpeed = type === 'Run' ? distance / movingTime * 3600 : distance / movingTime * 3600 * 2; // km/h
                
                // Równomiernie rozłożone aktywności w ciągu roku
                const dayOffset = Math.floor(i * (365 / count));
                const activityDate = new Date(oneYearAgo);
                activityDate.setDate(activityDate.getDate() + dayOffset);
                
                // Dodaj losowość do godziny
                activityDate.setHours(Math.floor(Math.random() * 12) + 6); // między 6:00 a 18:00
                
                testActivities.push({
                    id: 'activity_' + Math.floor(Math.random() * 1000000),
                    name: name,
                    type: type,
                    distance: distance,
                    movingTime: movingTime,
                    averageSpeed: averageSpeed,
                    startDate: activityDate
                });
            }
            
            // Posortuj aktywności od najnowszej do najstarszej
            testActivities.sort((a, b) => b.startDate - a.startDate);
            
            console.log('Wygenerowano testowe aktywności:', testActivities);
            return testActivities;
        }
        
        // Add activities to Firebase
        async function addActivities(athleteId, stravaActivities, role) {
            try {
                console.log(`Dodawanie aktywności dla uczestnika ${athleteId} z rolą ${role}...`);
                console.log('Aktywności do dodania:', stravaActivities);
                
                // Pobierz parametry wyzwania - sprawdź czy istnieją
                const paramsDoc = await db.collection('challengeParams').doc('main').get();
                if (!paramsDoc.exists) {
                    console.warn('Nie znaleziono parametrów wyzwania, używanie domyślnych wartości');
                    
                    // Ustaw domyślne parametry wyzwania na rok 2024 (bieżący rok)
                    const currentYear = new Date().getFullYear();
                    challengeParams = {
                        startDate: new Date(`${currentYear}-01-01T00:00:00`),
                        endDate: new Date(`${currentYear}-12-31T23:59:59`),
                        pointGoal: 2000
                    };
                } else {
                    console.log('Pobrano parametry wyzwania:', paramsDoc.data());
                }
                
                // Wyświetl informacje o datach wyzwania
                console.log('Daty wyzwania:', {
                    startDate: challengeParams.startDate.toLocaleDateString(),
                    endDate: challengeParams.endDate.toLocaleDateString()
                });
                
                // Najpierw pobierz istniejące aktywności dla tego uczestnika
                const existingActivitiesSnapshot = await db.collection('activities')
                    .where('athleteId', '==', athleteId)
                    .get();
                
                const existingActivityIds = new Set();
                existingActivitiesSnapshot.forEach(doc => {
                    existingActivityIds.add(doc.id);
                });
                
                console.log(`Znaleziono ${existingActivityIds.size} istniejących aktywności w bazie danych.`);
                
                // Sprawdź daty aktywności - ile aktywności mieści się w okresie wyzwania
                const activitiesInDateRange = stravaActivities.filter(activity => {
                    const activityDate = new Date(activity.startDate);
                    return activityDate >= challengeParams.startDate && 
                           activityDate <= challengeParams.endDate;
                });
                
                console.log(`Aktywności w zakresie dat wyzwania: ${activitiesInDateRange.length} z ${stravaActivities.length}`);
                
                // Filter activities based on challenge dates and role
                const eligibleActivities = stravaActivities.filter(activity => {
                    const activityDate = new Date(activity.startDate);
                    const isInDateRange = activityDate >= challengeParams.startDate && 
                                         activityDate <= challengeParams.endDate;
                    const isEligibleType = isActivityEligible(activity, role);
                    const isNewActivity = !existingActivityIds.has(activity.id);
                    
                    // Log why activities might be filtered out
                    if (!isInDateRange) {
                        console.log(`Aktywność ${activity.id} (${activity.name}, ${activityDate.toLocaleDateString()}) odrzucona - poza zakresem dat: ${challengeParams.startDate.toLocaleDateString()} - ${challengeParams.endDate.toLocaleDateString()}`);
                    }
                    if (!isEligibleType) {
                        console.log(`Aktywność ${activity.id} (${activity.name}, ${activity.type}) odrzucona - nieodpowiedni typ dla roli ${role}`);
                    }
                    if (!isNewActivity) {
                        console.log(`Aktywność ${activity.id} (${activity.name}) już istnieje w bazie danych`);
                    }
                    
                    return isInDateRange && isEligibleType && isNewActivity;
                });
                
                console.log(`Znaleziono ${eligibleActivities.length} nowych aktywności kwalifikujących się do wyzwania.`);
                
                if (eligibleActivities.length === 0) {
                    // Wyświetl bardziej pomocny komunikat
                    let message = 'Nie znaleziono nowych aktywności kwalifikujących się do wyzwania.\n\n';
                    message += `Okres wyzwania: ${challengeParams.startDate.toLocaleDateString()} - ${challengeParams.endDate.toLocaleDateString()}\n`;
                    message += `Liczba wszystkich pobranych aktywności: ${stravaActivities.length}\n`;
                    message += `Aktywności w okresie wyzwania: ${activitiesInDateRange.length}\n`;
                    message += `Aktywności już dodane: ${existingActivityIds.size}\n\n`;
                    
                    if (activitiesInDateRange.length === 0) {
                        message += 'Upewnij się, że masz aktywności w okresie trwania wyzwania.';
                    } else if (existingActivityIds.size > 0) {
                        message += 'Twoje aktywności zostały już wcześniej dodane do wyzwania.';
                    } else {
                        message += 'Upewnij się, że masz aktywności odpowiedniego typu w okresie trwania wyzwania.';
                    }
                    
                    // Pozwól administratorowi zmodyfikować daty wyzwania
                    if (localStorage.getItem('isAdmin')) {
                        message += '\n\nMożesz zmodyfikować daty wyzwania w panelu administratora.';
                    }
                    
                    alert(message);
                    return;
                }
                
                let totalPoints = 0;
                let totalDistance = 0;
                
                // Add each activity to Firebase
                const batch = db.batch();
                
                for (const activity of eligibleActivities) {
                    const points = calculatePoints(activity, role);
                    totalPoints += points;
                    totalDistance += activity.distance / 1000;
                    
                    const activityRef = db.collection('activities').doc(activity.id);
                    batch.set(activityRef, {
                        athleteId: athleteId,
                        name: activity.name,
                        type: activity.type,
                        startDate: firebase.firestore.Timestamp.fromDate(new Date(activity.startDate)),
                        distance: activity.distance,
                        movingTime: activity.movingTime,
                        averageSpeed: activity.averageSpeed,
                        points: points
                    });
                }
                
                // Update participant totals
                const participantRef = db.collection('participants').doc(athleteId);
                batch.update(participantRef, {
                    totalPoints: firebase.firestore.FieldValue.increment(totalPoints),
                    totalDistance: firebase.firestore.FieldValue.increment(totalDistance)
                });
                
                // Commit all changes in a single batch
                await batch.commit();
                console.log(`Pomyślnie dodano ${eligibleActivities.length} aktywności!`);
                
                // Update logs
                await db.collection('logs').add({
                    type: 'sync',
                    athleteId: athleteId,
                    activitiesCount: eligibleActivities.length,
                    pointsAdded: totalPoints,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`Pomyślnie dodano ${eligibleActivities.length} aktywności i ${totalPoints} punktów!`);
                
            } catch (error) {
                console.error('Błąd podczas dodawania aktywności:', error);
                alert(`Wystąpił błąd podczas dodawania aktywności: ${error.message}`);
            }
        }
        
        // Create confetti animation
        function createConfetti() {
            const confettiContainer = document.getElementById('confetti-container');
            confettiContainer.innerHTML = '';
            
            const colors = ['#f94144', '#f3722c', '#f8961e', '#f9c74f', '#90be6d', '#43aa8b', '#577590'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.opacity = Math.random();
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                // Animation
                confetti.animate([
                    { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
                    { transform: `translate(${Math.random() * 200 - 100}px, ${window.innerHeight}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: Math.random() * 3000 + 2000,
                    easing: 'cubic-bezier(0.1, 0.8, 0.3, 1)'
                });
                
                confettiContainer.appendChild(confetti);
            }
            
            setTimeout(() => {
                confettiContainer.innerHTML = '';
            }, 5000);
        }
        
        // Admin Panel Functions
        function updateAdminStats() {
            participantCountSpan.textContent = participants.length;
            activityCountSpan.textContent = activities.length;
            lastRefreshSpan.textContent = formatDateTime(new Date());
            
            // Update participants table
            adminParticipantsTable.innerHTML = '';
            
            participants.forEach(participant => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${participant.name}</td>
                    <td>${participant.role === 'runner' ? 'Biegacz' : participant.role === 'cyclist' ? 'Rowerzysta' : 'Biegacz/Rowerzysta'}</td>
                    <td>${participant.totalPoints}</td>
                    <td>
                        <button class="admin-btn" data-action="sync" data-id="${participant.id}">
                            <i class="fas fa-sync"></i>
                        </button>
                        <button class="admin-btn danger-btn" data-action="delete" data-id="${participant.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                adminParticipantsTable.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('[data-action="sync"]').forEach(button => {
                button.addEventListener('click', () => {
                    const athleteId = button.getAttribute('data-id');
                    syncParticipantActivities(athleteId);
                });
            });
            
            document.querySelectorAll('[data-action="delete"]').forEach(button => {
                button.addEventListener('click', () => {
                    const athleteId = button.getAttribute('data-id');
                    deleteParticipant(athleteId);
                });
            });
        }
        
        function syncParticipantActivities(athleteId) {
            const participant = participants.find(p => p.id === athleteId);
            if (!participant) return;
            
            alert(`Synchronizacja aktywności dla ${participant.name}...`);
            
            // In a real app, this would fetch new activities from Strava
            // Here we'll simulate by adding a few random activities
            fetchStravaActivities().then(stravaActivities => {
                addActivities(athleteId, stravaActivities, participant.role).then(() => {
                    alert('Synchronizacja zakończona!');
                    loadData();
                });
            });
        }
        
        function deleteParticipant(athleteId) {
            const participant = participants.find(p => p.id === athleteId);
            if (!participant) return;
            
            if (confirm(`Czy na pewno chcesz usunąć uczestnika ${participant.name}?`)) {
                // Delete participant and their activities
                db.collection('participants').doc(athleteId).delete()
                    .then(() => {
                        // Delete all activities for this participant
                        const batch = db.batch();
                        
                        activities.forEach(activity => {
                            if (activity.athleteId === athleteId) {
                                batch.delete(db.collection('activities').doc(activity.id));
                            }
                        });
                        
                        return batch.commit();
                    })
                    .then(() => {
                        alert('Uczestnik został usunięty!');
                        loadData();
                    })
                    .catch(error => {
                        console.error('Error deleting participant:', error);
                        alert('Wystąpił błąd podczas usuwania uczestnika.');
                    });
            }
        }
        
        function saveParams() {
            const startDate = new Date(startDateInput.value + 'T00:00:00');
            const endDate = new Date(endDateInput.value + 'T23:59:59');
            const pointGoal = parseInt(pointGoalInput.value);
            
            if (isNaN(pointGoal) || pointGoal <= 0) {
                alert('Wprowadź poprawny cel punktowy!');
                return;
            }
            
            if (startDate >= endDate) {
                alert('Data rozpoczęcia musi być wcześniejsza niż data zakończenia!');
                return;
            }
            
            db.collection('challengeParams').doc('main').set({
                startDate: firebase.firestore.Timestamp.fromDate(startDate),
                endDate: firebase.firestore.Timestamp.fromDate(endDate),
                pointGoal: pointGoal
            })
            .then(() => {
                alert('Parametry zapisane!');
                challengeParams = { startDate, endDate, pointGoal };
                updateCountdown();
                updateProgressChart();
                renderParticipants();
            })
            .catch(error => {
                console.error('Error saving params:', error);
                alert('Wystąpił błąd podczas zapisywania parametrów.');
            });
        }
        
        function generateTestData() {
            const count = parseInt(testParticipantsInput.value);
            
            if (isNaN(count) || count <= 0 || count > 20) {
                alert('Wprowadź poprawną liczbę testowych uczestników (1-20)!');
                return;
            }
            
            if (confirm(`Czy na pewno chcesz wygenerować ${count} testowych uczestników?`)) {
                // Clear existing test data
                resetTestData().then(() => {
                    // Generate test participants
                    const batch = db.batch();
                    const roles = ['runner', 'cyclist', 'dual'];
                    const firstNames = ['Anna', 'Piotr', 'Katarzyna', 'Michał', 'Ewa', 'Jan', 'Magdalena', 'Tomasz', 'Joanna', 'Paweł'];
                    const lastNames = ['Kowalski', 'Nowak', 'Wiśniewski', 'Wójcik', 'Kowalczyk', 'Kamiński', 'Lewandowski', 'Zieliński', 'Szymański', 'Woźniak'];
                    
                    for (let i = 0; i < count; i++) {
                        const role = roles[Math.floor(Math.random() * roles.length)];
                        const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                        const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                        const name = `${firstName} ${lastName}`;
                        const id = 'test_' + i;
                        
                        batch.set(db.collection('participants').doc(id), {
                            name: name,
                            profile: `https://picsum.photos/seed/${id}/200/200`,
                            role: role,
                            totalPoints: 0,
                            totalDistance: 0,
                            joinDate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    batch.commit().then(() => {
                        alert('Testowi uczestnicy zostali wygenerowani!');
                        
                        // Load new data and generate activities for each test participant
                        loadData().then(() => {
                            const testParticipants = participants.filter(p => p.id.startsWith('test_'));
                            
                            testParticipants.forEach(participant => {
                                fetchStravaActivities().then(activities => {
                                    addActivities(participant.id, activities, participant.role);
                                }).then(() => {
                                    setTimeout(() => {
                                        loadData();
                                    }, 1000);
                                });
                            });
                        });
                    });
                });
            }
        }
        
        function resetTestData() {
            return new Promise((resolve, reject) => {
                if (confirm('Czy na pewno chcesz zresetować wszystkie dane testowe?')) {
                    // Delete all test participants and their activities
                    db.collection('participants').where(firebase.firestore.FieldPath.documentId(), '>=', 'test_')
                        .where(firebase.firestore.FieldPath.documentId(), '<', 'test`')
                        .get()
                        .then(snapshot => {
                            const batch = db.batch();
                            
                            snapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            
                            return batch.commit();
                        })
                        .then(() => {
                            // Delete all activities for test participants
                            return db.collection('activities').where('athleteId', '>=', 'test_')
                                .where('athleteId', '<', 'test`')
                                .get();
                        })
                        .then(snapshot => {
                            const batch = db.batch();
                            
                            snapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            
                            return batch.commit();
                        })
                        .then(() => {
                            alert('Dane testowe zostały zresetowane!');
                            loadData();
                            resolve();
                        })
                        .catch(error => {
                            console.error('Error resetting test data:', error);
                            alert('Wystąpił błąd podczas resetowania danych testowych.');
                            reject(error);
                        });
                } else {
                    resolve();
                }
            });
        }
        
        // PWA Functions
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Create inline service worker
                const swCode = `
                    self.addEventListener('install', event => {
                        self.skipWaiting();
                        event.waitUntil(
                            caches.open('wyzwanie-2025-v1').then(cache => {
                                return cache.addAll([
                                    '/',
                                    '/index.html'
                                ]);
                            })
                        );
                    });
                    
                    self.addEventListener('activate', event => {
                        event.waitUntil(self.clients.claim());
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => {
                                return response || fetch(event.request).then(response => {
                                    return caches.open('wyzwanie-2025-v1').then(cache => {
                                        cache.put(event.request, response.clone());
                                        return response;
                                    });
                                });
                            }).catch(() => {
                                // Fallback for offline
                                return caches.match('/');
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], {type: 'text/javascript'});
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(reg => {
                        console.log('Service worker registered');
                    })
                    .catch(error => {
                        console.error('Service worker registration failed:', error);
                    });
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initProgressChart();
            loadData();
            updateCountdown();
            
            // Check for OAuth redirect
            handleStravaRedirect();
            
            // Register service worker for PWA
            registerServiceWorker();
            
            // Set up PWA install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install banner
                installBanner.style.display = 'block';
            });
            
            // Update countdown every minute
            setInterval(updateCountdown, 60000);
            
            // Set up PWA detection
            if (window.matchMedia('(display-mode: standalone)').matches) {
                document.body.classList.add('pwa-installed');
                mobileNav.style.display = 'block';
            }
        });
        
        // Join button
        joinBtn.addEventListener('click', () => {
            joinModal.style.display = 'flex';
            roleSelectionDiv.style.display = 'block';
            connectingStravaDiv.style.display = 'none';
            selectedRole = null;
            connectStravaBtn.disabled = true;
            
            // Deselect all roles
            roleOptions.forEach(option => {
                option.classList.remove('selected');
            });
        });
        
        // Close join modal
        closeJoinModal.addEventListener('click', () => {
            joinModal.style.display = 'none';
        });
        
        // Role selection
        roleOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Deselect all
                roleOptions.forEach(o => o.classList.remove('selected'));
                
                // Select clicked
                option.classList.add('selected');
                selectedRole = option.getAttribute('data-role');
                
                // Enable connect button
                connectStravaBtn.disabled = false;
            });
        });
        
        // Connect Strava button
        connectStravaBtn.addEventListener('click', () => {
            if (!selectedRole) {
                alert('Wybierz swoją rolę!');
                return;
            }
            
            // Zapisz wybraną rolę do localStorage, aby mieć do niej dostęp po powrocie z autoryzacji
            localStorage.setItem('selectedRole', selectedRole);
            
            // Rzeczywiste przekierowanie do strony autoryzacyjnej Stravy
            const stravaAuthUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&redirect_uri=${STRAVA_REDIRECT_URI}&response_type=code&scope=activity:read_all`;
            window.location.href = stravaAuthUrl;
        });
        
        // Pagination buttons
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderActivities();
            }
        });
        
        nextPageBtn.addEventListener('click', () => {
            currentPage++;
            renderActivities();
        });
        
        // Install banner
        installBtn.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                
                deferredPrompt.userChoice.then(choiceResult => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
                
                installBanner.style.display = 'none';
            }
        });
        
        closeBannerBtn.addEventListener('click', () => {
            installBanner.style.display = 'none';
        });
        
        // Obsługa nawigacji mobilnej
        mobileNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Usuń aktywną klasę ze wszystkich linków
                mobileNavLinks.forEach(l => l.classList.remove('active'));
                
                // Dodaj aktywną klasę do klikniętego linku
                link.classList.add('active');
                
                // Przewiń do odpowiedniej sekcji
                const sectionId = link.getAttribute('data-section');
                const section = document.querySelector('.' + sectionId);
                
                if (section) {
                    window.scrollTo({
                        top: section.offsetTop - 60,
                        behavior: 'smooth'
                    });
                }
            });
        });
        
        // Obsługa linku do panelu administratora
        adminLink.addEventListener('click', () => {
            adminModal.style.display = 'flex';
            adminLoginDiv.style.display = 'block';
            adminPanelDiv.style.display = 'none';
            adminPasswordInput.value = '';
        });
        
        // Zamknięcie modalu administratora
        closeAdminModal.addEventListener('click', () => {
            adminModal.style.display = 'none';
        });
        
        // Logowanie do panelu administratora
        adminLoginBtn.addEventListener('click', () => {
            const password = adminPasswordInput.value;
            
            // W rzeczywistej aplikacji hasło powinno być weryfikowane na serwerze
            // Tutaj dla demonstracji używamy prostego hasła
            if (password === 'admin123') {
                adminLoginDiv.style.display = 'none';
                adminPanelDiv.style.display = 'block';
                updateAdminStats();
            } else {
                alert('Nieprawidłowe hasło!');
            }
        });
        
        // Obsługa przycisków panelu administratora
        saveParamsBtn.addEventListener('click', saveParams);
        generateTestDataBtn.addEventListener('click', generateTestData);
        resetTestDataBtn.addEventListener('click', resetTestData);
        
        // Okresowe odświeżanie danych
        function setupPeriodicRefresh() {
            // Odświeżaj dane co godzinę
            setInterval(() => {
                // Sprawdź, czy token dostępu do Stravy nie wygasł
                const tokenExpiry = localStorage.getItem('tokenExpiry');
                const now = new Date().getTime();
                
                if (tokenExpiry && parseInt(tokenExpiry) < now) {
                    // Token wygasł, odnów go
                    refreshStravaToken();
                }
                
                // Odśwież dane
                loadData();
            }, 60 * 60 * 1000); // co godzinę
        }
        
        // Symulacja odświeżania tokenu Strava
        function refreshStravaToken() {
            const refreshToken = localStorage.getItem('refreshToken');
            
            if (refreshToken) {
                // W rzeczywistej aplikacji byłoby to żądanie do API Stravy
                // Tutaj symulujemy odświeżenie tokenu
                localStorage.setItem('stravaToken', 'simulated_refreshed_token');
                localStorage.setItem('tokenExpiry', new Date().getTime() + 21600 * 1000);
                
                console.log('Token Strava został odświeżony');
            }
        }
        
        // Funkcja do synchronizacji aktywności dla wszystkich uczestników
        async function syncAllActivities() {
            try {
                // W rzeczywistej aplikacji pobieralibyśmy nowe aktywności dla każdego uczestnika
                // i dodawalibyśmy je do Firebase
                
                alert('Rozpoczynam synchronizację wszystkich aktywności...');
                
                for (const participant of participants) {
                    await syncParticipantActivities(participant.id);
                }
                
                alert('Synchronizacja zakończona!');
                loadData();
            } catch (error) {
                console.error('Błąd podczas synchronizacji:', error);
                alert('Wystąpił błąd podczas synchronizacji aktywności.');
            }
        }
        
        // Implementacja funkcji dla poziomów uczestników
        function getParticipantLevel(points) {
            if (points >= 2000) return 5;
            if (points >= 1500) return 4;
            if (points >= 750) return 3;
            if (points >= 250) return 2;
            return 1;
        }
        
        function getParticipantLevelName(points, role) {
            const level = getParticipantLevel(points);
            
            if (role === 'runner') {
                const levels = [
                    'Początkujący Biegacz',
                    'Regularny Biegacz',
                    'Zaawansowany Biegacz',
                    'Mistrz Biegania',
                    'Ultramaratończyk'
                ];
                return levels[level - 1];
            } else if (role === 'cyclist') {
                const levels = [
                    'Początkujący Kolarz',
                    'Regularny Rowerzysta',
                    'Zaawansowany Kolarz',
                    'Mistrz Kolarstwa',
                    'Szosowy Czempion'
                ];
                return levels[level - 1];
            } else {
                const levels = [
                    'Początkujący Sportowiec',
                    'Regularny Sportowiec',
                    'Zaawansowany Sportowiec',
                    'Mistrz Sportu',
                    'Wszechstronny Mistrz'
                ];
                return levels[level - 1];
            }
        }
        
        // Funkcje analizy danych uczestnika
        function analyzeParticipantActivities(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return null;
            
            const participantActivities = activities.filter(a => a.athleteId === participantId);
            
            // Analiza dni tygodnia
            const dayCount = [0, 0, 0, 0, 0, 0, 0]; // Niedziela do Soboty
            participantActivities.forEach(activity => {
                const day = new Date(activity.startDate).getDay();
                dayCount[day]++;
            });
            
            const bestDay = dayCount.indexOf(Math.max(...dayCount));
            const dayNames = ['Niedziela', 'Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek', 'Sobota'];
            
            // Analiza pory dnia
            const morningActivities = participantActivities.filter(a => {
                const hour = new Date(a.startDate).getHours();
                return hour < 12;
            }).length;
            
            const afternoonActivities = participantActivities.filter(a => {
                const hour = new Date(a.startDate).getHours();
                return hour >= 12 && hour < 18;
            }).length;
            
            const eveningActivities = participantActivities.filter(a => {
                const hour = new Date(a.startDate).getHours();
                return hour >= 18;
            }).length;
            
            let favoriteTime = 'rano';
            if (afternoonActivities > morningActivities && afternoonActivities > eveningActivities) {
                favoriteTime = 'po południu';
            } else if (eveningActivities > morningActivities && eveningActivities > afternoonActivities) {
                favoriteTime = 'wieczorem';
            }
            
            // Analiza długości aktywności
            const distances = participantActivities.map(a => a.distance / 1000);
            const avgDistance = distances.reduce((sum, d) => sum + d, 0) / distances.length;
            const maxDistance = Math.max(...distances);
            
            // Analiza częstotliwości
            participantActivities.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            const streaks = [];
            let currentStreak = 1;
            let startDate = participantActivities[0]?.startDate;
            
            for (let i = 1; i < participantActivities.length; i++) {
                const prevDate = new Date(participantActivities[i-1].startDate);
                const currDate = new Date(participantActivities[i].startDate);
                
                // Sprawdź, czy aktywności były w kolejnych dniach
                const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    // Kontynuacja serii
                    currentStreak++;
                } else if (diffDays > 1) {
                    // Koniec serii
                    if (currentStreak >= 3) {
                        streaks.push({
                            start: startDate,
                            end: participantActivities[i-1].startDate,
                            days: currentStreak
                        });
                    }
                    
                    // Nowa seria
                    currentStreak = 1;
                    startDate = participantActivities[i].startDate;
                }
            }
            
            // Sprawdź ostatnią serię
            if (currentStreak >= 3) {
                streaks.push({
                    start: startDate,
                    end: participantActivities[participantActivities.length - 1].startDate,
                    days: currentStreak
                });
            }
            
            const longestStreak = streaks.length > 0 ? Math.max(...streaks.map(s => s.days)) : 0;
            
            return {
                bestDay: dayNames[bestDay],
                favoriteTime,
                avgDistance: avgDistance.toFixed(1),
                maxDistance: maxDistance.toFixed(1),
                totalActivities: participantActivities.length,
                longestStreak,
                streaks
            };
        }
        
        // Funkcja przewidywania daty osiągnięcia celu
        function predictGoalDate(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant || participant.totalPoints >= challengeParams.pointGoal) return null;
            
            const participantActivities = activities.filter(a => a.athleteId === participantId);
            if (participantActivities.length < 5) return null; // Za mało danych
            
            // Posortuj aktywności od najstarszej
            participantActivities.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            // Oblicz średnią dzienną liczbę punktów
            const firstActivityDate = new Date(participantActivities[0].startDate);
            const lastActivityDate = new Date(participantActivities[participantActivities.length - 1].startDate);
            const daysActive = Math.ceil((lastActivityDate - firstActivityDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const pointsPerDay = participant.totalPoints / daysActive;
            
            if (pointsPerDay <= 0) return null;
            
            // Ile punktów zostało do celu
            const pointsRemaining = challengeParams.pointGoal - participant.totalPoints;
            
            // Ile dni potrzeba, aby osiągnąć cel
            const daysToGoal = Math.ceil(pointsRemaining / pointsPerDay);
            
            // Przewidywana data osiągnięcia celu
            const predictedDate = new Date();
            predictedDate.setDate(predictedDate.getDate() + daysToGoal);
            
            // Sprawdź czy jest w zakresie wyzwania
            if (predictedDate > challengeParams.endDate) {
                return {
                    willReach: false,
                    predictedPoints: Math.round(participant.totalPoints + (pointsPerDay * Math.ceil((challengeParams.endDate - new Date()) / (1000 * 60 * 60 * 24))))
                };
            }
            
            return {
                willReach: true,
                date: predictedDate,
                daysToGoal
            };
        }
        
        // Implementacja funkcji grywalizacyjnych
        function checkBadgesAndAchievements(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;
            
            // Sprawdź czy uczestnik zdobył nowy poziom
            const oldLevel = getParticipantLevel(participant.totalPoints - participant.lastActivity?.points || 0);
            const newLevel = getParticipantLevel(participant.totalPoints);
            
            if (newLevel > oldLevel) {
                // Nowy poziom osiągnięty!
                const levelName = getParticipantLevelName(participant.totalPoints, participant.role);
                
                showAchievementNotification(`Osiągnięto poziom ${newLevel}: ${levelName}!`);
                createConfetti();
            }
            
            // Tutaj można dodać więcej logiki sprawdzania odznak
        }
        
        function showAchievementNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div class="achievement-icon">
                    <i class="fas fa-award"></i>
                </div>
                <div class="achievement-message">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 5000);
        }
        
        // Generowanie heatmapy aktywności
        function generateActivityHeatmap(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return null;
            
            const participantActivities = activities.filter(a => a.athleteId === participantId);
            
            // Grupowanie aktywności według dnia
            const activityByDate = {};
            
            participantActivities.forEach(activity => {
                const dateStr = formatDate(activity.startDate).replace(/\//g, '-');
                
                if (!activityByDate[dateStr]) {
                    activityByDate[dateStr] = {
                        points: 0,
                        activities: []
                    };
                }
                
                activityByDate[dateStr].points += activity.points;
                activityByDate[dateStr].activities.push(activity);
            });
            
            return activityByDate;
        }
        
        // Funkcja tworzenia raportu tygodniowego
        function generateWeeklyReport(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return null;
            
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay()); // Niedziela jako początek tygodnia
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);
            
            const weekActivities = activities.filter(a => {
                const activityDate = new Date(a.startDate);
                return a.athleteId === participantId && 
                       activityDate >= weekStart && 
                       activityDate <= weekEnd;
            });
            
            // Poprzedni tydzień
            const prevWeekStart = new Date(weekStart);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);
            
            const prevWeekEnd = new Date(weekEnd);
            prevWeekEnd.setDate(prevWeekEnd.getDate() - 7);
            
            const prevWeekActivities = activities.filter(a => {
                const activityDate = new Date(a.startDate);
                return a.athleteId === participantId && 
                       activityDate >= prevWeekStart && 
                       activityDate <= prevWeekEnd;
            });
            
            // Obliczenia statystyk
            const currentWeekPoints = weekActivities.reduce((sum, a) => sum + a.points, 0);
            const prevWeekPoints = prevWeekActivities.reduce((sum, a) => sum + a.points, 0);
            
            const currentWeekDistance = weekActivities.reduce((sum, a) => sum + a.distance, 0) / 1000;
            const prevWeekDistance = prevWeekActivities.reduce((sum, a) => sum + a.distance, 0) / 1000;
            
            const pointsDiff = currentWeekPoints - prevWeekPoints;
            const distanceDiff = currentWeekDistance - prevWeekDistance;
            
            // Prognoza na następny tydzień
            const nextWeekPointsForecast = currentWeekPoints;
            
            return {
                weekStart: formatDate(weekStart),
                weekEnd: formatDate(weekEnd),
                activitiesCount: weekActivities.length,
                totalPoints: currentWeekPoints,
                totalDistance: currentWeekDistance.toFixed(1),
                comparison: {
                    pointsDiff,
                    distanceDiff: distanceDiff.toFixed(1),
                    pointsPercentChange: prevWeekPoints ? Math.round((pointsDiff / prevWeekPoints) * 100) : 0,
                    distancePercentChange: prevWeekDistance ? Math.round((distanceDiff / prevWeekDistance) * 100) : 0
                },
                forecast: {
                    nextWeekPoints: nextWeekPointsForecast,
                    daysToGoal: participant.totalPoints < challengeParams.pointGoal ? 
                        Math.ceil((challengeParams.pointGoal - participant.totalPoints) / (currentWeekPoints / 7)) : 0
                }
            };
        }
        
        // Funkcja do obsługi komentarzy do aktywności
        async function addCommentToActivity(activityId, authorId, comment) {
            try {
                const commentId = 'comment_' + new Date().getTime();
                
                await db.collection('comments').doc(commentId).set({
                    activityId,
                    authorId,
                    comment,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return true;
            } catch (error) {
                console.error('Błąd podczas dodawania komentarza:', error);
                return false;
            }
        }
        
        async function getActivityComments(activityId) {
            try {
                const commentsSnapshot = await db.collection('comments')
                    .where('activityId', '==', activityId)
                    .orderBy('timestamp')
                    .get();
                
                return commentsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        authorId: data.authorId,
                        comment: data.comment,
                        timestamp: data.timestamp?.toDate() || new Date()
                    };
                });
            } catch (error) {
                console.error('Błąd podczas pobierania komentarzy:', error);
                return [];
            }
        }
        
        // Funkcja wysyłania wirtualnej "piątki"
        async function sendHighFive(fromId, toId, activityId = null) {
            try {
                const highFiveId = 'hf_' + new Date().getTime();
                
                await db.collection('highfives').doc(highFiveId).set({
                    fromId,
                    toId,
                    activityId,
                    seen: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return true;
            } catch (error) {
                console.error('Błąd podczas wysyłania high-five:', error);
                return false;
            }
        }
        
        // Inicjalizacja po załadowaniu strony
        document.addEventListener('DOMContentLoaded', () => {
            initProgressChart();
            loadData();
            updateCountdown();
            
            // Sprawdź przekierowanie OAuth Strava
            handleStravaRedirect();
            
            // Zarejestruj service worker dla PWA
            registerServiceWorker();
            
            // Ustaw okresowe odświeżanie danych
            setupPeriodicRefresh();
            
            // Obsługa baneru PWA
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Pokaż baner instalacyjny
                installBanner.style.display = 'block';
            });
            
            // Aktualizacja odliczania co minutę
            setInterval(updateCountdown, 60000);
            
            // Wykrywanie instalacji PWA
            if (window.matchMedia('(display-mode: standalone)').matches) {
                document.body.classList.add('pwa-installed');
                mobileNav.style.display = 'block';
            }
        });
    </script>
</body>
</html>
